<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Team Task Board</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet" />
<style>
  :root {
    --bg:#f4f2ee;--surface:#fff;--border:#e2ddd8;--border-strong:#c8c2ba;
    --text:#1a1714;--text-muted:#7a736b;--text-light:#a89f96;
    --accent:#c84b2f;--accent-soft:#fdf0ed;--accent2:#2563eb;--accent2-soft:#eff6ff;
    --tag-todo:#e8e5e0;--tag-todo-text:#5a534c;--tag-inprogress:#fef3c7;--tag-inprogress-text:#92400e;
    --tag-review:#e0e7ff;--tag-review-text:#3730a3;--tag-done:#d1fae5;--tag-done-text:#065f46;
    --tag-blocked:#fee2e2;--tag-blocked-text:#991b1b;--tag-high:#fee2e2;--tag-high-text:#991b1b;
    --tag-medium:#fef3c7;--tag-medium-text:#92400e;--tag-low:#d1fae5;--tag-low-text:#065f46;
    --shadow:0 1px 3px rgba(0,0,0,.07),0 1px 2px rgba(0,0,0,.04);
    --shadow-md:0 4px 20px rgba(0,0,0,.12);--radius:10px;
  }
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
  body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-size:14px;}

  /* ‚îÄ Header ‚îÄ */
  .header{background:var(--surface);border-bottom:1px solid var(--border);padding:0 28px;display:flex;align-items:center;justify-content:space-between;height:64px;position:sticky;top:0;z-index:100;gap:12px;}
  .header-left{display:flex;align-items:center;gap:12px;flex-shrink:0;}
  .logo-area{position:relative;width:200px;height:42px;border-radius:10px;overflow:hidden;flex-shrink:0;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;background:#fff;transition:border-color .15s;}
  .logo-area img{width:100%;height:100%;object-fit:contain;display:none;}
  .logo-area img.loaded{display:block;}
  .logo-default{font-size:14px;font-weight:600;color:var(--text-muted);pointer-events:none;}
  .header-title{display:flex;flex-direction:column;gap:2px;}
  .header-title h1{font-size:15px;font-weight:600;letter-spacing:-.2px;line-height:1.2;outline:none;cursor:text;}
  .header-title h1:empty::before{content:'Team Task Board';color:var(--text-light);}
  .week-badge{display:inline-flex;align-items:center;gap:5px;font-size:11px;color:var(--text-muted);font-weight:500;}
  .week-badge .wk-num{font-family:'DM Mono',monospace;font-weight:700;color:var(--accent2);}
  .week-badge .wk-sep{color:var(--border-strong);}
  .week-badge .wk-range{color:var(--text-light);}
  .header-right{display:flex;align-items:center;gap:8px;flex-shrink:0;}

  /* ‚îÄ Toolbar ‚îÄ */
  .toolbar{padding:16px 28px 0;display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
  .toolbar-left{display:flex;gap:10px;flex:1;flex-wrap:wrap;}
  .toolbar-right{display:flex;gap:8px;}
  input[type=text],select{font-family:inherit;font-size:13px;border:1px solid var(--border-strong);border-radius:var(--radius);padding:7px 12px;background:var(--surface);color:var(--text);outline:none;transition:border-color .15s;}
  input[type=text]:focus,select:focus{border-color:var(--accent2);}
  input[type=date]{font-family:inherit;font-size:13px;border:1px solid var(--border-strong);border-radius:var(--radius);padding:7px 12px;background:var(--surface);color:var(--text);outline:none;transition:border-color .15s;width:150px;}
  input[type=date]:focus{border-color:var(--accent2);}
  input[type=date]::-webkit-calendar-picker-indicator{cursor:pointer;opacity:.6;}
  input[type=date]::-webkit-calendar-picker-indicator:hover{opacity:1;}
  .search-wrap{position:relative;}
  .search-wrap input{padding-left:32px;width:210px;}
  .search-icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text-light);pointer-events:none;font-size:13px;}

  /* ‚îÄ Buttons ‚îÄ */
  .btn{font-family:inherit;font-size:13px;font-weight:500;border:none;border-radius:var(--radius);padding:8px 14px;cursor:pointer;transition:all .15s;display:inline-flex;align-items:center;gap:6px;white-space:nowrap;}
  .btn-primary{background:var(--accent);color:#fff;}.btn-primary:hover{background:#b03d24;}
  .btn-secondary{background:var(--surface);color:var(--text);border:1px solid var(--border-strong);}.btn-secondary:hover{background:var(--bg);}
  .btn-blue{background:var(--accent2);color:#fff;}.btn-blue:hover{background:#1d4ed8;}
  .btn-ghost{background:transparent;color:var(--text-muted);padding:8px 10px;}.btn-ghost:hover{background:var(--border);color:var(--text);}
  .btn-danger{background:#fee2e2;color:#991b1b;}.btn-danger:hover{background:#fecaca;}
  .btn-sm{padding:5px 10px;font-size:12px;}.btn-xs{padding:2px 7px;font-size:11px;border-radius:6px;}

  /* ‚îÄ Stats bar ‚îÄ */
  .stats-bar{padding:14px 28px;display:flex;gap:10px;flex-wrap:wrap;}
  .stat-pill{background:var(--surface);border:1px solid var(--border);border-radius:100px;padding:5px 14px;font-size:12px;font-weight:500;display:flex;align-items:center;gap:6px;cursor:pointer;transition:all .15s;}
  .stat-pill:hover,.stat-pill.active{border-color:var(--accent);background:var(--accent-soft);}
  .stat-pill .dot{width:8px;height:8px;border-radius:50%;}
  .stat-pill .count{font-weight:700;font-family:'DM Mono',monospace;}

  /* ‚îÄ Table ‚îÄ */
  .table-wrap{padding:0 28px 40px;overflow-x:auto;}
  table{width:100%;border-collapse:collapse;background:var(--surface);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);border:1px solid var(--border);}
  thead th{background:#faf9f7;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.7px;color:var(--text-muted);padding:10px 14px;text-align:left;border-bottom:1px solid var(--border);white-space:nowrap;user-select:none;cursor:pointer;}
  thead th:hover{color:var(--text);}
  thead th .sort-icon{margin-left:4px;opacity:.4;}
  thead th.sorted .sort-icon{opacity:1;color:var(--accent);}
  thead th.col-custom{background:#f0f4ff;}
  th.add-col-th{background:#faf9f7;color:var(--accent2);font-size:15px;cursor:pointer;}
  th.add-col-th:hover{background:var(--accent2-soft);}
  tbody tr{border-bottom:1px solid var(--border);transition:background .1s;}
  tbody tr:last-child{border-bottom:none;}
  tbody tr:hover{background:#faf9f7;}
  tbody tr.row-done{opacity:.55;}
  tbody tr.row-done td{text-decoration:line-through;text-decoration-color:var(--border-strong);}
  tbody tr.row-done .tag,.row-done .btn,.row-done .dep-chip{text-decoration:none;}
  tbody tr.row-highlighted{background:#fffbeb!important;outline:2px solid #f59e0b;outline-offset:-2px;}
  
  /* ‚îÄ Conditional Formatting ‚îÄ */
  tbody tr.cf-overdue{background:#fee2e2!important;}
  tbody tr.cf-high-priority{background:#fef3c7!important;}
  tbody tr.cf-blocked{background:#fee2e2!important;border-left:4px solid #dc2626!important;}
  tbody tr.cf-almost-done{background:#dcfce7!important;}
  tbody tr.cf-stale{background:#f3f4f6!important;opacity:.7;}
  tbody tr.cf-custom-1{background:#fef3c7!important;border-left:4px solid #f59e0b!important;}
  tbody tr.cf-custom-2{background:#dbeafe!important;border-left:4px solid #3b82f6!important;}
  tbody tr.cf-custom-3{background:#fae8ff!important;border-left:4px solid #c026d3!important;}
  td{padding:11px 14px;vertical-align:middle;font-size:13px;}
  td.task-name{font-weight:500;max-width:220px;}
  td.task-name .task-title{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block;}
  td.task-name .task-desc{font-size:11px;color:var(--text-muted);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block;font-weight:400;}
  td.td-custom{max-width:150px;}
  .inline-edit{font-family:inherit;font-size:12px;border:1px solid transparent;border-radius:6px;padding:3px 6px;width:100%;background:transparent;color:var(--text);outline:none;cursor:text;transition:all .15s;}
  .inline-edit:hover{background:var(--bg);border-color:var(--border);}
  .inline-edit:focus{background:#fff;border-color:var(--accent2);}
  select.inline-edit{cursor:pointer;}

  /* ‚îÄ Tags ‚îÄ */
  .tag{display:inline-flex;align-items:center;font-size:11px;font-weight:600;letter-spacing:.3px;padding:3px 8px;border-radius:6px;white-space:nowrap;}
  .tag-todo{background:var(--tag-todo);color:var(--tag-todo-text);}.tag-inprogress{background:var(--tag-inprogress);color:var(--tag-inprogress-text);}
  .tag-review{background:var(--tag-review);color:var(--tag-review-text);}.tag-done{background:var(--tag-done);color:var(--tag-done-text);}
  .tag-blocked{background:var(--tag-blocked);color:var(--tag-blocked-text);}.tag-high{background:var(--tag-high);color:var(--tag-high-text);}
  .tag-medium{background:var(--tag-medium);color:var(--tag-medium-text);}.tag-low{background:var(--tag-low);color:var(--tag-low-text);}
  .progress-bar{width:76px;height:5px;background:var(--border);border-radius:100px;overflow:hidden;}
  .progress-fill{height:100%;border-radius:100px;background:var(--accent2);transition:width .3s;}
  .due-date{font-family:'DM Mono',monospace;font-size:12px;}.due-overdue{color:var(--accent);font-weight:600;}.due-soon{color:#92400e;}
  .assignee-chip{display:inline-flex;align-items:center;gap:6px;background:var(--bg);border:1px solid var(--border);border-radius:100px;padding:3px 10px 3px 5px;font-size:12px;}
  .assignee-avatar{width:20px;height:20px;border-radius:50%;color:#fff;font-size:9px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
  .actions{display:flex;gap:4px;}
  .no-results{text-align:center;padding:60px 20px;color:var(--text-muted);font-size:14px;}
  .no-results .icon{font-size:32px;margin-bottom:10px;}

  /* ‚îÄ Deps ‚îÄ */
  .dep-chips{display:flex;flex-wrap:wrap;gap:4px;}
  .dep-chip{display:inline-flex;align-items:center;gap:3px;font-size:11px;font-weight:600;font-family:'DM Mono',monospace;padding:3px 8px;border-radius:6px;cursor:pointer;transition:all .15s;white-space:nowrap;border:1px solid transparent;}
  .dep-chip.dep-open{background:#fef3c7;color:#92400e;border-color:#fcd34d;}
  .dep-chip.dep-done{background:#d1fae5;color:#065f46;border-color:#6ee7b7;text-decoration:line-through;opacity:.7;}
  .dep-chip.dep-blocked{background:#fee2e2;color:#991b1b;border-color:#fca5a5;}
  .dep-chip:hover{transform:translateY(-1px);box-shadow:0 2px 6px rgba(0,0,0,.1);}
  /* ‚îÄ 3DEXP link ‚îÄ */
  .dexp-link{color:var(--accent2);font-size:12px;font-family:'DM Mono',monospace;text-decoration:none;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:160px;display:inline-block;vertical-align:middle;border-bottom:1px dashed var(--accent2);}
  .dexp-link:hover{color:#1d4ed8;border-bottom-style:solid;}

  .dep-selector{border:1px solid var(--border-strong);border-radius:8px;background:var(--bg);max-height:150px;overflow-y:auto;padding:6px;display:flex;flex-direction:column;gap:3px;}
  .dep-option{display:flex;align-items:center;gap:8px;padding:5px 8px;border-radius:6px;cursor:pointer;font-size:12px;transition:background .1s;}
  .dep-option:hover{background:var(--surface);}
  .dep-option input[type=checkbox]{accent-color:var(--accent2);width:14px;height:14px;cursor:pointer;flex-shrink:0;}
  .dep-opt-id{font-family:'DM Mono',monospace;font-size:10px;color:var(--text-light);min-width:32px;}
  .dep-opt-title{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

  /* ‚îÄ Modal (shared) ‚îÄ */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(3px);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px;opacity:0;pointer-events:none;transition:opacity .2s;}
  .modal-overlay.open{opacity:1;pointer-events:all;}
  .modal{background:var(--surface);border-radius:16px;width:100%;box-shadow:var(--shadow-md);transform:translateY(12px);transition:transform .2s;max-height:90vh;overflow-y:auto;}
  .modal-overlay.open .modal{transform:translateY(0);}
  .modal-header{padding:22px 24px 0;display:flex;align-items:center;justify-content:space-between;}
  .modal-header h2{font-size:16px;font-weight:600;}
  .modal-body{padding:20px 24px 8px;display:flex;flex-direction:column;gap:14px;}
  .form-row{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
  .form-group{display:flex;flex-direction:column;gap:5px;}
  .form-group.full{grid-column:1/-1;}
  .form-group label{font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;}
  .form-group input,.form-group select,.form-group textarea{font-family:inherit;font-size:13px;border:1px solid var(--border-strong);border-radius:8px;padding:9px 12px;background:var(--bg);color:var(--text);outline:none;transition:border-color .15s;}
  .form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--accent2);background:#fff;}
  .form-group textarea{resize:vertical;min-height:60px;}
  .modal-footer{padding:16px 24px 22px;display:flex;justify-content:flex-end;gap:10px;}

  /* ‚îÄ Chart modal ‚îÄ */
  #chart-modal .modal{max-width:800px;}
  .chart-tabs{display:flex;gap:2px;padding:0 24px;border-bottom:1px solid var(--border);}
  .chart-tab{padding:10px 16px;font-size:13px;font-weight:500;cursor:pointer;border-bottom:2px solid transparent;color:var(--text-muted);transition:all .15s;background:none;border-top:none;border-left:none;border-right:none;font-family:inherit;}
  .chart-tab.active{color:var(--accent2);border-bottom-color:var(--accent2);}
  .chart-tab:hover{color:var(--text);}
  .chart-panel{display:none;padding:20px 24px;}
  .chart-panel.active{display:block;}
  .chart-canvas-wrap{position:relative;}
  canvas.chart{width:100%!important;}
  .person-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:12px;margin-top:16px;}
  .person-card{background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:14px 16px;}
  .person-card-top{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
  .person-card-avatar{width:34px;height:34px;border-radius:50%;color:#fff;font-size:12px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
  .person-card-name{font-weight:600;font-size:13px;}
  .person-card-count{font-size:11px;color:var(--text-muted);}
  .mini-bars{display:flex;flex-direction:column;gap:5px;}
  .mini-bar-row{display:flex;align-items:center;gap:7px;font-size:11px;}
  .mini-bar-label{width:66px;color:var(--text-muted);flex-shrink:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
  .mini-bar-track{flex:1;height:6px;background:var(--border);border-radius:100px;overflow:hidden;}
  .mini-bar-fill{height:100%;border-radius:100px;}
  .mini-bar-num{font-family:'DM Mono',monospace;font-weight:600;font-size:10px;color:var(--text-muted);min-width:14px;text-align:right;}

  /* ‚îÄ Add Column modal ‚îÄ */
  #addcol-modal .modal{max-width:460px;}
  .col-type-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
  .col-type-btn{padding:11px 13px;border:2px solid var(--border);border-radius:10px;background:var(--bg);cursor:pointer;text-align:left;transition:all .15s;font-family:inherit;}
  .col-type-btn:hover{border-color:var(--accent2);background:var(--accent2-soft);}
  .col-type-btn.selected{border-color:var(--accent2);background:var(--accent2-soft);}
  .col-type-icon{font-size:17px;margin-bottom:3px;}
  .col-type-name{font-size:12px;font-weight:600;}
  .col-type-desc{font-size:11px;color:var(--text-muted);margin-top:1px;}
  
  /* ‚îÄ Conditional Formatting modal ‚îÄ */
  #cf-modal .modal{max-width:700px;}
  .cf-rules-list{display:flex;flex-direction:column;gap:10px;margin-bottom:16px;max-height:400px;overflow-y:auto;}
  .cf-rule-item{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:14px;display:flex;flex-direction:column;gap:10px;}
  .cf-rule-header{display:flex;align-items:center;gap:10px;}
  .cf-rule-toggle{position:relative;width:40px;height:22px;background:var(--border);border-radius:100px;cursor:pointer;transition:background .2s;flex-shrink:0;}
  .cf-rule-toggle.active{background:var(--accent2);}
  .cf-rule-toggle-knob{position:absolute;top:3px;left:3px;width:16px;height:16px;background:#fff;border-radius:50%;transition:left .2s;box-shadow:0 1px 3px rgba(0,0,0,.2);}
  .cf-rule-toggle.active .cf-rule-toggle-knob{left:21px;}
  .cf-rule-name{flex:1;font-weight:600;font-size:13px;}
  .cf-rule-preview{width:30px;height:30px;border-radius:6px;border:1px solid var(--border);flex-shrink:0;}
  .cf-rule-condition{display:grid;grid-template-columns:130px 110px 1fr;gap:8px;align-items:center;}
  .cf-rule-condition select,.cf-rule-condition input{font-size:12px;padding:6px 10px;}
  .cf-add-rule{border:2px dashed var(--border-strong);background:transparent;color:var(--text-muted);padding:14px;border-radius:10px;cursor:pointer;text-align:center;font-weight:500;transition:all .15s;}
  .cf-add-rule:hover{border-color:var(--accent2);color:var(--accent2);background:var(--accent2-soft);}
  .cf-preset-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;margin-top:16px;}
  .cf-preset-btn{padding:12px;border:2px solid var(--border);border-radius:10px;background:var(--bg);cursor:pointer;text-align:left;transition:all .15s;font-size:12px;}
  .cf-preset-btn:hover{border-color:var(--accent2);background:var(--accent2-soft);}
  .cf-preset-name{font-weight:600;margin-bottom:3px;}
  .cf-preset-desc{font-size:11px;color:var(--text-muted);}
  .custom-cols-list{display:flex;flex-direction:column;gap:5px;max-height:170px;overflow-y:auto;}
  .custom-col-item{display:flex;align-items:center;gap:8px;padding:7px 10px;background:var(--bg);border-radius:8px;font-size:13px;}
  .custom-col-item .col-icon{font-size:14px;}
  .custom-col-item .col-name{flex:1;font-weight:500;}
  .custom-col-item .col-type-tag{font-size:10px;color:var(--text-muted);font-family:'DM Mono',monospace;background:var(--border);padding:2px 6px;border-radius:4px;}

  /* ‚îÄ Hint banner ‚îÄ */
  .export-hint{margin:0 28px 14px;background:var(--accent2-soft);border:1px solid #bfdbfe;border-radius:var(--radius);padding:9px 14px;font-size:12px;color:#1e40af;display:flex;align-items:center;gap:8px;}
  .export-hint strong{font-weight:600;}

  /* ‚îÄ Tabs ‚îÄ */
  .tabs{display:flex;gap:4px;padding:0 28px;border-bottom:2px solid var(--border);background:var(--surface);position:sticky;top:64px;z-index:99;}
  .tab{padding:12px 20px;background:transparent;border:none;font-family:inherit;font-size:14px;font-weight:500;color:var(--text-muted);cursor:pointer;border-radius:0;transition:all .15s;position:relative;}
  .tab:hover{background:var(--bg);color:var(--text);}
  .tab.active{background:transparent;color:var(--accent2);font-weight:600;}
  .tab.active::after{content:'';position:absolute;bottom:-2px;left:0;right:0;height:2px;background:var(--accent2);}
  .tab-content{display:none;}
  .tab-content.active{display:block;}

  @media(max-width:700px){
    .header,.toolbar,.stats-bar,.table-wrap,.export-hint{padding-left:14px;padding-right:14px;}
    .form-row{grid-template-columns:1fr;}
    .header-right .btn-sm:not(.btn-primary){display:none;}
  }

  /* ‚îÄ Working Hours ‚îÄ */
  .wh-wrap{padding:20px 28px 40px;}
  .wh-inner-tabs{display:flex;gap:2px;border-bottom:2px solid var(--border);margin-bottom:24px;}
  .wh-inner-tab{padding:10px 20px;background:transparent;border:none;font-family:inherit;font-size:13px;font-weight:500;color:var(--text-muted);cursor:pointer;position:relative;transition:all .15s;}
  .wh-inner-tab:hover{color:var(--text);}
  .wh-inner-tab.active{color:var(--accent2);font-weight:600;}
  .wh-inner-tab.active::after{content:'';position:absolute;bottom:-2px;left:0;right:0;height:2px;background:var(--accent2);}
  .wh-inner-panel{display:none;}
  .wh-inner-panel.active{display:block;}

  /* Week Navigation */
  .wh-week-nav{display:flex;align-items:center;gap:14px;margin-bottom:20px;flex-wrap:wrap;}
  .wh-week-label{font-size:15px;font-weight:600;color:var(--text);min-width:220px;}
  .wh-week-sub{font-size:12px;color:var(--text-muted);font-weight:400;}

  /* Hours Entry Grid */
  .wh-table{width:100%;border-collapse:collapse;background:var(--surface);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);border:1px solid var(--border);}
  .wh-table thead th{background:#faf9f7;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.6px;color:var(--text-muted);padding:10px 12px;text-align:left;border-bottom:1px solid var(--border);white-space:nowrap;}
  .wh-table thead th.day-col{text-align:center;min-width:70px;}
  .wh-table thead th.total-col{text-align:center;min-width:70px;background:#f0f4ff;color:var(--accent2);}
  .wh-table tbody tr{border-bottom:1px solid var(--border);transition:background .1s;}
  .wh-table tbody tr:last-child{border-bottom:none;}
  .wh-table tbody tr:hover{background:#faf9f7;}
  .wh-table tbody tr.wh-total-row{background:#f0f4ff;font-weight:700;border-top:2px solid var(--border);}
  .wh-table td{padding:10px 12px;font-size:13px;vertical-align:middle;}
  .wh-table td.day-td{text-align:center;}
  .wh-table td.total-td{text-align:center;font-family:'DM Mono',monospace;font-weight:700;color:var(--accent2);background:#f0f4ff;}
  .wh-hours-input{width:60px;text-align:center;font-family:'DM Mono',monospace;font-size:13px;border:1px solid transparent;border-radius:6px;padding:4px 6px;background:transparent;color:var(--text);outline:none;transition:all .15s;}
  .wh-hours-input:hover{background:var(--bg);border-color:var(--border);}
  .wh-hours-input:focus{background:#fff;border-color:var(--accent2);}
  .wh-hours-input::-webkit-inner-spin-button,.wh-hours-input::-webkit-outer-spin-button{opacity:.4;}
  .wh-project-name{font-weight:500;max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .wh-exp-badge{display:inline-block;font-size:10px;font-family:'DM Mono',monospace;background:var(--accent2-soft);color:var(--accent2);border:1px solid #bfdbfe;border-radius:4px;padding:2px 6px;white-space:nowrap;max-width:130px;overflow:hidden;text-overflow:ellipsis;}
  .wh-task-title{font-size:11px;color:var(--text-muted);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:200px;}
  .wh-weekend{background:#faf7f4!important;color:var(--text-light);}
  .wh-day-header{display:flex;flex-direction:column;align-items:center;gap:1px;}
  .wh-day-name{font-size:10px;letter-spacing:.5px;}
  .wh-day-date{font-size:11px;font-weight:700;color:var(--text);}
  .wh-day-today .wh-day-date{color:var(--accent2);background:var(--accent2-soft);border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;}

  /* Submit Hours Tab */
  .wh-weeks-list{display:flex;flex-direction:column;gap:10px;margin-bottom:24px;}
  .wh-week-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px 20px;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:16px;}
  .wh-week-card:hover{border-color:var(--accent2);box-shadow:0 2px 10px rgba(37,99,235,.1);}
  .wh-week-card.selected{border-color:var(--accent2);background:var(--accent2-soft);}
  .wh-week-card-info{flex:1;}
  .wh-week-card-label{font-weight:600;font-size:14px;}
  .wh-week-card-range{font-size:12px;color:var(--text-muted);}
  .wh-week-card-total{font-family:'DM Mono',monospace;font-size:16px;font-weight:700;color:var(--accent2);}
  .wh-submitted-badge{display:inline-flex;align-items:center;gap:5px;font-size:11px;font-weight:600;padding:4px 10px;border-radius:100px;}
  .wh-submitted-badge.done{background:#d1fae5;color:#065f46;}
  .wh-submitted-badge.pending{background:#fef3c7;color:#92400e;}

  /* Week detail report */
  .wh-report-wrap{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:24px;}
  .wh-report-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px;}
  .wh-report-title{font-size:16px;font-weight:600;}
  .wh-duration-bar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
  .wh-duration-bar label{font-size:12px;font-weight:600;color:var(--text-muted);}
  .wh-report-project-row{display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg);border-radius:8px;margin-bottom:8px;}
  .wh-report-bar-track{flex:1;height:8px;background:var(--border);border-radius:100px;overflow:hidden;}
  .wh-report-bar-fill{height:100%;border-radius:100px;background:var(--accent2);}
  .wh-no-data{text-align:center;padding:40px;color:var(--text-muted);font-size:13px;}

  /* ‚îÄ Samples Tab ‚îÄ */
  .sl-wrap{padding:20px 28px 60px;}
  .sl-toolbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:20px;}
  .sl-toolbar-left{display:flex;gap:10px;flex:1;flex-wrap:wrap;align-items:center;}
  .sl-toolbar-right{display:flex;gap:8px;}

  /* Lot cards grid */
  .sl-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:16px;margin-bottom:32px;}
  .sl-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden;box-shadow:var(--shadow);transition:box-shadow .15s,border-color .15s;cursor:pointer;}
  .sl-card:hover{box-shadow:var(--shadow-md);border-color:var(--border-strong);}
  .sl-card-header{padding:14px 18px 10px;display:flex;align-items:flex-start;gap:10px;border-bottom:1px solid var(--border);}
  .sl-lot-icon{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
  .sl-card-meta{flex:1;min-width:0;}
  .sl-lot-num{font-family:'DM Mono',monospace;font-size:11px;font-weight:700;color:var(--accent2);letter-spacing:.5px;margin-bottom:2px;}
  .sl-lot-title{font-weight:600;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .sl-lot-phase{font-size:11px;color:var(--text-muted);margin-top:2px;}
  .sl-card-body{padding:12px 18px;}
  .sl-row{display:flex;align-items:center;gap:6px;margin-bottom:6px;font-size:12px;}
  .sl-row:last-child{margin-bottom:0;}
  .sl-label{color:var(--text-muted);font-weight:500;min-width:90px;flex-shrink:0;}
  .sl-val{color:var(--text);font-weight:500;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .sl-card-footer{padding:10px 18px;background:var(--bg);border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:8px;}
  .sl-teams-wrap{display:flex;flex-wrap:wrap;gap:4px;flex:1;}
  .sl-team-chip{display:inline-flex;align-items:center;gap:3px;font-size:10px;font-weight:600;padding:2px 7px;border-radius:100px;background:#e0e7ff;color:#3730a3;}
  .sl-team-chip.received{background:#d1fae5;color:#065f46;}
  .sl-card-actions{display:flex;gap:4px;flex-shrink:0;}

  /* Status badges */
  .sl-status{display:inline-flex;align-items:center;gap:4px;font-size:11px;font-weight:600;padding:3px 9px;border-radius:6px;white-space:nowrap;}
  .sl-status-pending{background:#fef3c7;color:#92400e;}
  .sl-status-partial{background:#e0e7ff;color:#3730a3;}
  .sl-status-delivered{background:#d1fae5;color:#065f46;}
  .sl-status-overdue{background:#fee2e2;color:#991b1b;}

  /* Table view */
  .sl-table-wrap{overflow-x:auto;}
  .sl-table{width:100%;border-collapse:collapse;background:var(--surface);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);border:1px solid var(--border);}
  .sl-table thead th{background:#faf9f7;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.6px;color:var(--text-muted);padding:10px 12px;text-align:left;border-bottom:1px solid var(--border);white-space:nowrap;cursor:pointer;user-select:none;}
  .sl-table thead th:hover{color:var(--text);}
  .sl-table thead th.sorted{color:var(--accent2);}
  .sl-table tbody tr{border-bottom:1px solid var(--border);transition:background .1s;}
  .sl-table tbody tr:last-child{border-bottom:none;}
  .sl-table tbody tr:hover{background:#faf9f7;}
  .sl-table td{padding:10px 12px;font-size:12px;vertical-align:middle;}

  /* Lot modal */
  #sl-modal .modal{max-width:680px;}
  .sl-section-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--text-muted);margin:16px 0 10px;padding-bottom:6px;border-bottom:1px solid var(--border);}
  .sl-section-title:first-child{margin-top:0;}
  .sl-form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
  .sl-form-grid .full{grid-column:1/-1;}

  /* Team receipt tracker inside modal */
  .sl-receipt-list{display:flex;flex-direction:column;gap:8px;}
  .sl-receipt-row{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg);border-radius:8px;border:1px solid var(--border);}
  .sl-receipt-team{font-weight:600;font-size:13px;flex:1;}
  .sl-receipt-date-wrap{display:flex;align-items:center;gap:6px;}
  .sl-receipt-date-wrap label{font-size:11px;color:var(--text-muted);}
  .sl-receipt-date-wrap input[type=date]{width:140px;font-size:12px;padding:5px 8px;}
  .sl-receipt-check{accent-color:var(--accent2);width:16px;height:16px;cursor:pointer;flex-shrink:0;}
  .sl-add-team-wrap{display:flex;gap:8px;margin-top:8px;}
  .sl-add-team-wrap input{flex:1;}

  /* Stats strip */
  .sl-stats{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px;}
  .sl-stat{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:12px 18px;display:flex;align-items:center;gap:10px;}
  .sl-stat-icon{font-size:20px;}
  .sl-stat-val{font-size:22px;font-weight:700;font-family:'DM Mono',monospace;color:var(--accent2);}
  .sl-stat-label{font-size:11px;color:var(--text-muted);font-weight:500;}

  /* View toggle */
  .sl-view-btn{padding:7px 10px;border:1px solid var(--border-strong);background:var(--surface);border-radius:8px;cursor:pointer;font-size:14px;transition:all .15s;}
  .sl-view-btn.active{background:var(--accent2);color:#fff;border-color:var(--accent2);}

  /* ‚îÄ Tools Tab ‚îÄ */
  .tools-wrap{padding:24px 28px 60px;display:flex;flex-direction:column;gap:28px;}
  .tools-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:24px;align-items:start;}
  .tool-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden;box-shadow:var(--shadow);}
  .tool-card-header{display:flex;align-items:center;gap:10px;padding:16px 20px 12px;border-bottom:1px solid var(--border);background:#fafaf8;}
  .tool-card-icon{font-size:22px;flex-shrink:0;}
  .tool-card-title{font-size:14px;font-weight:700;color:var(--text);}
  .tool-card-sub{font-size:11px;color:var(--text-muted);}
  .tool-card-body{padding:18px 20px;}
  /* Calculator */
  .calc-display{background:#1a1714;border-radius:10px;padding:12px 16px;margin-bottom:12px;text-align:right;}
  .calc-expr{font-family:'DM Mono',monospace;font-size:11px;color:#7a736b;min-height:16px;word-break:break-all;}
  .calc-result{font-family:'DM Mono',monospace;font-size:26px;font-weight:600;color:#fff;min-height:34px;word-break:break-all;}
  .calc-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:5px;}
  .calc-btn{font-family:'DM Mono',monospace;font-size:12px;font-weight:600;border:none;border-radius:8px;padding:10px 4px;cursor:pointer;transition:all .12s;background:var(--bg);color:var(--text);}
  .calc-btn:hover{filter:brightness(.93);}
  .calc-btn:active{transform:scale(.94);}
  .calc-btn.op{background:#fef3c7;color:#92400e;}
  .calc-btn.fn{background:#ede9fe;color:#5b21b6;font-size:10px;}
  .calc-btn.eq{background:var(--accent2);color:#fff;grid-column:span 2;}
  .calc-btn.clr{background:#fee2e2;color:#991b1b;}
  .calc-btn.num{background:#f4f2ee;}
  .calc-btn.zero{grid-column:span 2;}
  .calc-history{max-height:100px;overflow-y:auto;margin-top:10px;background:var(--bg);border-radius:8px;padding:6px 10px;}
  .calc-hist-item{font-family:'DM Mono',monospace;font-size:11px;color:var(--text-muted);padding:2px 0;cursor:pointer;border-bottom:1px solid var(--border);}
  .calc-hist-item:last-child{border:none;}
  .calc-hist-item:hover{color:var(--text);}
  /* Unit Converter */
  .uc-tabs{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:14px;}
  .uc-tab{padding:5px 11px;font-size:11px;font-weight:600;border:1px solid var(--border);border-radius:20px;cursor:pointer;background:var(--bg);color:var(--text-muted);transition:all .12s;}
  .uc-tab.active{background:var(--accent2);color:#fff;border-color:var(--accent2);}
  .uc-row{display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center;margin-bottom:10px;}
  .uc-val{font-family:'DM Mono',monospace;font-size:14px;border:1.5px solid var(--border-strong);border-radius:8px;padding:9px 12px;background:var(--bg);color:var(--text);outline:none;width:100%;transition:border-color .15s;}
  .uc-val:focus{border-color:var(--accent2);background:#fff;}
  .uc-arrow{color:var(--accent2);font-size:18px;font-weight:700;text-align:center;}
  .uc-select{font-family:inherit;font-size:12px;border:1.5px solid var(--border-strong);border-radius:8px;padding:9px 10px;background:var(--bg);color:var(--text);outline:none;width:100%;}
  .uc-result-box{background:var(--accent2-soft);border:1px solid #bfdbfe;border-radius:8px;padding:10px 14px;text-align:center;margin-top:6px;}
  .uc-result-val{font-family:'DM Mono',monospace;font-size:20px;font-weight:700;color:var(--accent2);}
  .uc-result-label{font-size:11px;color:var(--text-muted);margin-top:2px;}
  /* Date Calc */
  .dc-section{margin-bottom:14px;}
  .dc-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);margin-bottom:7px;}
  .dc-result{font-family:'DM Mono',monospace;font-size:15px;font-weight:700;color:var(--accent2);background:var(--accent2-soft);border-radius:8px;padding:8px 12px;margin-top:6px;}
  /* Currency */
  .fx-rate-row{display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap;}
  .fx-rate-label{font-size:12px;color:var(--text-muted);}
  .fx-rate-input{font-family:'DM Mono',monospace;font-size:13px;border:1.5px solid var(--border-strong);border-radius:8px;padding:7px 10px;width:100px;background:var(--bg);color:var(--text);outline:none;}
  .fx-pair{display:flex;gap:8px;align-items:center;margin-bottom:8px;}
  .fx-pair label{font-size:11px;color:var(--text-muted);min-width:60px;}
  /* Percentage */
  .pct-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
  .pct-inp{font-family:'DM Mono',monospace;font-size:13px;border:1.5px solid var(--border-strong);border-radius:8px;padding:8px 10px;width:100%;background:var(--bg);color:var(--text);outline:none;}
  .pct-result{font-family:'DM Mono',monospace;font-size:16px;font-weight:700;color:var(--accent);background:var(--accent-soft);border-radius:8px;padding:8px 12px;margin-top:8px;text-align:center;}
  /* Day pills */
  .dc-day-pill{display:inline-flex;align-items:center;gap:5px;font-size:12px;font-weight:600;padding:5px 11px;border-radius:20px;border:1.5px solid var(--border-strong);background:var(--bg);cursor:pointer;transition:all .12s;user-select:none;}
  .dc-day-pill input{accent-color:var(--accent2);width:14px;height:14px;cursor:pointer;}
  .dc-day-pill:has(input:checked){background:var(--accent2);color:#fff;border-color:var(--accent2);}
  /* Materials table */
  .mat-td{padding:8px 12px;border-bottom:1px solid var(--border);vertical-align:middle;}
  .mat-td-num{font-family:'DM Mono',monospace;font-size:12px;text-align:right;}
  .mat-row:hover td{background:#f8f9fa;}
  .mat-row:nth-child(even) td{background:#fafaf8;}
  .mat-mat-name{font-weight:600;font-size:13px;}
  .mat-sub{font-size:10px;color:var(--text-muted);}

  /* ‚îÄ‚îÄ Verification Tab ‚îÄ‚îÄ */
  .vf-wrap{padding:24px 28px 60px;}
  .vf-inner-tabs{display:flex;gap:6px;margin-bottom:20px;flex-wrap:wrap;}
  .vf-inner-tab{padding:8px 18px;font-size:13px;font-weight:600;border:1.5px solid var(--border-strong);border-radius:8px;cursor:pointer;background:var(--surface);color:var(--text-muted);transition:all .15s;}
  .vf-inner-tab.active{background:var(--accent2);color:#fff;border-color:var(--accent2);}
  .vf-panel{display:none;} .vf-panel.active{display:block;}
  .vf-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(360px,1fr));gap:16px;}
  .vf-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;box-shadow:var(--shadow);transition:box-shadow .15s;}
  .vf-card:hover{box-shadow:0 4px 20px rgba(0,0,0,.1);}
  .vf-card-header{padding:12px 16px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border);}
  .vf-card-body{padding:12px 16px;display:flex;flex-direction:column;gap:7px;}
  .vf-card-footer{padding:10px 16px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:#fafaf8;}
  .vf-type-badge{font-size:10px;font-weight:700;padding:3px 9px;border-radius:20px;text-transform:uppercase;letter-spacing:.4px;}
  .vf-type-safety{background:#fee2e2;color:#991b1b;}
  .vf-type-performance{background:#dbeafe;color:#1e40af;}
  .vf-type-motoraging{background:#fef3c7;color:#92400e;}
  .vf-type-inproduct{background:#dcfce7;color:#166534;}
  .vf-status-badge{font-size:10px;font-weight:700;padding:3px 9px;border-radius:20px;}
  .vf-s-planned{background:#f1f5f9;color:#475569;}
  .vf-s-ongoing{background:#dbeafe;color:#1e40af;}
  .vf-s-done{background:#dcfce7;color:#166534;}
  .vf-s-blocked{background:#fee2e2;color:#991b1b;}
  .vf-s-cancelled{background:#f3f4f6;color:#9ca3af;}
  .vf-row{display:flex;align-items:baseline;gap:6px;font-size:12px;}
  .vf-label{color:var(--text-muted);font-size:11px;min-width:90px;flex-shrink:0;}
  .vf-val{color:var(--text);font-weight:500;}
  .vf-reminder{background:#fef3c7;border:1px solid #fde68a;border-radius:6px;padding:5px 10px;font-size:11px;color:#92400e;}
  .vf-stats{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px;}
  .vf-stat{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:10px 16px;display:flex;align-items:center;gap:8px;}
  .vf-stat-val{font-size:20px;font-weight:700;font-family:'DM Mono',monospace;color:var(--accent2);}
  .vf-stat-label{font-size:10px;color:var(--text-muted);font-weight:500;}
  .vf-bearer-motor{color:#f97316;font-weight:700;}
  .vf-bearer-others{color:#8b5cf6;font-weight:700;}
  .vf-overdue{border-left:3px solid #ef4444;}
  .vf-reminder-badge{background:#ef4444;color:#fff;border-radius:50%;width:16px;height:16px;font-size:9px;font-weight:700;display:inline-flex;align-items:center;justify-content:center;margin-left:4px;}
  /* sl cost bearer toggle */
  .cost-bearer-toggle{display:flex;gap:6px;}
  .cost-bearer-btn{padding:7px 18px;font-size:12px;font-weight:700;border:1.5px solid var(--border-strong);border-radius:8px;cursor:pointer;background:var(--bg);color:var(--text-muted);transition:all .12s;}
  .cost-bearer-btn.active-motor{background:#fff7ed;color:#c2410c;border-color:#fb923c;}
  .cost-bearer-btn.active-others{background:#f5f3ff;color:#6d28d9;border-color:#a78bfa;}
</style>
</head>
<body>

<!-- ‚ïê‚ïê HEADER ‚ïê‚ïê -->
<header class="header">
  <div class="header-left">
    <div class="logo-area" title="Company logo">
      <img id="logo-img" src="ELARABY.LOGO" alt="Logo" onerror="this.style.display='none';document.getElementById('logo-default').style.display='block';" onload="this.classList.add('loaded');" />
      <span class="logo-default" id="logo-default" style="display:none;">ELARABY</span>
    </div>
    <div class="header-title">
      <h1 id="board-title" contenteditable="true" spellcheck="false" title="Click to rename">Team Task Board</h1>
      <div class="week-badge" id="week-badge"></div>
    </div>
  </div>
  <div class="header-right">
    <button class="btn btn-ghost btn-sm" onclick="openInfoModal()" title="About data storage">‚ÑπÔ∏è Info</button>
    <button class="btn btn-blue btn-sm" onclick="openChartModal()">üìä Team Stats</button>
    <button class="btn btn-secondary btn-sm" onclick="openCFModal()">üé® Formatting</button>
    <button class="btn btn-secondary btn-sm" onclick="openAddColModal()">Ôºã Column</button>
    <button class="btn btn-secondary btn-sm" onclick="exportJSON()">‚¨á Export JSON</button>
    <button class="btn btn-secondary btn-sm" onclick="exportAllExcel()" title="Export everything to a multi-sheet Excel file">üìä Export Excel</button>
    <button class="btn btn-secondary btn-sm" onclick="importJSON()">‚¨Ü Import JSON</button>
    <input type="file" id="json-input" accept=".json" style="display:none" onchange="handleJSONImport(event)" />
    <button class="btn btn-primary" onclick="openModal()">+ Add Task</button>
  </div>
</header>

<!-- ‚ïê‚ïê TABS ‚ïê‚ïê -->
<div class="tabs">
  <button class="tab active" onclick="switchMainTab('tasks')">‚úì Tasks</button>
  <button class="tab" onclick="switchMainTab('projects')">üìÅ Projects</button>
  <button class="tab" onclick="switchMainTab('statistics')">üìä Statistics</button>
  <button class="tab" onclick="switchMainTab('workinghours')">‚è± Working Hours</button>
  <button class="tab" onclick="switchMainTab('samples')">üß™ Samples</button>
  <button class="tab" id="tab-verification" onclick="switchMainTab('verification')">üî¨ Verification</button>
  <button class="tab" onclick="switchMainTab('tools')">üõ† Tools</button>
</div>

<!-- ‚ïê‚ïê TASKS TAB ‚ïê‚ïê -->
<div id="tasks-tab" class="tab-content active">

<!-- ‚ïê‚ïê TOOLBAR ‚ïê‚ïê -->
<div class="toolbar">
  <div class="toolbar-left">
    <div class="search-wrap">
      <span class="search-icon">üîç</span>
      <input type="text" id="search" placeholder="Search tasks‚Ä¶" oninput="renderTable()" />
    </div>
    <select id="filter-status" onchange="renderTable()">
      <option value="">All Statuses</option>
      <option>To Do</option><option>In Progress</option><option>In Review</option><option>Done</option><option>Blocked</option>
    </select>
    <select id="filter-priority" onchange="renderTable()">
      <option value="">All Priorities</option>
      <option>High</option><option>Medium</option><option>Low</option>
    </select>
    <select id="filter-assignee" onchange="renderTable()"><option value="">All Assignees</option></select>
    <select id="filter-project" onchange="renderTable()"><option value="">All Projects</option></select>
    <input type="date" id="filter-date-from" onchange="renderTable()" placeholder="From date" title="Due date from" />
    <input type="date" id="filter-date-to" onchange="renderTable()" placeholder="To date" title="Due date to" />
  </div>
  <div class="toolbar-right">
    <button class="btn btn-secondary btn-sm" onclick="showLastWeekModified()">üìù Last Week Modified</button>
    <button class="btn btn-secondary btn-sm" onclick="syncToGitHub()">‚òÅÔ∏è Sync to GitHub</button>
    <button class="btn btn-secondary btn-sm" onclick="loadFromGitHub()">üì• Load from GitHub</button>
    <button class="btn btn-secondary btn-sm" onclick="importFromFile()">üìÅ Import File</button>
    <button class="btn btn-ghost btn-sm" onclick="openGitHubSettings()">‚öôÔ∏è</button>
    <button class="btn btn-primary" onclick="openModal()">+ New Task</button>
    <button class="btn btn-ghost btn-sm" onclick="clearFilters()">‚úï Clear filters</button>
  </div>
</div>

<!-- ‚ïê‚ïê STATS BAR ‚ïê‚ïê -->
<div class="stats-bar" id="stats-bar"></div>

<!-- ‚ïê‚ïê HINT ‚ïê‚ïê -->
<div class="export-hint">
  üí° <span><strong>Data Persistence:</strong> All edits auto-save to your <strong>browser's local storage</strong> on THIS device only. Data does NOT sync across devices. To share or backup: <strong>Export JSON</strong> ‚Üí save to OneDrive/SharePoint ‚Üí <strong>Import JSON</strong> on other devices (preserves all tasks, columns, formatting, and logo). Place <strong>ELARABY.LOGO</strong> file (4002√ó650px) in same folder for automatic logo loading.</span>
</div>

<!-- ‚ïê‚ïê TABLE ‚ïê‚ïê -->
<div class="table-wrap">
  <table>
    <thead>
      <tr id="table-head-row">
        <th onclick="sortBy('id')">#<span class="sort-icon" id="sort-id">‚Üï</span></th>
        <th onclick="sortBy('title')">Task<span class="sort-icon" id="sort-title">‚Üï</span></th>
        <th onclick="sortBy('project')">Project<span class="sort-icon" id="sort-project">‚Üï</span></th>
        <th onclick="sortBy('assignee')">Assignee<span class="sort-icon" id="sort-assignee">‚Üï</span></th>
        <th onclick="sortBy('status')">Status<span class="sort-icon" id="sort-status">‚Üï</span></th>
        <th onclick="sortBy('priority')">Priority<span class="sort-icon" id="sort-priority">‚Üï</span></th>
        <th onclick="sortBy('dueDate')">Due Date<span class="sort-icon" id="sort-dueDate">‚Üï</span></th>
        <th>Progress</th>
        <th>Depends On</th>
        <th onclick="sortBy('task3DEXP')">Task on 3DEXP<span class="sort-icon" id="sort-task3DEXP">‚Üï</span></th>
        <th onclick="sortBy('projectType')">Project Type<span class="sort-icon" id="sort-projectType">‚Üï</span></th>
        <th onclick="sortBy('product')">Product<span class="sort-icon" id="sort-product">‚Üï</span></th>
        <th onclick="sortBy('projectPhase')">Project Phase<span class="sort-icon" id="sort-projectPhase">‚Üï</span></th>
        <!-- custom cols go here, before + -->
        <th class="add-col-th" onclick="openAddColModal()" title="Add column">Ôºã</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="task-tbody"></tbody>
  </table>
</div>

</div><!-- END TASKS TAB -->

<!-- ‚ïê‚ïê PROJECTS TAB ‚ïê‚ïê -->
<div id="projects-tab" class="tab-content">
  <div class="toolbar">
    <div class="toolbar-left">
      <div class="search-wrap">
        <span class="search-icon">üîç</span>
        <input type="text" id="project-search" placeholder="Search projects‚Ä¶" oninput="renderProjectsTable()" />
      </div>
      <select id="filter-project-stage" onchange="renderProjectsTable()">
        <option value="">All Stages</option>
        <option>Planning</option><option>Execution</option><option>Testing</option><option>Deployment</option><option>Maintenance</option>
      </select>
      <select id="filter-project-priority" onchange="renderProjectsTable()">
        <option value="">All Priorities</option>
        <option>High</option><option>Medium</option><option>Low</option>
      </select>
    </div>
    <div class="toolbar-right">
      <button class="btn btn-primary" onclick="openProjectModal()">+ New Project</button>
      <button class="btn btn-ghost btn-sm" onclick="clearProjectFilters()">‚úï Clear filters</button>
    </div>
  </div>

  <div class="table-wrap" style="padding-top:20px">
    <table>
      <thead>
        <tr>
          <th onclick="sortProjectsBy('name')">Project Name<span class="sort-icon" id="psort-name">‚Üï</span></th>
          <th>Total Tasks</th>
          <th>To Do</th>
          <th>In Progress</th>
          <th>Review</th>
          <th>Done</th>
          <th>Blocked</th>
          <th>Completion %</th>
          <th onclick="sortProjectsBy('startDate')">Start Date<span class="sort-icon" id="psort-startDate">‚Üï</span></th>
          <th onclick="sortProjectsBy('endDate')">End Date<span class="sort-icon" id="psort-endDate">‚Üï</span></th>
          <th>Objectives</th>
          <th>KPIs</th>
          <th onclick="sortProjectsBy('pic')">PIC<span class="sort-icon" id="psort-pic">‚Üï</span></th>
          <th onclick="sortProjectsBy('project3DEXP')">Project on 3DEXP<span class="sort-icon" id="psort-project3DEXP">‚Üï</span></th>
          <th onclick="sortProjectsBy('stage')">Stage<span class="sort-icon" id="psort-stage">‚Üï</span></th>
          <th onclick="sortProjectsBy('type')">Type<span class="sort-icon" id="psort-type">‚Üï</span></th>
          <th onclick="sortProjectsBy('platform')">Platform<span class="sort-icon" id="psort-platform">‚Üï</span></th>
          <th onclick="sortProjectsBy('priority')">Priority<span class="sort-icon" id="psort-priority">‚Üï</span></th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="projects-tbody">
        <tr><td colspan="12" style="text-align:center;padding:60px;color:var(--text-muted)">No projects yet. Click <strong>+ New Project</strong> to create one.</td></tr>
      </tbody>
    </table>
  </div>
</div><!-- END PROJECTS TAB -->

<!-- ‚ïê‚ïê STATISTICS TAB ‚ïê‚ïê -->
<div id="statistics-tab" class="tab-content">
  <div style="padding:20px 28px">
    <h2 style="font-size:20px;font-weight:600;margin-bottom:20px">üìä Project & Task Statistics</h2>
    
    <!-- Overall Summary -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:30px">
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px">
        <div style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Total Projects</div>
        <div style="font-size:32px;font-weight:700;color:var(--accent2)" id="stat-total-projects">0</div>
      </div>
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px">
        <div style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Total Tasks</div>
        <div style="font-size:32px;font-weight:700;color:var(--accent2)" id="stat-total-tasks">0</div>
      </div>
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px">
        <div style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Overall Completion</div>
        <div style="font-size:32px;font-weight:700;color:#10b981" id="stat-overall-completion">0%</div>
      </div>
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px">
        <div style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Active Tasks</div>
        <div style="font-size:32px;font-weight:700;color:#f59e0b" id="stat-active-tasks">0</div>
      </div>
    </div>

    <!-- Project Performance -->
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:24px;margin-bottom:20px">
      <h3 style="font-size:16px;font-weight:600;margin-bottom:16px">üéØ Project Performance</h3>
      <div id="project-performance-list"></div>
    </div>

    <!-- Task Status Breakdown -->
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:24px;margin-bottom:20px">
      <h3 style="font-size:16px;font-weight:600;margin-bottom:16px">üìã Task Status Distribution</h3>
      <div id="status-breakdown" style="display:flex;gap:20px;flex-wrap:wrap"></div>
    </div>

    <!-- Recommendations -->
    <div style="background:var(--accent2-soft);border:1px solid #bfdbfe;border-radius:var(--radius);padding:24px;margin-bottom:20px">
      <h3 style="font-size:16px;font-weight:600;margin-bottom:16px;color:#1e40af">üí° Insights & Recommendations</h3>
      <div id="recommendations-list"></div>
    </div>

    <!-- Team Workload -->
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:24px">
      <h3 style="font-size:16px;font-weight:600;margin-bottom:16px">üë• Team Workload</h3>
      <div id="team-workload-list"></div>
    </div>
  </div>
</div><!-- END STATISTICS TAB -->

<!-- ‚ïê‚ïê WORKING HOURS TAB ‚ïê‚ïê -->
<div id="workinghours-tab" class="tab-content">
  <div class="wh-wrap">
    <h2 style="font-size:20px;font-weight:600;margin-bottom:4px">‚è± Working Hours</h2>
    <p style="font-size:13px;color:var(--text-muted);margin-bottom:14px">Log hours per task by day. Only <strong>In Progress</strong> tasks are shown.</p>

    <!-- ‚öôÔ∏è Working Days Selector -->
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;gap:14px;flex-wrap:wrap">
      <span style="font-size:12px;font-weight:700;color:var(--text-muted);white-space:nowrap">‚öôÔ∏è Working Days:</span>
      <div style="display:flex;gap:5px;flex-wrap:wrap" id="wh-weekday-checks">
        <label class="dc-day-pill" id="wh-day-0"><input type="checkbox" value="0" onchange="whSaveWorkdays()"> Sun</label>
        <label class="dc-day-pill" id="wh-day-1"><input type="checkbox" value="1" onchange="whSaveWorkdays()"> Mon</label>
        <label class="dc-day-pill" id="wh-day-2"><input type="checkbox" value="2" onchange="whSaveWorkdays()"> Tue</label>
        <label class="dc-day-pill" id="wh-day-3"><input type="checkbox" value="3" onchange="whSaveWorkdays()"> Wed</label>
        <label class="dc-day-pill" id="wh-day-4"><input type="checkbox" value="4" onchange="whSaveWorkdays()"> Thu</label>
        <label class="dc-day-pill" id="wh-day-5"><input type="checkbox" value="5" onchange="whSaveWorkdays()"> Fri</label>
        <label class="dc-day-pill" id="wh-day-6"><input type="checkbox" value="6" onchange="whSaveWorkdays()"> Sat</label>
      </div>
      <span style="font-size:11px;color:var(--text-muted)" id="wh-workdays-summary"></span>
    </div>

    <!-- Inner tabs -->
    <div class="wh-inner-tabs">
      <button class="wh-inner-tab active" onclick="switchWHTab('entry')">üìù Enter Working Hours</button>
      <button class="wh-inner-tab" onclick="switchWHTab('submit')">üì§ Submit Working Hours</button>
    </div>

    <!-- ‚îÄ‚îÄ ENTRY PANEL ‚îÄ‚îÄ -->
    <div id="wh-panel-entry" class="wh-inner-panel active">
      <div class="wh-week-nav">
        <button class="btn btn-secondary btn-sm" onclick="whNavWeek(-1)">‚Üê Prev Week</button>
        <div>
          <div class="wh-week-label" id="wh-week-label">‚Äî</div>
          <div class="wh-week-sub" id="wh-week-sub">‚Äî</div>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="whNavWeek(1)">Next Week ‚Üí</button>
        <button class="btn btn-ghost btn-sm" onclick="whGoCurrentWeek()">Today</button>
        <span style="flex:1"></span>
        <div style="font-size:12px;color:var(--text-muted)">Total this week: <strong id="wh-week-total" style="color:var(--accent2);font-family:'DM Mono',monospace">0h</strong></div>
      </div>

      <div style="overflow-x:auto">
        <table class="wh-table" id="wh-entry-table">
          <thead>
            <tr id="wh-head-row">
              <th style="min-width:200px">Task</th>
              <th style="min-width:160px">Project</th>
              <th style="min-width:130px">3DEXP</th>
              <!-- day headers injected by JS -->
              <th class="total-col">Total</th>
            </tr>
          </thead>
          <tbody id="wh-tbody"></tbody>
        </table>
      </div>

      <div style="margin-top:16px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <button class="btn btn-primary" onclick="whSaveEntry()">üíæ Save Hours</button>
        <span style="font-size:12px;color:var(--text-muted)" id="wh-save-status"></span>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ SUBMIT PANEL ‚îÄ‚îÄ -->
    <div id="wh-panel-submit" class="wh-inner-panel">
      <!-- Export bar -->
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px 18px;margin-bottom:20px;display:flex;align-items:center;gap:14px;flex-wrap:wrap;">
        <span style="font-size:13px;font-weight:600;">üìä Export Working Hours Report</span>
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;flex:1">
          <label style="font-size:12px;font-weight:600;color:var(--text-muted);">Duration:</label>
          <input type="date" id="export-from-date" style="font-family:inherit;font-size:12px;border:1px solid var(--border-strong);border-radius:6px;padding:5px 10px;background:var(--bg);color:var(--text);outline:none;" />
          <span style="color:var(--text-muted);font-size:12px;">to</span>
          <input type="date" id="export-to-date" style="font-family:inherit;font-size:12px;border:1px solid var(--border-strong);border-radius:6px;padding:5px 10px;background:var(--bg);color:var(--text);outline:none;" />
          <button class="btn btn-ghost btn-sm" onclick="whSetExportCurrentMonth()">Current Month</button>
        </div>
        <button class="btn btn-primary" onclick="whExportToExcel()">‚¨á Export to Excel (.xlsx)</button>
      </div>

      <div style="display:grid;grid-template-columns:320px 1fr;gap:24px;align-items:start" id="wh-submit-grid">

        <!-- Left: weeks list -->
        <div>
          <div style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px">Weeks (most recent first)</div>
          <div class="wh-weeks-list" id="wh-weeks-list"></div>
        </div>

        <!-- Right: week detail report -->
        <div id="wh-report-area">
          <div class="wh-no-data">‚Üê Select a week to view its report</div>
        </div>
      </div>
    </div>
  </div>
</div><!-- END WORKING HOURS TAB -->

<!-- ‚ïê‚ïê SAMPLES TAB ‚ïê‚ïê -->
<div id="samples-tab" class="tab-content">
  <div class="sl-wrap">

    <!-- Stats strip -->
    <div class="sl-stats" id="sl-stats"></div>

    <!-- Toolbar -->
    <div class="sl-toolbar">
      <div class="sl-toolbar-left">
        <div class="search-wrap">
          <span class="search-icon">üîç</span>
          <input type="text" id="sl-search" placeholder="Search lots‚Ä¶" oninput="slRender()" style="width:200px" />
        </div>
        <select id="sl-filter-project" onchange="slRender()" style="min-width:160px">
          <option value="">All Projects</option>
        </select>
        <select id="sl-filter-phase" onchange="slRender()">
          <option value="">All Phases</option>
          <option>CP</option><option>T0</option><option>T1</option><option>T2</option><option>PR</option><option>PP</option><option>MP</option>
        </select>
        <select id="sl-filter-status" onchange="slRender()">
          <option value="">All Statuses</option>
          <option value="pending">Pending</option>
          <option value="partial">Partial</option>
          <option value="delivered">Delivered</option>
          <option value="overdue">Overdue</option>
        </select>
      </div>
      <div class="sl-toolbar-right">
        <button class="sl-view-btn active" id="sl-view-card" onclick="slSetView('card')" title="Card view">‚äû</button>
        <button class="sl-view-btn" id="sl-view-table" onclick="slSetView('table')" title="Table view">‚ò∞</button>
        <button class="btn btn-ghost btn-sm" onclick="slClearFilters()">‚úï Clear</button>
        <button class="btn btn-secondary btn-sm" onclick="slExport()">‚¨á Export</button>
        <button class="btn btn-primary" onclick="slOpenModal()">Ôºã New Lot</button>
      </div>
    </div>

    <!-- Card View -->
    <div id="sl-card-view">
      <div class="sl-grid" id="sl-grid"></div>
    </div>

    <!-- Table View -->
    <div id="sl-table-view" style="display:none">
      <div class="sl-table-wrap">
        <table class="sl-table">
          <thead>
            <tr>
              <th onclick="slSortBy('lotNumber')">Lot # <span id="slsort-lotNumber">‚Üï</span></th>
              <th onclick="slSortBy('project')">Project <span id="slsort-project">‚Üï</span></th>
              <th onclick="slSortBy('phase')">Phase <span id="slsort-phase">‚Üï</span></th>
              <th onclick="slSortBy('qty')">Qty <span id="slsort-qty">‚Üï</span></th>
              <th onclick="slSortBy('dateProd')">Prod. Date <span id="slsort-dateProd">‚Üï</span></th>
              <th onclick="slSortBy('dateDelivery')">Delivery <span id="slsort-dateDelivery">‚Üï</span></th>
              <th onclick="slSortBy('price')">Price <span id="slsort-price">‚Üï</span></th>
              <th>Purpose</th>
              <th>Request Teams</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="sl-tbody"></tbody>
        </table>
      </div>
    </div>

  </div>
</div><!-- END SAMPLES TAB -->

<!-- ‚ïê‚ïê TOOLS TAB ‚ïê‚ïê -->
<div id="tools-tab" class="tab-content">
<div class="tools-wrap">
  <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:4px">
    <div>
      <h2 style="font-size:20px;font-weight:700;margin-bottom:3px">üõ† Tools</h2>
      <p style="font-size:13px;color:var(--text-muted)">Handy calculators and converters ‚Äî all offline, nothing leaves your device.</p>
    </div>
  </div>

  <div class="tools-grid">

    <!-- ‚ïî‚ïê‚ïê SCIENTIFIC CALCULATOR ‚ïê‚ïê‚ïó -->
    <div class="tool-card" style="grid-row:span 2">
      <div class="tool-card-header">
        <div class="tool-card-icon">üî¢</div>
        <div><div class="tool-card-title">Scientific Calculator</div><div class="tool-card-sub">Arithmetic, trig, log, powers, constants</div></div>
      </div>
      <div class="tool-card-body">
        <div class="calc-display">
          <div class="calc-expr" id="calc-expr"></div>
          <div class="calc-result" id="calc-result">0</div>
        </div>
        <div class="calc-grid">
          <!-- Row 1: sci functions -->
          <button class="calc-btn fn" onclick="calcFn('sin(')">sin</button>
          <button class="calc-btn fn" onclick="calcFn('cos(')">cos</button>
          <button class="calc-btn fn" onclick="calcFn('tan(')">tan</button>
          <button class="calc-btn fn" onclick="calcFn('log(')">log</button>
          <button class="calc-btn fn" onclick="calcFn('ln(')">ln</button>
          <!-- Row 2 -->
          <button class="calc-btn fn" onclick="calcFn('asin(')">sin‚Åª¬π</button>
          <button class="calc-btn fn" onclick="calcFn('acos(')">cos‚Åª¬π</button>
          <button class="calc-btn fn" onclick="calcFn('atan(')">tan‚Åª¬π</button>
          <button class="calc-btn fn" onclick="calcFn('sqrt(')">‚àö</button>
          <button class="calc-btn fn" onclick="calcFn('cbrt(')">‚àõ</button>
          <!-- Row 3 -->
          <button class="calc-btn fn" onclick="calcFn('œÄ')">œÄ</button>
          <button class="calc-btn fn" onclick="calcFn('e')">e</button>
          <button class="calc-btn fn" onclick="calcFn('^')">x‚Åø</button>
          <button class="calc-btn fn" onclick="calcFn('!')">x!</button>
          <button class="calc-btn fn" onclick="calcFn('%')">%</button>
          <!-- Row 4 -->
          <button class="calc-btn clr" onclick="calcClear()">AC</button>
          <button class="calc-btn clr" onclick="calcDel()">‚å´</button>
          <button class="calc-btn fn" onclick="calcFn('(')">(</button>
          <button class="calc-btn fn" onclick="calcFn(')')">)</button>
          <button class="calc-btn op" onclick="calcFn('√∑')">√∑</button>
          <!-- Row 5 -->
          <button class="calc-btn num" onclick="calcFn('7')">7</button>
          <button class="calc-btn num" onclick="calcFn('8')">8</button>
          <button class="calc-btn num" onclick="calcFn('9')">9</button>
          <button class="calc-btn op" onclick="calcFn('√ó')">√ó</button>
          <button class="calc-btn fn" onclick="calcFn('abs(')">|x|</button>
          <!-- Row 6 -->
          <button class="calc-btn num" onclick="calcFn('4')">4</button>
          <button class="calc-btn num" onclick="calcFn('5')">5</button>
          <button class="calc-btn num" onclick="calcFn('6')">6</button>
          <button class="calc-btn op" onclick="calcFn('‚àí')">‚àí</button>
          <button class="calc-btn fn" onclick="calcFn('floor(')">‚åäx‚åã</button>
          <!-- Row 7 -->
          <button class="calc-btn num" onclick="calcFn('1')">1</button>
          <button class="calc-btn num" onclick="calcFn('2')">2</button>
          <button class="calc-btn num" onclick="calcFn('3')">3</button>
          <button class="calc-btn op" onclick="calcFn('+')">+</button>
          <button class="calc-btn fn" onclick="calcFn('ceil(')">‚åàx‚åâ</button>
          <!-- Row 8 -->
          <button class="calc-btn num zero" onclick="calcFn('0')">0</button>
          <button class="calc-btn num" onclick="calcFn('.')">.</button>
          <button class="calc-btn eq" onclick="calcEquals()">=</button>
        </div>
        <div style="margin-top:10px;display:flex;align-items:center;justify-content:space-between">
          <span style="font-size:11px;color:var(--text-muted)">üìã History (click to reuse)</span>
          <button class="btn btn-ghost btn-xs" onclick="calcClearHistory()">Clear</button>
        </div>
        <div class="calc-history" id="calc-history"><div style="font-size:11px;color:var(--text-light);padding:4px">No history yet</div></div>
      </div>
    </div>

    <!-- ‚ïî‚ïê‚ïê UNIT CONVERTER ‚ïê‚ïê‚ïó -->
    <div class="tool-card">
      <div class="tool-card-header">
        <div class="tool-card-icon">üìè</div>
        <div><div class="tool-card-title">Unit Converter</div><div class="tool-card-sub">Length, weight, temperature, area, volume, speed, force</div></div>
      </div>
      <div class="tool-card-body">
        <div class="uc-tabs" id="uc-tabs">
          <span class="uc-tab active" onclick="ucSetCategory(event,'length')">üìè Length</span>
          <span class="uc-tab" onclick="ucSetCategory(event,'weight')">‚öñÔ∏è Weight</span>
          <span class="uc-tab" onclick="ucSetCategory(event,'temp')">üå°Ô∏è Temp</span>
          <span class="uc-tab" onclick="ucSetCategory(event,'area')">üìê Area</span>
          <span class="uc-tab" onclick="ucSetCategory(event,'volume')">üß™ Volume</span>
          <span class="uc-tab" onclick="ucSetCategory(event,'speed')">üí® Speed</span>
          <span class="uc-tab" onclick="ucSetCategory(event,'force')">‚ö° Force</span>
          <span class="uc-tab" onclick="ucSetCategory(event,'pressure')">üîµ Pressure</span>
          <span class="uc-tab" onclick="ucSetCategory(event,'energy')">‚ö° Energy</span>
        </div>
        <div class="uc-row">
          <input class="uc-val" id="uc-from-val" type="number" value="1" oninput="ucConvert()" placeholder="Value" />
          <div class="uc-arrow">‚Üí</div>
          <div id="uc-result-val" class="uc-val" style="background:var(--accent2-soft);border-color:#bfdbfe;color:var(--accent2);font-weight:700;cursor:default" readonly></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">
          <select class="uc-select" id="uc-from-unit" onchange="ucConvert()"></select>
          <select class="uc-select" id="uc-to-unit" onchange="ucConvert()"></select>
        </div>
        <button class="btn btn-secondary btn-sm" style="width:100%" onclick="ucSwap()">‚áÖ Swap Units</button>
      </div>
    </div>

    <!-- ‚ïî‚ïê‚ïê MATERIALS REFERENCE ‚ïê‚ïê‚ïó -->
    <div class="tool-card" style="grid-column:1/-1">
      <div class="tool-card-header">
        <div class="tool-card-icon">üî©</div>
        <div><div class="tool-card-title">Engineering Materials Reference</div><div class="tool-card-sub">Resistivity, conductivity, density, temp coefficient ‚Äî Copper, Steel, Aluminium &amp; more</div></div>
      </div>
      <div class="tool-card-body" style="padding-top:10px">
        <div class="uc-tabs" style="margin-bottom:16px">
          <span class="uc-tab active" id="mat-tab-elec" onclick="matSetTab(event,'elec')">‚ö° Electrical</span>
          <span class="uc-tab" id="mat-tab-mech" onclick="matSetTab(event,'mech')">üî© Mechanical</span>
          <span class="uc-tab" id="mat-tab-therm" onclick="matSetTab(event,'therm')">üå°Ô∏è Thermal</span>
        </div>
        <!-- Electrical panel -->
        <div id="mat-panel-elec">
          <div style="overflow-x:auto">
            <table style="width:100%;border-collapse:collapse;font-size:12px">
              <thead>
                <tr style="background:#f0f4ff">
                  <th style="padding:9px 12px;text-align:left;font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid var(--border);white-space:nowrap">Material</th>
                  <th style="padding:9px 12px;text-align:right;font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid var(--border);white-space:nowrap">Resistivity œÅ (Œ©¬∑m) @20¬∞C</th>
                  <th style="padding:9px 12px;text-align:right;font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid var(--border);white-space:nowrap">Conductivity œÉ (S/m)</th>
                  <th style="padding:9px 12px;text-align:right;font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid var(--border);white-space:nowrap">Temp Coeff Œ± (/¬∞C)</th>
                  <th style="padding:9px 12px;text-align:left;font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid var(--border)">Note</th>
                </tr>
              </thead>
              <tbody id="mat-elec-tbody"></tbody>
            </table>
          </div>
          <!-- Resistance calculator -->
          <div style="margin-top:16px;background:#f0f4ff;border-radius:10px;padding:14px 16px">
            <div class="dc-label" style="margin-bottom:10px">‚ö° Resistance Calculator: R = œÅ √ó L / A</div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-bottom:10px">
              <div><label style="font-size:11px;color:var(--text-muted)">Material</label>
                <select class="uc-select" id="rcalc-mat" onchange="rcalcCompute()"></select>
              </div>
              <div><label style="font-size:11px;color:var(--text-muted)">Length (m)</label>
                <input class="pct-inp" id="rcalc-L" type="number" value="1" min="0" step="any" oninput="rcalcCompute()" placeholder="m" />
              </div>
              <div><label style="font-size:11px;color:var(--text-muted)">Cross-section (mm¬≤)</label>
                <input class="pct-inp" id="rcalc-A" type="number" value="1" min="0" step="any" oninput="rcalcCompute()" placeholder="mm¬≤" />
              </div>
              <div><label style="font-size:11px;color:var(--text-muted)">Temp (¬∞C)</label>
                <input class="pct-inp" id="rcalc-T" type="number" value="20" step="any" oninput="rcalcCompute()" placeholder="¬∞C" />
              </div>
            </div>
            <div id="rcalc-result" class="dc-result" style="display:none"></div>
          </div>
        </div>
        <!-- Mechanical panel -->
        <div id="mat-panel-mech" style="display:none">
          <div style="overflow-x:auto">
            <table style="width:100%;border-collapse:collapse;font-size:12px">
              <thead>
                <tr style="background:#fff7ed">
                  <th style="padding:9px 12px;text-align:left;font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid var(--border);white-space:nowrap">Material</th>
                  <th style="padding:9px 12px;text-align:right;font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid var(--border);white-space:nowrap">Density (kg/m¬≥)</th>
                  <th style="padding:9px 12px;text-align:right;font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid var(--border);white-space:nowrap">Young's Modulus (GPa)</th>
                  <th style="padding:9px 12px;text-align:right;font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid var(--border);white-space:nowrap">Yield Strength (MPa)</th>
                  <th style="padding:9px 12px;text-align:right;font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid var(--border);white-space:nowrap">Tensile Strength (MPa)</th>
                  <th style="padding:9px 12px;text-align:right;font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid var(--border);white-space:nowrap">Poisson's Ratio</th>
                </tr>
              </thead>
              <tbody id="mat-mech-tbody"></tbody>
            </table>
          </div>
        </div>
        <!-- Thermal panel -->
        <div id="mat-panel-therm" style="display:none">
          <div style="overflow-x:auto">
            <table style="width:100%;border-collapse:collapse;font-size:12px">
              <thead>
                <tr style="background:#f0fdf4">
                  <th style="padding:9px 12px;text-align:left;font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid var(--border);white-space:nowrap">Material</th>
                  <th style="padding:9px 12px;text-align:right;font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid var(--border);white-space:nowrap">Thermal Cond. (W/m¬∑K)</th>
                  <th style="padding:9px 12px;text-align:right;font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid var(--border);white-space:nowrap">Specific Heat (J/kg¬∑K)</th>
                  <th style="padding:9px 12px;text-align:right;font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid var(--border);white-space:nowrap">Thermal Exp. (¬µm/m¬∑¬∞C)</th>
                  <th style="padding:9px 12px;text-align:right;font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid var(--border);white-space:nowrap">Melt Point (¬∞C)</th>
                </tr>
              </thead>
              <tbody id="mat-therm-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚ïî‚ïê‚ïê DATE CALCULATOR ‚ïê‚ïê‚ïó -->
    <div class="tool-card">
      <div class="tool-card-header">
        <div class="tool-card-icon">üìÖ</div>
        <div><div class="tool-card-title">Date & Duration Calculator</div><div class="tool-card-sub">Days between dates, working days, add/subtract days</div></div>
      </div>
      <div class="tool-card-body">
        <!-- Working Day Selector -->
        <div class="dc-section">
          <div class="dc-label" style="margin-bottom:8px">‚öôÔ∏è Working Days Setup</div>
          <div style="display:flex;gap:5px;flex-wrap:wrap" id="dc-weekday-checks">
            <label class="dc-day-pill" id="dc-day-0"><input type="checkbox" value="0" onchange="dcSaveWorkdays()"> Sun</label>
            <label class="dc-day-pill" id="dc-day-1"><input type="checkbox" value="1" checked onchange="dcSaveWorkdays()"> Mon</label>
            <label class="dc-day-pill" id="dc-day-2"><input type="checkbox" value="2" checked onchange="dcSaveWorkdays()"> Tue</label>
            <label class="dc-day-pill" id="dc-day-3"><input type="checkbox" value="3" checked onchange="dcSaveWorkdays()"> Wed</label>
            <label class="dc-day-pill" id="dc-day-4"><input type="checkbox" value="4" checked onchange="dcSaveWorkdays()"> Thu</label>
            <label class="dc-day-pill" id="dc-day-5"><input type="checkbox" value="5" onchange="dcSaveWorkdays()"> Fri</label>
            <label class="dc-day-pill" id="dc-day-6"><input type="checkbox" value="6" onchange="dcSaveWorkdays()"> Sat</label>
          </div>
          <div style="font-size:11px;color:var(--text-muted);margin-top:5px" id="dc-workdays-summary"></div>
        </div>
        <hr style="border:none;border-top:1px solid var(--border);margin:12px 0" />
        <!-- Days Between -->
        <div class="dc-section">
          <div class="dc-label">Days Between Two Dates</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <div><label style="font-size:11px;color:var(--text-muted)">From</label>
              <input type="date" id="dc-from" style="width:100%;font-family:inherit;font-size:13px;border:1.5px solid var(--border-strong);border-radius:8px;padding:8px 10px;background:var(--bg);color:var(--text);outline:none;" oninput="dcCalcDiff()" />
            </div>
            <div><label style="font-size:11px;color:var(--text-muted)">To</label>
              <input type="date" id="dc-to" style="width:100%;font-family:inherit;font-size:13px;border:1.5px solid var(--border-strong);border-radius:8px;padding:8px 10px;background:var(--bg);color:var(--text);outline:none;" oninput="dcCalcDiff()" />
            </div>
          </div>
          <div class="dc-result" id="dc-diff-result" style="display:none"></div>
        </div>
        <hr style="border:none;border-top:1px solid var(--border);margin:12px 0" />
        <!-- Add/Subtract -->
        <div class="dc-section">
          <div class="dc-label">Add / Subtract Working Days</div>
          <div style="display:grid;grid-template-columns:1fr 80px 80px;gap:8px;align-items:end">
            <div><label style="font-size:11px;color:var(--text-muted)">Start Date</label>
              <input type="date" id="dc-start" style="width:100%;font-family:inherit;font-size:13px;border:1.5px solid var(--border-strong);border-radius:8px;padding:8px 10px;background:var(--bg);color:var(--text);outline:none;" oninput="dcCalcAdd()" />
            </div>
            <div><label style="font-size:11px;color:var(--text-muted)">¬± Work Days</label>
              <input type="number" id="dc-days" style="width:100%;font-family:'DM Mono',monospace;font-size:13px;border:1.5px solid var(--border-strong);border-radius:8px;padding:8px 10px;background:var(--bg);color:var(--text);outline:none;" placeholder="30" oninput="dcCalcAdd()" />
            </div>
            <button class="btn btn-blue btn-sm" onclick="dcCalcAdd()" style="height:38px">Calc</button>
          </div>
          <div class="dc-result" id="dc-add-result" style="display:none"></div>
        </div>
        <hr style="border:none;border-top:1px solid var(--border);margin:12px 0" />
        <!-- Age -->
        <div class="dc-section">
          <div class="dc-label">Age / Time Elapsed</div>
          <div style="display:flex;gap:8px;align-items:flex-end">
            <div style="flex:1"><label style="font-size:11px;color:var(--text-muted)">Birth / Start Date</label>
              <input type="date" id="dc-birth" style="width:100%;font-family:inherit;font-size:13px;border:1.5px solid var(--border-strong);border-radius:8px;padding:8px 10px;background:var(--bg);color:var(--text);outline:none;" oninput="dcCalcAge()" />
            </div>
            <button class="btn btn-blue btn-sm" onclick="dcCalcAge()" style="height:38px">Today</button>
          </div>
          <div class="dc-result" id="dc-age-result" style="display:none"></div>
        </div>
      </div>
    </div>

    <!-- ‚ïî‚ïê‚ïê PERCENTAGE CALCULATOR ‚ïê‚ïê‚ïó -->
    <div class="tool-card">
      <div class="tool-card-header">
        <div class="tool-card-icon">%</div>
        <div><div class="tool-card-title">Percentage Calculator</div><div class="tool-card-sub">What is X% of Y? Increase/decrease, back-calculate</div></div>
      </div>
      <div class="tool-card-body" style="display:flex;flex-direction:column;gap:14px;">
        <!-- What is X% of Y -->
        <div style="background:var(--bg);border-radius:10px;padding:12px 14px">
          <div class="dc-label" style="margin-bottom:8px">What is X% of Y?</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <input class="pct-inp" id="pct1-x" type="number" placeholder="X (%)" oninput="pctCalc1()" />
            <input class="pct-inp" id="pct1-y" type="number" placeholder="Y (base)" oninput="pctCalc1()" />
          </div>
          <div class="pct-result" id="pct1-r" style="display:none"></div>
        </div>
        <!-- X is what % of Y -->
        <div style="background:var(--bg);border-radius:10px;padding:12px 14px">
          <div class="dc-label" style="margin-bottom:8px">X is what % of Y?</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <input class="pct-inp" id="pct2-x" type="number" placeholder="X (part)" oninput="pctCalc2()" />
            <input class="pct-inp" id="pct2-y" type="number" placeholder="Y (whole)" oninput="pctCalc2()" />
          </div>
          <div class="pct-result" id="pct2-r" style="display:none"></div>
        </div>
        <!-- % change -->
        <div style="background:var(--bg);border-radius:10px;padding:12px 14px">
          <div class="dc-label" style="margin-bottom:8px">% Change (from ‚Üí to)</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <input class="pct-inp" id="pct3-from" type="number" placeholder="From" oninput="pctCalc3()" />
            <input class="pct-inp" id="pct3-to" type="number" placeholder="To" oninput="pctCalc3()" />
          </div>
          <div class="pct-result" id="pct3-r" style="display:none"></div>
        </div>
        <!-- add/remove X% from value -->
        <div style="background:var(--bg);border-radius:10px;padding:12px 14px">
          <div class="dc-label" style="margin-bottom:8px">Add / Remove X% from value</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <input class="pct-inp" id="pct4-val" type="number" placeholder="Value" oninput="pctCalc4()" />
            <input class="pct-inp" id="pct4-pct" type="number" placeholder="% amount" oninput="pctCalc4()" />
          </div>
          <div class="pct-result" id="pct4-r" style="display:none"></div>
        </div>
      </div>
    </div>

  </div><!-- /tools-grid -->
</div><!-- /tools-wrap -->
</div><!-- END TOOLS TAB -->

<!-- ‚ïê‚ïê VERIFICATION TAB ‚ïê‚ïê -->
<div id="verification-tab" class="tab-content">
<div class="vf-wrap">
  <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:16px">
    <div>
      <h2 style="font-size:20px;font-weight:700;margin-bottom:3px">üî¨ Verification Follow-Up</h2>
      <p style="font-size:13px;color:var(--text-muted)">Auto-generated from sample lots. Track Safety, Performance, Motor Aging &amp; In-Product tests.</p>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn btn-ghost btn-sm" onclick="vfClearFilters()">‚úï Clear Filters</button>
      <button class="btn btn-secondary btn-sm" onclick="vfExport()">‚¨á Export Excel</button>
    </div>
  </div>

  <!-- Stats -->
  <div class="vf-stats" id="vf-stats"></div>

  <!-- Filters -->
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:12px 16px;margin-bottom:18px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
    <div class="search-wrap" style="flex:1;min-width:180px">
      <span class="search-icon">üîç</span>
      <input type="text" id="vf-search" placeholder="Search by lot, project, PIC‚Ä¶" oninput="vfRender()" style="width:100%" />
    </div>
    <select id="vf-filter-type" onchange="vfRender()" style="font-family:inherit;font-size:12px;border:1px solid var(--border-strong);border-radius:8px;padding:7px 10px;background:var(--bg);color:var(--text);outline:none">
      <option value="">All Types</option>
      <option value="Safety">üõ° Safety</option>
      <option value="Performance">‚ö° Performance</option>
      <option value="Motor Aging">‚öôÔ∏è Motor Aging</option>
      <option value="In-Product">üì¶ In-Product</option>
    </select>
    <select id="vf-filter-status" onchange="vfRender()" style="font-family:inherit;font-size:12px;border:1px solid var(--border-strong);border-radius:8px;padding:7px 10px;background:var(--bg);color:var(--text);outline:none">
      <option value="">All Statuses</option>
      <option value="Planned">Planned</option>
      <option value="Ongoing">Ongoing</option>
      <option value="Done">Done</option>
      <option value="Blocked">Blocked</option>
      <option value="Cancelled">Cancelled</option>
    </select>
    <select id="vf-filter-bearer" onchange="vfRender()" style="font-family:inherit;font-size:12px;border:1px solid var(--border-strong);border-radius:8px;padding:7px 10px;background:var(--bg);color:var(--text);outline:none">
      <option value="">All Bearers</option>
      <option value="Motor">‚öôÔ∏è Motor</option>
      <option value="Others">üì¶ Others</option>
    </select>
    <select id="vf-filter-lot" onchange="vfRender()" style="font-family:inherit;font-size:12px;border:1px solid var(--border-strong);border-radius:8px;padding:7px 10px;background:var(--bg);color:var(--text);outline:none;min-width:140px">
      <option value="">All Lots</option>
    </select>
    <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer;white-space:nowrap">
      <input type="checkbox" id="vf-filter-overdue" onchange="vfRender()" style="accent-color:var(--accent)"> ‚ö† Overdue only
    </label>
    <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer;white-space:nowrap">
      <input type="checkbox" id="vf-filter-reminder" onchange="vfRender()" style="accent-color:var(--accent)"> üîî Reminders only
    </label>
  </div>

  <!-- Inner type tabs -->
  <div class="vf-inner-tabs" id="vf-inner-tabs">
    <button class="vf-inner-tab active" onclick="vfSetTypeTab(event,'all')">All Tests</button>
    <button class="vf-inner-tab" onclick="vfSetTypeTab(event,'Safety')">üõ° Safety</button>
    <button class="vf-inner-tab" onclick="vfSetTypeTab(event,'Performance')">‚ö° Performance</button>
    <button class="vf-inner-tab" onclick="vfSetTypeTab(event,'Motor Aging')">‚öôÔ∏è Motor Aging</button>
    <button class="vf-inner-tab" onclick="vfSetTypeTab(event,'In-Product')">üì¶ In-Product</button>
  </div>

  <!-- Card grid -->
  <div class="vf-grid" id="vf-grid"></div>
</div>
</div><!-- END VERIFICATION TAB -->

<!-- ‚ïê‚ïê VERIFICATION EDIT MODAL ‚ïê‚ïê -->
<div class="modal-overlay" id="vf-modal" onclick="vfCloseOverlay(event)">
  <div class="modal" style="max-width:620px">
    <div class="modal-header">
      <h2 id="vf-modal-title">Edit Verification Item</h2>
      <button class="btn btn-ghost btn-sm" onclick="closeModal('vf-modal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div style="background:var(--accent2-soft);border:1px solid #bfdbfe;border-radius:8px;padding:8px 14px;margin-bottom:14px;font-size:12px;color:var(--accent2)">
        üîó Linked to: <strong id="vf-f-lot-display">‚Äî</strong>
        &nbsp;|&nbsp; Type: <strong id="vf-f-type-display">‚Äî</strong>
        &nbsp;|&nbsp; Item #<strong id="vf-f-item-display">‚Äî</strong>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="form-group">
          <label>Status</label>
          <select id="vf-f-status" style="width:100%">
            <option>Planned</option><option>Ongoing</option><option>Done</option><option>Blocked</option><option>Cancelled</option>
          </select>
        </div>
        <div class="form-group">
          <label>PIC (Person in Charge)</label>
          <input type="text" id="vf-f-pic" placeholder="Name or team" style="width:100%" />
        </div>
        <div class="form-group">
          <label>Start Date</label>
          <input type="date" id="vf-f-start" style="width:100%" />
        </div>
        <div class="form-group">
          <label>End Date</label>
          <input type="date" id="vf-f-end" style="width:100%" />
        </div>
        <div class="form-group">
          <label>Cost (EGP)</label>
          <input type="number" id="vf-f-cost" min="0" step="0.01" placeholder="0.00" style="font-family:inherit;font-size:13px;border:1px solid var(--border-strong);border-radius:8px;padding:9px 12px;background:var(--bg);color:var(--text);outline:none;width:100%" />
        </div>
        <div class="form-group">
          <label>üì¶ Quantity</label>
          <input type="number" id="vf-f-qty" min="1" placeholder="1" style="font-family:inherit;font-size:13px;border:1px solid var(--border-strong);border-radius:8px;padding:9px 12px;background:var(--bg);color:var(--text);outline:none;width:100%" />
        </div>
        <div class="form-group">
          <label>Cost Bearer</label>
          <div class="cost-bearer-toggle">
            <button type="button" class="cost-bearer-btn active-motor" id="vf-bearer-motor" onclick="vfSetBearer('Motor')">‚öôÔ∏è Motor</button>
            <button type="button" class="cost-bearer-btn" id="vf-bearer-others" onclick="vfSetBearer('Others')">üì¶ Others</button>
          </div>
        </div>
        <div class="form-group">
          <label>üîî Reminder Date</label>
          <input type="date" id="vf-f-reminder" style="width:100%" />
        </div>
        <div class="form-group">
          <label>üîó Depends On</label>
          <select id="vf-f-depends-on" style="width:100%">
            <option value="">‚Äî No Dependency ‚Äî</option>
          </select>
          <div style="font-size:10px;color:var(--text-muted);margin-top:4px">This test cannot start until the selected test is completed</div>
        </div>
        <div class="form-group">
          <label>Sample Received</label>
          <div style="display:flex;align-items:center;gap:8px;margin-top:6px">
            <input type="checkbox" id="vf-f-sampleReceived" style="accent-color:var(--accent2);width:16px;height:16px" />
            <label for="vf-f-sampleReceived" style="font-size:12px;font-weight:normal">Sample received from verification</label>
          </div>
        </div>
        <div class="form-group full" style="grid-column:1/-1">
          <label>Notes / Findings</label>
          <textarea id="vf-f-notes" placeholder="Test results, observations, action items‚Ä¶" style="font-family:inherit;font-size:13px;border:1px solid var(--border-strong);border-radius:8px;padding:9px 12px;background:var(--bg);color:var(--text);outline:none;resize:vertical;min-height:70px;width:100%"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger btn-sm" onclick="vfDeleteItem()" style="margin-right:auto">üóë Delete</button>
      <button class="btn btn-secondary" onclick="closeModal('vf-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="vfSaveItem()">Save</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê SAMPLE LOT MODAL ‚ïê‚ïê -->
<div class="modal-overlay" id="sl-modal" onclick="slCloseOverlay(event)">
  <div class="modal" style="max-width:680px">
    <div class="modal-header">
      <h2 id="sl-modal-title">New Sample Lot</h2>
      <button class="btn btn-ghost btn-sm" onclick="closeModal('sl-modal')">‚úï</button>
    </div>
    <div class="modal-body">

      <div class="sl-section-title">üì¶ Lot Information</div>
      <div class="sl-form-grid">
        <div class="form-group">
          <label>Project *</label>
          <select id="sl-f-project" style="width:100%">
            <option value="">‚Äî Select Project ‚Äî</option>
          </select>
        </div>
        <div class="form-group">
          <label>Phase *</label>
          <select id="sl-f-phase">
            <option value="">‚Äî Select Phase ‚Äî</option>
            <option>CP</option><option>T0</option><option>T1</option><option>T2</option><option>PR</option><option>PP</option><option>MP</option>
          </select>
        </div>
        <div class="form-group">
          <label>Lot Number *</label>
          <input type="text" id="sl-f-lotNumber" placeholder="e.g. LOT-001" />
        </div>
        <div class="form-group full" style="grid-column:1/-1">
          <label>üè∑Ô∏è Label Prefix (for Export)</label>
          <input type="text" id="sl-f-labelPrefix" placeholder="e.g. Motor-X1-Sample or leave blank for auto" style="width:100%;font-family:inherit;font-size:13px;border:1px solid var(--border-strong);border-radius:8px;padding:9px 12px;background:var(--bg);color:var(--text);outline:none" />
          <div style="font-size:10px;color:var(--text-muted);margin-top:4px">This will generate labels: Prefix-001, Prefix-002, ... Prefix-[Qty] with production date</div>
        </div>
        <div class="form-group">
          <label>üë• Requesting Team</label>
          <select id="sl-f-requesting-team">
            <option value="">‚Äî Select Team ‚Äî</option>
            <option value="Verification Team">Verification Team</option>
            <option value="Product Team">Product Team</option>
          </select>
        </div>
        <div class="form-group">
          <label>üë§ PIC (Person in Charge)</label>
          <input type="text" id="sl-f-pic" placeholder="Enter name" />
        </div>
        <div class="form-group">
          <label>Quantity</label>
          <input type="number" id="sl-f-qty" min="1" placeholder="e.g. 5" style="font-family:inherit;font-size:13px;border:1px solid var(--border-strong);border-radius:8px;padding:9px 12px;background:var(--bg);color:var(--text);outline:none;width:100%" />
        </div>
        <div class="form-group">
          <label>Production Date</label>
          <input type="date" id="sl-f-dateProd" style="width:100%" />
        </div>
        <div class="form-group">
          <label>Delivery Date</label>
          <input type="date" id="sl-f-dateDelivery" style="width:100%" />
        </div>
        <div class="form-group">
          <label>Price (EGP)</label>
          <input type="number" id="sl-f-price" min="0" step="0.01" placeholder="0.00" style="font-family:inherit;font-size:13px;border:1px solid var(--border-strong);border-radius:8px;padding:9px 12px;background:var(--bg);color:var(--text);outline:none;width:100%" />
        </div>
        <div class="form-group">
          <label>Cost Bearer</label>
          <div class="cost-bearer-toggle" id="sl-f-bearer-wrap">
            <button type="button" class="cost-bearer-btn active-motor" id="sl-bearer-motor" onclick="slSetBearer('Motor')">‚öôÔ∏è Motor</button>
            <button type="button" class="cost-bearer-btn" id="sl-bearer-others" onclick="slSetBearer('Others')">üì¶ Others</button>
          </div>
        </div>
        <div class="form-group">
          <label>Purpose</label>
          <select id="sl-f-purpose">
            <option value="">‚Äî Select ‚Äî</option>
            <option>Validation</option>
            <option>Performance Test</option>
            <option>Reliability Test</option>
            <option>Safety Test</option>
            <option>Certification</option>
            <option>Customer Review</option>
            <option>Internal Audit</option>
            <option>Proto Build</option>
            <option>Other</option>
          </select>
        </div>
        <div class="form-group full">
          <label>Notes / Description</label>
          <textarea id="sl-f-notes" placeholder="Additional notes about this sample lot‚Ä¶" style="font-family:inherit;font-size:13px;border:1px solid var(--border-strong);border-radius:8px;padding:9px 12px;background:var(--bg);color:var(--text);outline:none;resize:vertical;min-height:60px;width:100%"></textarea>
        </div>
      </div>

      <div class="sl-section-title">üë• Requesting Teams & Receipt Tracking</div>
      <div class="sl-receipt-list" id="sl-receipt-list"></div>
      <div class="sl-add-team-wrap">
        <input type="text" id="sl-new-team-input" placeholder="Add team name (e.g. R&D, Quality, Marketing)‚Ä¶" onkeydown="if(event.key==='Enter')slAddTeam()" />
        <button class="btn btn-secondary btn-sm" onclick="slAddTeam()">Ôºã Add Team</button>
      </div>

    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('sl-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="slSaveLot()">Save Lot</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê GITHUB SETTINGS MODAL ‚ïê‚ïê -->
<div class="modal-overlay" id="github-settings-modal" onclick="if(event.target.id==='github-settings-modal')closeModal('github-settings-modal')">
  <div class="modal" style="max-width:600px">
    <div class="modal-header">
      <h2>‚öôÔ∏è GitHub Sync Settings</h2>
      <button class="btn btn-ghost btn-sm" onclick="closeModal('github-settings-modal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:12px;margin-bottom:16px;font-size:12px;color:#1e40af">
        <strong>üìå How to set up GitHub sync:</strong><br>
        1. Create a Personal Access Token at <a href="https://github.com/settings/tokens" target="_blank" style="color:#2563eb">github.com/settings/tokens</a><br>
        2. Select scope: <code>repo</code> (full control of private repositories)<br>
        3. Copy your token and paste it below<br>
        4. Enter your GitHub username and repository name
      </div>
      
      <div class="form-group" style="margin-bottom:16px">
        <label style="display:block;margin-bottom:6px;font-weight:600">GitHub Username</label>
        <input type="text" id="gh-username" placeholder="e.g. yourusername" style="width:100%;font-family:inherit;font-size:13px;border:1px solid var(--border-strong);border-radius:8px;padding:9px 12px;background:var(--bg);color:var(--text);outline:none" />
      </div>
      
      <div class="form-group" style="margin-bottom:16px">
        <label style="display:block;margin-bottom:6px;font-weight:600">Repository Name</label>
        <input type="text" id="gh-repo" placeholder="e.g. task-manager-data" style="width:100%;font-family:inherit;font-size:13px;border:1px solid var(--border-strong);border-radius:8px;padding:9px 12px;background:var(--bg);color:var(--text);outline:none" />
      </div>
      
      <div class="form-group" style="margin-bottom:16px">
        <label style="display:block;margin-bottom:6px;font-weight:600">Personal Access Token</label>
        <input type="password" id="gh-token" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" style="width:100%;font-family:inherit;font-size:13px;border:1px solid var(--border-strong);border-radius:8px;padding:9px 12px;background:var(--bg);color:var(--text);outline:none" />
        <div style="font-size:10px;color:var(--text-muted);margin-top:4px">Your token is stored locally in your browser only</div>
      </div>
      
      <div class="form-group" style="margin-bottom:16px">
        <label style="display:block;margin-bottom:6px;font-weight:600">Data File Path (optional)</label>
        <input type="text" id="gh-filepath" placeholder="data/task-manager-backup.json" value="task-manager-backup.json" style="width:100%;font-family:inherit;font-size:13px;border:1px solid var(--border-strong);border-radius:8px;padding:9px 12px;background:var(--bg);color:var(--text);outline:none" />
        <div style="font-size:10px;color:var(--text-muted);margin-top:4px">Path where data will be saved in your repo</div>
      </div>
      
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn btn-secondary btn-sm" onclick="testGitHubConnection()">üîç Test Connection</button>
        <button class="btn btn-secondary btn-sm" onclick="clearGitHubSettings()">üóë Clear Settings</button>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('github-settings-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveGitHubSettings()">üíæ Save Settings</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê TASK MODAL ‚ïê‚ïê -->
<div class="modal-overlay" id="modal-overlay" onclick="closeOverlay(event,'modal-overlay')">
  <div class="modal" style="max-width:540px">
    <div class="modal-header">
      <h2 id="modal-title">Add Task</h2>
      <button class="btn btn-ghost btn-sm" onclick="closeModal('modal-overlay')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group full"><label>Task Title *</label><input type="text" id="f-title" placeholder="What needs to be done?" /></div>
        <div class="form-group full"><label>Description</label><textarea id="f-desc" placeholder="Optional details‚Ä¶"></textarea></div>
        <div class="form-group"><label>Project *</label>
          <select id="f-project" style="width:100%">
            <option value="">-- Select Project --</option>
          </select>
        </div>
        <div class="form-group"><label>Assignee</label><input type="text" id="f-assignee" list="assignee-list" /><datalist id="assignee-list"></datalist></div>
        <div class="form-group"><label>Status</label><select id="f-status"><option>To Do</option><option>In Progress</option><option>In Review</option><option>Done</option><option>Blocked</option></select></div>
        <div class="form-group"><label>Priority</label><select id="f-priority"><option>Medium</option><option>High</option><option>Low</option></select></div>
        <div class="form-group"><label>Due Date</label><input type="date" id="f-due" /></div>
        <div class="form-group"><label>Progress (%)</label><input type="number" id="f-progress" min="0" max="100" value="0" /></div>
        <div class="form-group"><label>Task on 3DEXP</label><input type="text" id="f-task3DEXP" placeholder="3DEXP task reference" /></div>
        <div class="form-group"><label>Project Type</label><select id="f-projectType"><option value="">‚Äî</option></select></div>
        <div class="form-group"><label>Product</label><select id="f-product"><option value="">‚Äî</option></select></div>
        <div class="form-group"><label>Project Phase</label><select id="f-projectPhase"><option value="">‚Äî</option></select></div>
        <div class="form-group full"><label>Notes</label><textarea id="f-notes" placeholder="Extra notes or links‚Ä¶"></textarea></div>
        <div class="form-group full"><label>Depends On</label><div class="dep-selector" id="dep-selector"></div></div>
        <div id="custom-fields-wrap" style="grid-column:1/-1;display:grid;grid-template-columns:1fr 1fr;gap:14px;"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-overlay')">Cancel</button>
      <button class="btn btn-primary" onclick="saveTask()">Save Task</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê ADD COLUMN MODAL ‚ïê‚ïê -->
<div class="modal-overlay" id="addcol-modal" onclick="closeOverlay(event,'addcol-modal')">
  <div class="modal" style="max-width:460px">
    <div class="modal-header">
      <h2>Manage Columns</h2>
      <button class="btn btn-ghost btn-sm" onclick="closeModal('addcol-modal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div>
        <div style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Your Custom Columns</div>
        <div class="custom-cols-list" id="custom-cols-list"><span style="color:var(--text-light);font-size:12px;padding:4px">No custom columns yet</span></div>
      </div>
      <hr style="border:none;border-top:1px solid var(--border)" />
      <div>
        <div style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px">Add New Column</div>
        <div class="form-group" style="margin-bottom:12px"><label>Column Name</label><input type="text" id="new-col-name" placeholder="e.g. Sprint, Category, Reviewer‚Ä¶" /></div>
        <div style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Column Type</div>
        <div class="col-type-grid">
          <button class="col-type-btn selected" data-type="text" onclick="selectColType(this)"><div class="col-type-icon">üìù</div><div class="col-type-name">Text</div><div class="col-type-desc">Free-form input</div></button>
          <button class="col-type-btn" data-type="number" onclick="selectColType(this)"><div class="col-type-icon">üî¢</div><div class="col-type-name">Number</div><div class="col-type-desc">Numeric value</div></button>
          <button class="col-type-btn" data-type="date" onclick="selectColType(this)"><div class="col-type-icon">üìÖ</div><div class="col-type-name">Date</div><div class="col-type-desc">Date picker</div></button>
          <button class="col-type-btn" data-type="select" onclick="selectColType(this)"><div class="col-type-icon">üîΩ</div><div class="col-type-name">Dropdown</div><div class="col-type-desc">Choose from options</div></button>
        </div>
        <div id="select-options-group" class="form-group" style="display:none;margin-top:12px"><label>Options (comma-separated)</label><input type="text" id="new-col-options" placeholder="Option A, Option B, Option C" /></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('addcol-modal')">Close</button>
      <button class="btn btn-primary" onclick="addCustomColumn()">Add Column</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê CHART MODAL ‚ïê‚ïê -->
<div class="modal-overlay" id="chart-modal" onclick="closeOverlay(event,'chart-modal')">
  <div class="modal" style="max-width:800px">
    <div class="modal-header">
      <h2>üìä Team Statistics</h2>
      <button class="btn btn-ghost btn-sm" onclick="closeModal('chart-modal')">‚úï</button>
    </div>
    <div style="padding:12px 24px;background:var(--bg);border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
      <span style="font-size:12px;font-weight:600;color:var(--text-muted);">Filter by:</span>
      <select id="stats-filter-product" onchange="refreshCharts()" style="font-size:12px;padding:5px 10px;border:1px solid var(--border-strong);border-radius:6px;background:var(--surface);">
        <option value="">All Products</option>
      </select>
      <select id="stats-filter-project-type" onchange="refreshCharts()" style="font-size:12px;padding:5px 10px;border:1px solid var(--border-strong);border-radius:6px;background:var(--surface);">
        <option value="">All Project Types</option>
      </select>
      <button class="btn btn-xs btn-secondary" onclick="clearStatsFilters()">Clear</button>
    </div>
    <div class="chart-tabs">
      <button class="chart-tab active" onclick="switchTab('tab-person',0)">Tasks per Person</button>
      <button class="chart-tab" onclick="switchTab('tab-status',1)">Status Breakdown</button>
      <button class="chart-tab" onclick="switchTab('tab-priority',2)">Priority Mix</button>
      <button class="chart-tab" onclick="switchTab('tab-progress',3)">Avg. Progress</button>
    </div>
    <div class="chart-panel active" id="tab-person">
      <div class="chart-canvas-wrap" style="height:270px"><canvas id="chart-person" class="chart"></canvas></div>
      <div class="person-cards" id="person-cards"></div>
    </div>
    <div class="chart-panel" id="tab-status">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:center">
        <div class="chart-canvas-wrap" style="height:260px"><canvas id="chart-status" class="chart"></canvas></div>
        <div id="status-legend"></div>
      </div>
    </div>
    <div class="chart-panel" id="tab-priority">
      <div class="chart-canvas-wrap" style="height:270px"><canvas id="chart-priority" class="chart"></canvas></div>
    </div>
    <div class="chart-panel" id="tab-progress">
      <div class="chart-canvas-wrap" style="height:270px"><canvas id="chart-progress" class="chart"></canvas></div>
    </div>
    <div style="padding:0 24px 16px;font-size:11px;color:var(--text-light)">Based on <span id="chart-total">0</span> filtered tasks</div>
  </div>
</div>

<!-- ‚ïê‚ïê CONDITIONAL FORMATTING MODAL ‚ïê‚ïê -->
<div class="modal-overlay" id="cf-modal" onclick="closeOverlay(event,'cf-modal')">
  <div class="modal">
    <div class="modal-header">
      <h2>üé® Conditional Formatting Rules</h2>
      <button class="btn btn-ghost btn-sm" onclick="closeModal('cf-modal')">‚úï</button>
    </div>
    <div class="modal-body">
      <p style="font-size:13px;color:var(--text-muted);margin-bottom:16px">Apply automatic formatting to rows based on conditions. Rules are applied in order.</p>
      
      <h3 style="font-size:13px;font-weight:600;margin-bottom:10px">Quick Presets</h3>
      <div class="cf-preset-grid">
        <div class="cf-preset-btn" onclick="addPresetRule('overdue')">
          <div class="cf-preset-name">‚è∞ Overdue Tasks</div>
          <div class="cf-preset-desc">Red background for past due dates</div>
        </div>
        <div class="cf-preset-btn" onclick="addPresetRule('high-priority')">
          <div class="cf-preset-name">üî• High Priority</div>
          <div class="cf-preset-desc">Yellow background for urgent items</div>
        </div>
        <div class="cf-preset-btn" onclick="addPresetRule('blocked')">
          <div class="cf-preset-name">üö´ Blocked Status</div>
          <div class="cf-preset-desc">Red border for blocked tasks</div>
        </div>
        <div class="cf-preset-btn" onclick="addPresetRule('almost-done')">
          <div class="cf-preset-name">‚úÖ Almost Done</div>
          <div class="cf-preset-desc">Green background for 80%+ progress</div>
        </div>
      </div>
      
      <h3 style="font-size:13px;font-weight:600;margin:20px 0 10px">Custom Rules</h3>
      <div class="cf-rules-list" id="cf-rules-list"></div>
      <button class="cf-add-rule" onclick="addCFRule()">+ Add Custom Rule</button>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="applyCFRules()">Apply Rules</button>
      <button class="btn btn-secondary" onclick="closeModal('cf-modal')">Close</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê INFO MODAL ‚ïê‚ïê -->
<div class="modal-overlay" id="info-modal" onclick="closeOverlay(event,'info-modal')">
  <div class="modal" style="max-width:600px">
    <div class="modal-header">
      <h2>‚ÑπÔ∏è About Data Storage & Sync</h2>
      <button class="btn btn-ghost btn-sm" onclick="closeModal('info-modal')">‚úï</button>
    </div>
    <div class="modal-body">
      <h3 style="font-size:14px;font-weight:600;margin-bottom:10px">üîí How Your Data is Stored</h3>
      <p style="font-size:13px;line-height:1.6;margin-bottom:16px;color:var(--text-muted)">
        All your tasks, custom columns, formatting rules, and settings are saved automatically in your <strong>browser's local storage</strong>. This means:
      </p>
      <ul style="font-size:13px;line-height:1.8;margin-left:20px;margin-bottom:20px;color:var(--text)">
        <li><strong>No cloud storage</strong> - Your data stays on your device</li>
        <li><strong>Privacy-first</strong> - Nothing is sent to external servers</li>
        <li><strong>Instant saves</strong> - Every edit auto-saves immediately</li>
        <li><strong>Offline capable</strong> - Works without internet connection</li>
      </ul>

      <h3 style="font-size:14px;font-weight:600;margin-bottom:10px;margin-top:24px">‚ö†Ô∏è Important Limitations</h3>
      <div style="background:#fef3c7;border-left:4px solid #f59e0b;padding:12px 14px;border-radius:8px;margin-bottom:16px">
        <p style="font-size:13px;line-height:1.6;color:#92400e;margin:0">
          <strong>Data does NOT sync across devices or browsers!</strong><br>
          Each device/browser has its own separate copy. Opening this file on another computer will show a fresh task board.
        </p>
      </div>

      <h3 style="font-size:14px;font-weight:600;margin-bottom:10px;margin-top:24px">üì§ How to Share Data Across Devices</h3>
      <ol style="font-size:13px;line-height:1.8;margin-left:20px;color:var(--text)">
        <li>Click <strong>‚¨á Export JSON</strong> on Device A</li>
        <li>Save the JSON file to OneDrive, SharePoint, or email it to yourself</li>
        <li>Open the task board on Device B</li>
        <li>Click <strong>‚¨Ü Import JSON</strong> and select the file</li>
        <li>Your tasks, columns, formatting rules, and logo are now on Device B!</li>
      </ol>

      <h3 style="font-size:14px;font-weight:600;margin-bottom:10px;margin-top:24px">üíæ What Gets Exported/Imported</h3>
      <ul style="font-size:13px;line-height:1.8;margin-left:20px;color:var(--text)">
        <li>‚úÖ All task data (title, status, dates, progress, product, project type, etc.)</li>
        <li>‚úÖ All projects (with objectives, KPIs, dates, PIC, 3DEXP, etc.)</li>
        <li>‚úÖ Custom columns and their data</li>
        <li>‚úÖ Conditional formatting rules</li>
        <li>‚úÖ Company logo</li>
        <li>‚úÖ Board title</li>
        <li>‚úÖ Last modified timestamp for each task</li>
        <li>‚ùå Filters (these reset when you reload)</li>
        <li>‚ùå Sort settings (these reset when you reload)</li>
      </ul>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('info-modal')">Got it!</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê PROJECT MODAL ‚ïê‚ïê -->
<div class="modal-overlay" id="project-modal" onclick="closeOverlay(event,'project-modal')">
  <div class="modal" style="max-width:700px">
    <div class="modal-header">
      <h2 id="project-modal-title">Add Project</h2>
      <button class="btn btn-ghost btn-sm" onclick="closeModal('project-modal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group full"><label>Project Name *</label><input type="text" id="pf-name" placeholder="Enter project name" /></div>
      
      <div class="form-row">
        <div class="form-group"><label>Start Date</label><input type="date" id="pf-startDate" /></div>
        <div class="form-group"><label>End Date</label><input type="date" id="pf-endDate" /></div>
      </div>

      <div class="form-group full"><label>Objectives</label><textarea id="pf-objectives" placeholder="Project objectives and goals" style="min-height:70px"></textarea></div>
      <div class="form-group full"><label>KPIs</label><textarea id="pf-kpis" placeholder="Key Performance Indicators" style="min-height:70px"></textarea></div>

      <div class="form-row">
        <div class="form-group"><label>PIC (Person in Charge)</label><input type="text" id="pf-pic" placeholder="Name" /></div>
        <div class="form-group">
          <label>Project on 3DEXP</label>
          <div style="display:flex;gap:6px;align-items:center;margin-bottom:6px">
            <button type="button" id="pf-3dexp-type-text" class="btn btn-sm btn-secondary" style="font-size:11px;padding:3px 10px" onclick="setPF3DEXPType('text')">üìù Text</button>
            <button type="button" id="pf-3dexp-type-link" class="btn btn-sm btn-secondary" style="font-size:11px;padding:3px 10px" onclick="setPF3DEXPType('link')">üîó Link</button>
          </div>
          <input type="text" id="pf-project3DEXP" placeholder="3DEXPERIENCE project reference" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group"><label>Stage</label>
          <select id="pf-stage">
            <option>Planning</option><option>Execution</option><option>Testing</option><option>Deployment</option><option>Maintenance</option>
          </select>
        </div>
        <div class="form-group"><label>Type</label><input type="text" id="pf-type" placeholder="e.g., Development, Research" /></div>
      </div>

      <div class="form-row">
        <div class="form-group"><label>Platform</label><input type="text" id="pf-platform" placeholder="e.g., Web, Mobile, Desktop" /></div>
        <div class="form-group"><label>Priority</label>
          <select id="pf-priority">
            <option>Medium</option><option>High</option><option>Low</option>
          </select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('project-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveProject()">Save Project</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONSTANTS & STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SK='team_tasks_v3', LK='team_tasks_logo', CK='team_tasks_custom_cols', CFG='team_tasks_config', PK='team_tasks_projects';
const CHART_COLORS=['#3b82f6','#8b5cf6','#ec4899','#14b8a6','#f97316','#06b6d4','#84cc16','#ef4444','#f59e0b','#10b981'];
const STATUS_COLORS={'To Do':'#a8a09a','In Progress':'#f59e0b','In Review':'#6366f1','Done':'#10b981','Blocked':'#ef4444'};
const PRIO_COLORS={'High':'#ef4444','Medium':'#f59e0b','Low':'#10b981'};

// Project-related dropdowns
const PROJECT_TYPES=['New Development','Sole Supplier or Alternative','Localization','Standardization','Process Improvement','Mechanical Design','Electrical Design','VAVE','Others'];
const PRODUCTS=['STAND FAN','VENTALIATION FAN','CEILING FAN','AIR CONDITIONER','WASHING MACHINE','Fridge','COMPRESSOR','OTHERS'];
const PROJECT_PHASES=['CP','T0','T1','T2','PR','PP','MP'];

function od(d){const dt=new Date();dt.setDate(dt.getDate()+d);return dt.toISOString().slice(0,10);}

const SAMPLE_PROJECTS=[
  {id:1,name:'Stand Fan Development',startDate:'2025-01-15',endDate:'2025-06-30',objectives:'Develop new energy-efficient stand fan model with smart features',kpis:'Cost reduction 15%, Energy efficiency +20%, Market launch Q2',pic:'Ahmed Hassan',project3DEXP:'SF-2025-001',project3DEXPType:'text',stage:'Execution',type:'New Development',platform:'Hardware',priority:'High'},
  {id:2,name:'AC Compressor Localization',startDate:'2025-02-01',endDate:'2025-08-31',objectives:'Localize compressor production to reduce import costs',kpis:'Local content 70%, Cost saving $2M annually',pic:'Sarah Mohamed',project3DEXP:'AC-COMP-2025',project3DEXPType:'text',stage:'Planning',type:'Localization',platform:'Manufacturing',priority:'High'},
  {id:3,name:'Washing Machine UI Redesign',startDate:'2024-12-01',endDate:'2025-04-15',objectives:'Modernize control panel and add mobile app integration',kpis:'User satisfaction +30%, App downloads 50K',pic:'Omar Ali',project3DEXP:'WM-UI-2024',project3DEXPType:'text',stage:'Testing',type:'Process Improvement',platform:'Mobile/Hardware',priority:'Medium'},
  {id:4,name:'Fridge Energy Optimization',startDate:'2025-01-10',endDate:'2025-07-20',objectives:'Improve energy rating from B to A++ through design optimization',kpis:'Energy consumption -25%, Certification A++',pic:'Layla Ibrahim',project3DEXP:'FRDG-ENR-2025',project3DEXPType:'text',stage:'Execution',type:'VAVE',platform:'Hardware',priority:'High'},
  {id:5,name:'Ceiling Fan Export Model',startDate:'2025-03-01',endDate:'2025-09-30',objectives:'Develop export-ready ceiling fan for GCC markets',kpis:'Export sales $5M, Market entry 3 countries',pic:'Mohamed Salah',project3DEXP:'CF-EXP-2025',project3DEXPType:'text',stage:'Planning',type:'New Development',platform:'Hardware',priority:'Medium'},
];

const SAMPLE=[
  {id:1,title:'Design new landing page',desc:'Wireframes and mockups',project:'Stand Fan Development',assignee:'Sara K.',status:'In Progress',priority:'High',dueDate:od(3),progress:45,notes:'',deps:[],customData:{},task3DEXP:'SF-TASK-001',projectType:'',product:'',projectPhase:'',lastModified:Date.now()},
  {id:2,title:'Fix login bug on Safari',desc:'Token expiry issue',project:'Washing Machine UI Redesign',assignee:'Ahmed R.',status:'To Do',priority:'High',dueDate:od(-1),progress:0,notes:'Reproduced on iOS 17',deps:[],customData:{},task3DEXP:'WM-TASK-005',projectType:'',product:'',projectPhase:'',lastModified:Date.now()},
  {id:3,title:'Q2 budget report',desc:'',project:'AC Compressor Localization',assignee:'Layla M.',status:'Done',priority:'Medium',dueDate:od(-7),progress:100,notes:'',deps:[],customData:{},task3DEXP:'AC-TASK-012',projectType:'',product:'',projectPhase:'',lastModified:Date.now()},
  {id:4,title:'Update API docs',desc:'Add v3 endpoints',project:'Washing Machine UI Redesign',assignee:'Ahmed R.',status:'In Review',priority:'Medium',dueDate:od(5),progress:80,notes:'',deps:[2],customData:{},task3DEXP:'WM-TASK-006',projectType:'',product:'',projectPhase:'',lastModified:Date.now()},
  {id:5,title:'Onboard new contractors',desc:'',project:'Fridge Energy Optimization',assignee:'Sara K.',status:'Blocked',priority:'High',dueDate:od(1),progress:20,notes:'Waiting on IT access',deps:[3],customData:{},task3DEXP:'FRDG-TASK-003',projectType:'',product:'',projectPhase:'',lastModified:Date.now()},
  {id:6,title:'Write social media plan',desc:'For May‚ÄìJuly',project:'Ceiling Fan Export Model',assignee:'Omar T.',status:'To Do',priority:'Low',dueDate:od(10),progress:0,notes:'',deps:[],customData:{},task3DEXP:'CF-TASK-008',projectType:'',product:'',projectPhase:'',lastModified:Date.now()},
];

let tasks=[],nextId=1,editingId=null,sortCol='id',sortDir=1,customCols=[],chartInst={},selColType='text',cfRules=[],appConfig={};
let projects=[],nextProjectId=1,editingProjectId=null,projectSortCol='name',projectSortDir=1;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOAD / SAVE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadAll(){
  try{const r=localStorage.getItem(SK);if(r){const d=JSON.parse(r);tasks=d.tasks||[];nextId=d.nextId||(tasks.length?Math.max(...tasks.map(t=>t.id))+1:1);}else{tasks=SAMPLE;nextId=10;saveAll();}}catch{tasks=SAMPLE;nextId=10;}
  try{customCols=JSON.parse(localStorage.getItem(CK))||[];}catch{customCols=[];}
  try{cfRules=JSON.parse(localStorage.getItem('team_tasks_cf_rules'))||[];}catch{cfRules=[];}
  try{appConfig=JSON.parse(localStorage.getItem(CFG))||{};}catch{appConfig={};}
  try{const pr=localStorage.getItem(PK);if(pr){const pd=JSON.parse(pr);projects=pd.projects||[];nextProjectId=pd.nextProjectId||(projects.length?Math.max(...projects.map(p=>p.id))+1:1);}else{projects=SAMPLE_PROJECTS;nextProjectId=10;saveProjects();}}catch{projects=SAMPLE_PROJECTS;nextProjectId=10;}
  const logo=localStorage.getItem(LK);
  if(logo){const img=document.getElementById('logo-img');img.src=logo;img.classList.add('loaded');document.getElementById('logo-default').style.display='none';}
  restoreConfig();
}
function saveAll(){
  tasks.forEach(t=>{if(!t.lastModified)t.lastModified=Date.now();});
  localStorage.setItem(SK,JSON.stringify({tasks,nextId}));
}
function saveProjects(){
  localStorage.setItem(PK,JSON.stringify({projects,nextProjectId}));
}
function saveCols(){localStorage.setItem(CK,JSON.stringify(customCols));}
function saveCFRules(){localStorage.setItem('team_tasks_cf_rules',JSON.stringify(cfRules));}
function saveConfig(){
  appConfig.filters={
    search:document.getElementById('search').value,
    status:document.getElementById('filter-status').value,
    priority:document.getElementById('filter-priority').value,
    assignee:document.getElementById('filter-assignee').value,
    project:document.getElementById('filter-project').value,
    dateFrom:document.getElementById('filter-date-from').value,
    dateTo:document.getElementById('filter-date-to').value
  };
  appConfig.lastSelectedTask=editingId;
  localStorage.setItem(CFG,JSON.stringify(appConfig));
}
function restoreConfig(){
  if(!appConfig.filters)return;
  const f=appConfig.filters;
  if(f.search)document.getElementById('search').value=f.search;
  if(f.status)document.getElementById('filter-status').value=f.status;
  if(f.priority)document.getElementById('filter-priority').value=f.priority;
  if(f.assignee)document.getElementById('filter-assignee').value=f.assignee;
  if(f.project)document.getElementById('filter-project').value=f.project;
  if(f.dateFrom)document.getElementById('filter-date-from').value=f.dateFrom;
  if(f.dateTo)document.getElementById('filter-date-to').value=f.dateTo;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WEEK BADGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderWeekBadge(){
  const now=new Date(),day=now.getDay(),diff=(day===0?-6:1)-day;
  const mon=new Date(now);mon.setDate(now.getDate()+diff);
  const sun=new Date(mon);sun.setDate(mon.getDate()+6);
  const soy=new Date(now.getFullYear(),0,1);
  const wk=Math.ceil(((mon-soy)/86400000+soy.getDay()+1)/7);
  const fmt=d=>`${d.getDate()} ${['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][d.getMonth()]}`;
  document.getElementById('week-badge').innerHTML=
    `<span class="wk-num">Week ${wk}</span><span class="wk-sep">¬∑</span><span class="wk-range">${fmt(mon)} ‚Äì ${fmt(sun)} ${sun.getFullYear()}</span>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleLogoUpload(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();r.onload=ev=>{
    const src=ev.target.result;localStorage.setItem(LK,src);
    const img=document.getElementById('logo-img');img.src=src;img.classList.add('loaded');
    document.getElementById('logo-default').style.display='none';
  };r.readAsDataURL(f);e.target.value='';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TABLE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SC={'To Do':'tag-todo','In Progress':'tag-inprogress','In Review':'tag-review','Done':'tag-done','Blocked':'tag-blocked'};
const PC={'High':'tag-high','Medium':'tag-medium','Low':'tag-low'};

function getFiltered(){
  const s=document.getElementById('search').value.toLowerCase();
  const fS=document.getElementById('filter-status').value;
  const fP=document.getElementById('filter-priority').value;
  const fA=document.getElementById('filter-assignee').value;
  const fPr=document.getElementById('filter-project').value;
  const fDateFrom=document.getElementById('filter-date-from').value;
  const fDateTo=document.getElementById('filter-date-to').value;
  return tasks.filter(t=>{
    if(s&&![t.title,t.desc,t.assignee,t.project,t.notes].join(' ').toLowerCase().includes(s))return false;
    if(fS&&t.status!==fS)return false;if(fP&&t.priority!==fP)return false;
    if(fA&&t.assignee!==fA)return false;if(fPr&&t.project!==fPr)return false;
    if(fDateFrom&&t.dueDate&&t.dueDate<fDateFrom)return false;
    if(fDateTo&&t.dueDate&&t.dueDate>fDateTo)return false;
    return true;
  });
}
function getSorted(arr){
  return[...arr].sort((a,b)=>{
    let av=a[sortCol]??'',bv=b[sortCol]??'';
    if(sortCol==='id')return(av-bv)*sortDir;
    if(sortCol==='dueDate')return(av<bv?-1:av>bv?1:0)*sortDir;
    return av.toString().localeCompare(bv.toString())*sortDir;
  });
}

function renderTable(){
  renderCustomColHeaders();
  const tbody=document.getElementById('task-tbody');
  const filtered=getSorted(getFiltered());
  updateStats();updateFilterDropdowns();updateSortIcons();saveConfig();
  if(!filtered.length){
    tbody.innerHTML=`<tr><td colspan="${14+customCols.length}"><div class="no-results"><div class="icon">üîç</div>No tasks match your filters.</div></td></tr>`;
    return;
  }
  const today=new Date().toISOString().slice(0,10),soon=od(3);
  tbody.innerHTML=filtered.map(t=>{
    const isDone=t.status==='Done',isOv=t.dueDate&&t.dueDate<today&&!isDone,isSoon=t.dueDate&&t.dueDate>=today&&t.dueDate<=soon&&!isDone;
    const cfClass=getCFClass(t);
    const init=t.assignee?t.assignee.split(' ').map(x=>x[0]).join('').slice(0,2).toUpperCase():'?';
    const ac=strColor(t.assignee||'');
    const prog=Math.min(100,Math.max(0,parseInt(t.progress)||0));
    const customTds=customCols.map(col=>{
      const val=(t.customData||{})[col.key]||'';
      if(col.type==='select'){
        const opts=(col.options||[]);
        return `<td class="td-custom"><select class="inline-edit" onchange="updateCustomField(${t.id},'${col.key}',this.value)"><option value="">‚Äî</option>${opts.map(o=>`<option${val===o?' selected':''}>${e(o)}</option>`).join('')}</select></td>`;
      }
      return `<td class="td-custom"><input class="inline-edit" type="${col.type==='number'?'number':col.type==='date'?'date':'text'}" value="${e(val)}" placeholder="‚Äî" onblur="updateCustomField(${t.id},'${col.key}',this.value)" /></td>`;
    }).join('');
    return `<tr class="${isDone?'row-done':''} ${cfClass}" data-id="${t.id}">
      <td style="font-family:'DM Mono',monospace;font-size:11px;color:var(--text-light)">#${String(t.id).padStart(3,'0')}</td>
      <td class="task-name"><span class="task-title" title="${e(t.title)}">${e(t.title)}</span>${t.desc?`<span class="task-desc">${e(t.desc)}</span>`:''}</td>
      <td><span style="font-size:12px;color:var(--text-muted)">${e(t.project||'‚Äî')}</span></td>
      <td>${t.assignee?`<span class="assignee-chip"><span class="assignee-avatar" style="background:${ac}">${init}</span>${e(t.assignee)}</span>`:'<span style="color:var(--text-light)">‚Äî</span>'}</td>
      <td><span class="tag ${SC[t.status]||'tag-todo'}">${e(t.status)}</span></td>
      <td><span class="tag ${PC[t.priority]||'tag-medium'}">${e(t.priority)}</span></td>
      <td>${t.dueDate?`<span class="due-date ${isOv?'due-overdue':isSoon?'due-soon':''}">${isOv?'‚ö† ':''}${fmtDate(t.dueDate)}</span>`:'<span style="color:var(--text-light)">‚Äî</span>'}</td>
      <td><div style="display:flex;align-items:center;gap:7px"><div class="progress-bar"><div class="progress-fill" style="width:${prog}%"></div></div><span style="font-size:11px;font-family:'DM Mono',monospace;color:var(--text-muted);min-width:28px">${prog}%</span></div></td>
      <td>${depChips(t)}</td>
      <td>${t.task3DEXP ? (t.task3DEXP.match(/^https?:\/\//i) ? `<a href="${e(t.task3DEXP)}" target="_blank" rel="noopener noreferrer" class="dexp-link" title="${e(t.task3DEXP)}">${e(t.task3DEXP)}</a>` : `<a href="${e(t.task3DEXP)}" target="_blank" rel="noopener noreferrer" class="dexp-link" title="${e(t.task3DEXP)}">${e(t.task3DEXP)}</a>`) : '<span style="color:var(--text-light)">‚Äî</span>'}</td>
      <td><select class="inline-edit" onchange="updateTaskField(${t.id},'projectType',this.value)"><option value="">‚Äî</option>${PROJECT_TYPES.map(pt=>`<option${(t.projectType||'')=== pt?' selected':''}>${e(pt)}</option>`).join('')}</select></td>
      <td><select class="inline-edit" onchange="updateTaskField(${t.id},'product',this.value)"><option value="">‚Äî</option>${PRODUCTS.map(p=>`<option${(t.product||'')=== p?' selected':''}>${e(p)}</option>`).join('')}</select></td>
      <td><select class="inline-edit" onchange="updateTaskField(${t.id},'projectPhase',this.value)"><option value="">‚Äî</option>${PROJECT_PHASES.map(ph=>`<option${(t.projectPhase||'')=== ph?' selected':''}>${e(ph)}</option>`).join('')}</select></td>
      ${customTds}
      <td></td>
      <td><div class="actions"><button class="btn btn-secondary btn-sm" onclick="openModal(${t.id})">‚úè</button><button class="btn btn-danger btn-sm" onclick="deleteTask(${t.id})">üóë</button></div></td>
    </tr>`;
  }).join('');
}

function renderCustomColHeaders(){
  const hr=document.getElementById('table-head-row');
  hr.querySelectorAll('.col-custom').forEach(th=>th.remove());
  const ths=[...hr.querySelectorAll('th')];
  const addTh=ths[ths.length-2];
  const icons={'text':'üìù','number':'üî¢','date':'üìÖ','select':'üîΩ'};
  customCols.forEach(col=>{
    const th=document.createElement('th');th.className='col-custom';
    th.innerHTML=`${icons[col.type]||'üìù'} ${e(col.name)} <button class="btn btn-xs btn-danger" style="margin-left:4px" onclick="removeCustomCol('${col.key}');event.stopPropagation()">‚úï</button>`;
    hr.insertBefore(th,addTh);
  });
}

function updateCustomField(id,key,val){
  const t=tasks.find(x=>x.id===id);if(!t)return;
  if(!t.customData)t.customData={};t.customData[key]=val;
  t.lastModified=Date.now();
  saveAll();
}

function updateTaskField(id,field,val){
  const t=tasks.find(x=>x.id===id);if(!t)return;
  t[field]=val;
  t.lastModified=Date.now();
  saveAll();
}

// Deps
function depChips(t){
  const deps=t.deps||[];if(!deps.length)return'<span style="color:var(--text-light);font-size:11px">‚Äî</span>';
  return`<div class="dep-chips">${deps.map(id=>{
    const dep=tasks.find(x=>x.id===id);
    if(!dep)return`<span class="dep-chip dep-open" onclick="highlightTask(${id})">‚ö† #${String(id).padStart(3,'0')}</span>`;
    const cls=dep.status==='Done'?'dep-done':dep.status==='Blocked'?'dep-blocked':'dep-open';
    const ic=dep.status==='Done'?'‚úì':dep.status==='Blocked'?'‚õî':'‚è≥';
    return`<span class="dep-chip ${cls}" title="${e(dep.title)}" onclick="highlightTask(${id})">${ic} #${String(id).padStart(3,'0')}</span>`;
  }).join('')}</div>`;
}
function highlightTask(id){
  clearFilters();
  setTimeout(()=>{const row=document.querySelector(`tr[data-id="${id}"]`);if(!row)return;
    row.classList.add('row-highlighted');row.scrollIntoView({behavior:'smooth',block:'center'});
    setTimeout(()=>row.classList.remove('row-highlighted'),2500);},100);
}

// Stats
function updateStats(){
  const bar=document.getElementById('stats-bar');
  const counts={};tasks.forEach(t=>{counts[t.status]=(counts[t.status]||0)+1;});
  const fS=document.getElementById('filter-status').value;
  const statuses=['To Do','In Progress','In Review','Done','Blocked'];
  bar.innerHTML=`<span class="stat-pill ${!fS?'active':''}" onclick="setStatusFilter('')" style="font-weight:600"><span class="count">${tasks.length}</span> Total</span>`
    +statuses.map(s=>`<span class="stat-pill ${fS===s?'active':''}" onclick="setStatusFilter('${s}')"><span class="dot" style="background:${STATUS_COLORS[s]}"></span><span class="count">${counts[s]||0}</span> ${s}</span>`).join('');
}
function setStatusFilter(v){document.getElementById('filter-status').value=v;renderTable();}
function updateFilterDropdowns(){
  const assignees=[...new Set(tasks.map(t=>t.assignee).filter(Boolean))].sort();
  const projects=[...new Set(tasks.map(t=>t.project).filter(Boolean))].sort();
  const fa=document.getElementById('filter-assignee'),fp=document.getElementById('filter-project');
  const ca=fa.value,cp=fp.value;
  fa.innerHTML=`<option value="">All Assignees</option>`+assignees.map(a=>`<option value="${e(a)}">${e(a)}</option>`).join('');
  fp.innerHTML=`<option value="">All Projects</option>`+projects.map(p=>`<option value="${e(p)}">${e(p)}</option>`).join('');
  fa.value=ca;fp.value=cp;
  document.getElementById('assignee-list').innerHTML=assignees.map(a=>`<option value="${e(a)}">`).join('');
}
function updateSortIcons(){
  ['id','title','project','assignee','status','priority','dueDate'].forEach(col=>{
    const el=document.getElementById('sort-'+col);if(!el)return;
    const th=el.parentElement;
    if(col===sortCol){el.textContent=sortDir===1?'‚Üë':'‚Üì';th.classList.add('sorted');}
    else{el.textContent='‚Üï';th.classList.remove('sorted');}
  });
}
function sortBy(col){if(sortCol===col)sortDir*=-1;else{sortCol=col;sortDir=1;}renderTable();}
function clearFilters(){
  document.getElementById('search').value='';
  ['filter-status','filter-priority','filter-assignee','filter-project','filter-date-from','filter-date-to'].forEach(id=>document.getElementById(id).value='');
  renderTable();
}

function showLastWeekModified(){
  clearFilters();
  const oneWeekAgo=Date.now()-(7*24*60*60*1000);
  const lastWeekTasks=tasks.filter(t=>t.lastModified && t.lastModified>=oneWeekAgo);
  if(!lastWeekTasks.length){
    alert('No tasks modified in the last 7 days.');
    return;
  }
  // Store filtered IDs temporarily
  const ids=lastWeekTasks.map(t=>t.id);
  // Highlight these tasks
  setTimeout(()=>{
    ids.forEach(id=>{
      const row=document.querySelector(`tr[data-id="${id}"]`);
      if(row)row.classList.add('row-highlighted');
    });
  },100);
  alert(`Found ${lastWeekTasks.length} task(s) modified in the last 7 days (highlighted in yellow).`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CRUD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id=null){
  editingId=id;document.getElementById('modal-title').textContent=id?'Edit Task':'Add Task';
  const t=id?tasks.find(x=>x.id===id):null;
  document.getElementById('f-title').value=t?.title||'';document.getElementById('f-desc').value=t?.desc||'';
  
  // Update project dropdown first
  updateProjectDropdown();
  document.getElementById('f-project').value=t?.project||'';
  
  document.getElementById('f-assignee').value=t?.assignee||'';
  document.getElementById('f-status').value=t?.status||'To Do';document.getElementById('f-priority').value=t?.priority||'Medium';
  document.getElementById('f-due').value=t?.dueDate||'';document.getElementById('f-progress').value=t?.progress??0;
  document.getElementById('f-notes').value=t?.notes||'';
  // New fields
  document.getElementById('f-task3DEXP').value=t?.task3DEXP||'';
  document.getElementById('f-projectType').innerHTML='<option value="">‚Äî</option>'+PROJECT_TYPES.map(pt=>`<option${(t?.projectType||'')=== pt?' selected':''}>${e(pt)}</option>`).join('');
  document.getElementById('f-product').innerHTML='<option value="">‚Äî</option>'+PRODUCTS.map(p=>`<option${(t?.product||'')=== p?' selected':''}>${e(p)}</option>`).join('');
  document.getElementById('f-projectPhase').innerHTML='<option value="">‚Äî</option>'+PROJECT_PHASES.map(ph=>`<option${(t?.projectPhase||'')=== ph?' selected':''}>${e(ph)}</option>`).join('');
  // deps
  const deps=t?.deps||[],others=tasks.filter(x=>x.id!==(id||-1));
  const sel=document.getElementById('dep-selector');
  sel.innerHTML=!others.length?'<span style="color:var(--text-light);font-size:12px;padding:4px">No other tasks yet</span>':
    others.map(x=>`<label class="dep-option"><input type="checkbox" value="${x.id}"${deps.includes(x.id)?' checked':''}/><span class="dep-opt-id">#${String(x.id).padStart(3,'0')}</span><span class="dep-opt-title">${e(x.title)}</span><span class="tag ${SC[x.status]||'tag-todo'}" style="font-size:10px;padding:2px 6px">${e(x.status)}</span></label>`).join('');
  // custom fields
  const cfw=document.getElementById('custom-fields-wrap');
  const icons={'text':'üìù','number':'üî¢','date':'üìÖ','select':'üîΩ'};
  cfw.innerHTML=customCols.map(col=>{
    const val=(t?.customData||{})[col.key]||'';
    const inp=col.type==='select'
      ?`<select id="cf-${col.key}" style="font-family:inherit;font-size:13px;border:1px solid var(--border-strong);border-radius:8px;padding:9px 12px;background:var(--bg);color:var(--text);outline:none;width:100%"><option value="">‚Äî</option>${(col.options||[]).map(o=>`<option${val===o?' selected':''}>${e(o)}</option>`).join('')}</select>`
      :`<input id="cf-${col.key}" type="${col.type==='number'?'number':col.type==='date'?'date':'text'}" value="${e(val)}" style="font-family:inherit;font-size:13px;border:1px solid var(--border-strong);border-radius:8px;padding:9px 12px;background:var(--bg);color:var(--text);outline:none;width:100%" />`;
    return`<div class="form-group"><label>${icons[col.type]||'üìù'} ${e(col.name)}</label>${inp}</div>`;
  }).join('');
  updateFilterDropdowns();
  document.getElementById('modal-overlay').classList.add('open');
  setTimeout(()=>document.getElementById('f-title').focus(),100);
}
function saveTask(){
  const title=document.getElementById('f-title').value.trim();
  if(!title){document.getElementById('f-title').focus();document.getElementById('f-title').style.borderColor='var(--accent)';return;}
  document.getElementById('f-title').style.borderColor='';
  
  const project=document.getElementById('f-project').value.trim();
  if(!project){
    alert('Please select a project.\n\nIf no projects are available, go to the Projects tab and create one first.');
    document.getElementById('f-project').focus();
    document.getElementById('f-project').style.borderColor='var(--accent)';
    return;
  }
  document.getElementById('f-project').style.borderColor='';
  
  const customData={};customCols.forEach(col=>{const el=document.getElementById('cf-'+col.key);if(el)customData[col.key]=el.value;});
  const task={id:editingId||nextId++,title,desc:document.getElementById('f-desc').value.trim(),
    project,assignee:document.getElementById('f-assignee').value.trim(),
    status:document.getElementById('f-status').value,priority:document.getElementById('f-priority').value,
    dueDate:document.getElementById('f-due').value,progress:parseInt(document.getElementById('f-progress').value)||0,
    notes:document.getElementById('f-notes').value.trim(),
    deps:[...document.querySelectorAll('#dep-selector input[type=checkbox]:checked')].map(cb=>parseInt(cb.value)),
    task3DEXP:document.getElementById('f-task3DEXP').value.trim(),
    projectType:document.getElementById('f-projectType').value,
    product:document.getElementById('f-product').value,
    projectPhase:document.getElementById('f-projectPhase').value,
    lastModified:Date.now(),
    customData};
  if(editingId){const i=tasks.findIndex(t=>t.id===editingId);if(i!==-1)tasks[i]=task;}else tasks.push(task);
  saveAll();closeModal('modal-overlay');renderTable();
}
function deleteTask(id){if(!confirm('Delete this task?'))return;tasks=tasks.filter(t=>t.id!==id);saveAll();renderTable();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CUSTOM COLUMNS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function selectColType(btn){
  document.querySelectorAll('.col-type-btn').forEach(b=>b.classList.remove('selected'));btn.classList.add('selected');selColType=btn.dataset.type;
  document.getElementById('select-options-group').style.display=selColType==='select'?'flex':'none';
}
function openAddColModal(){
  renderColsList();document.getElementById('new-col-name').value='';document.getElementById('new-col-options').value='';
  document.querySelectorAll('.col-type-btn').forEach(b=>b.classList.remove('selected'));
  document.querySelector('.col-type-btn[data-type="text"]').classList.add('selected');selColType='text';
  document.getElementById('select-options-group').style.display='none';
  document.getElementById('addcol-modal').classList.add('open');
}
function renderColsList(){
  const list=document.getElementById('custom-cols-list');
  const icons={'text':'üìù','number':'üî¢','date':'üìÖ','select':'üîΩ'};
  list.innerHTML=!customCols.length?'<span style="color:var(--text-light);font-size:12px;padding:4px">No custom columns yet</span>':
    customCols.map(col=>`<div class="custom-col-item"><span class="col-icon">${icons[col.type]||'üìù'}</span><span class="col-name">${e(col.name)}</span><span class="col-type-tag">${col.type}</span><button class="btn btn-danger btn-xs" onclick="removeCustomCol('${col.key}')">Remove</button></div>`).join('');
}
function addCustomColumn(){
  const name=document.getElementById('new-col-name').value.trim();
  if(!name){document.getElementById('new-col-name').focus();document.getElementById('new-col-name').style.borderColor='var(--accent)';return;}
  document.getElementById('new-col-name').style.borderColor='';
  const col={key:'col_'+Date.now(),name,type:selColType};
  if(selColType==='select')col.options=document.getElementById('new-col-options').value.split(',').map(s=>s.trim()).filter(Boolean);
  customCols.push(col);saveCols();renderColsList();renderTable();document.getElementById('new-col-name').value='';
}
function removeCustomCol(key){
  if(!confirm('Remove this column? Data will be lost.'))return;
  customCols=customCols.filter(c=>c.key!==key);saveCols();renderColsList();renderTable();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CHARTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openChartModal(){
  // Populate filter dropdowns
  const products=[...new Set(tasks.map(t=>t.product).filter(Boolean))].sort();
  const projectTypes=[...new Set(tasks.map(t=>t.projectType).filter(Boolean))].sort();
  
  const productFilter=document.getElementById('stats-filter-product');
  const projectTypeFilter=document.getElementById('stats-filter-project-type');
  
  productFilter.innerHTML='<option value="">All Products</option>'+
    products.map(p=>`<option value="${e(p)}">${e(p)}</option>`).join('');
  
  projectTypeFilter.innerHTML='<option value="">All Project Types</option>'+
    projectTypes.map(pt=>`<option value="${e(pt)}">${e(pt)}</option>`).join('');
  
  updateChartTotal();
  document.getElementById('chart-modal').classList.add('open');
  setTimeout(buildAllCharts,60);
}

function getFilteredTasksForCharts(){
  const productFilter=document.getElementById('stats-filter-product')?.value||'';
  const projectTypeFilter=document.getElementById('stats-filter-project-type')?.value||'';
  
  return tasks.filter(t=>{
    const matchProduct=!productFilter||t.product===productFilter;
    const matchProjectType=!projectTypeFilter||t.projectType===projectTypeFilter;
    return matchProduct&&matchProjectType;
  });
}

function updateChartTotal(){
  const filtered=getFilteredTasksForCharts();
  document.getElementById('chart-total').textContent=filtered.length;
}

function refreshCharts(){
  updateChartTotal();
  buildAllCharts();
}

function clearStatsFilters(){
  document.getElementById('stats-filter-product').value='';
  document.getElementById('stats-filter-project-type').value='';
  refreshCharts();
}

function openInfoModal(){
  document.getElementById('info-modal').classList.add('open');
}
function switchTab(id,idx){
  document.querySelectorAll('.chart-panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.chart-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.chart-tab')[idx].classList.add('active');
}
function destroyChart(id){if(chartInst[id]){chartInst[id].destroy();delete chartInst[id];}}

function buildAllCharts(){buildPersonChart();buildStatusChart();buildPriorityChart();buildProgressChart();}

function buildPersonChart(){
  destroyChart('cp');
  const filteredTasks=getFilteredTasksForCharts();
  const assignees=[...new Set(filteredTasks.map(t=>t.assignee).filter(Boolean))].sort();
  if(!assignees.length)return;
  const sts=['To Do','In Progress','In Review','Done','Blocked'];
  const datasets=sts.map(s=>({label:s,data:assignees.map(a=>filteredTasks.filter(t=>t.assignee===a&&t.status===s).length),backgroundColor:STATUS_COLORS[s]+'cc',borderColor:STATUS_COLORS[s],borderWidth:1,borderRadius:4}));
  const ctx=document.getElementById('chart-person').getContext('2d');
  chartInst['cp']=new Chart(ctx,{type:'bar',data:{labels:assignees,datasets},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{boxWidth:12,font:{size:11}}}},scales:{x:{stacked:true,grid:{display:false}},y:{stacked:true,ticks:{stepSize:1},grid:{color:'#f0ede8'}}}}});
  const cards=document.getElementById('person-cards');
  cards.innerHTML=assignees.map((a,i)=>{
    const mt=filteredTasks.filter(t=>t.assignee===a);const color=CHART_COLORS[i%CHART_COLORS.length];
    const init=a.split(' ').map(x=>x[0]).join('').slice(0,2).toUpperCase();
    const maxCnt=Math.max(...sts.map(s=>mt.filter(t=>t.status===s).length),1);
    const bars=sts.filter(s=>mt.filter(t=>t.status===s).length>0).map(s=>{const cnt=mt.filter(t=>t.status===s).length;
      return`<div class="mini-bar-row"><span class="mini-bar-label">${s}</span><div class="mini-bar-track"><div class="mini-bar-fill" style="width:${(cnt/maxCnt)*100}%;background:${STATUS_COLORS[s]}"></div></div><span class="mini-bar-num">${cnt}</span></div>`;}).join('');
    return`<div class="person-card"><div class="person-card-top"><div class="person-card-avatar" style="background:${color}">${init}</div><div><div class="person-card-name">${e(a)}</div><div class="person-card-count">${mt.length} task${mt.length!==1?'s':''}</div></div></div><div class="mini-bars">${bars}</div></div>`;
  }).join('');
}

function buildStatusChart(){
  destroyChart('cs');
  const filteredTasks=getFilteredTasksForCharts();
  const sts=['To Do','In Progress','In Review','Done','Blocked'];
  const sClrs=['#a8a09a','#f59e0b','#6366f1','#10b981','#ef4444'];
  const counts=sts.map(s=>filteredTasks.filter(t=>t.status===s).length);
  const ctx=document.getElementById('chart-status').getContext('2d');
  chartInst['cs']=new Chart(ctx,{type:'doughnut',data:{labels:sts,datasets:[{data:counts,backgroundColor:sClrs.map(c=>c+'cc'),borderColor:sClrs,borderWidth:2,hoverOffset:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},cutout:'62%'}});
  document.getElementById('status-legend').innerHTML=sts.map((s,i)=>`<div style="display:flex;align-items:center;gap:8px;margin-bottom:10px"><span style="width:12px;height:12px;border-radius:3px;background:${sClrs[i]};flex-shrink:0"></span><span style="font-size:13px;flex:1">${s}</span><span style="font-family:'DM Mono',monospace;font-size:14px;font-weight:700">${counts[i]}</span></div>`).join('');
}

function buildPriorityChart(){
  destroyChart('cpr');
  const filteredTasks=getFilteredTasksForCharts();
  const assignees=[...new Set(filteredTasks.map(t=>t.assignee).filter(Boolean))].sort();if(!assignees.length)return;
  const datasets=['High','Medium','Low'].map(p=>({label:p,data:assignees.map(a=>filteredTasks.filter(t=>t.assignee===a&&t.priority===p).length),backgroundColor:PRIO_COLORS[p]+'bb',borderColor:PRIO_COLORS[p],borderWidth:1,borderRadius:4}));
  const ctx=document.getElementById('chart-priority').getContext('2d');
  chartInst['cpr']=new Chart(ctx,{type:'bar',data:{labels:assignees,datasets},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{boxWidth:12,font:{size:11}}}},scales:{x:{grid:{display:false}},y:{ticks:{stepSize:1},grid:{color:'#f0ede8'}}}}});
}

function buildProgressChart(){
  destroyChart('cpg');
  const filteredTasks=getFilteredTasksForCharts();
  const assignees=[...new Set(filteredTasks.map(t=>t.assignee).filter(Boolean))].sort();if(!assignees.length)return;
  const avg=assignees.map(a=>{const mt=filteredTasks.filter(t=>t.assignee===a);return mt.length?Math.round(mt.reduce((s,t)=>s+(t.progress||0),0)/mt.length):0;});
  const ctx=document.getElementById('chart-progress').getContext('2d');
  chartInst['cpg']=new Chart(ctx,{type:'bar',data:{labels:assignees,datasets:[{label:'Avg. Progress %',data:avg,backgroundColor:CHART_COLORS.map(c=>c+'bb'),borderColor:CHART_COLORS,borderWidth:1,borderRadius:6}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{legend:{display:false}},scales:{x:{min:0,max:100,grid:{color:'#f0ede8'},ticks:{callback:v=>v+'%'}},y:{grid:{display:false}}}}});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CSV ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê JSON EXPORT/IMPORT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportJSON(){
  const exportData={
    version:'4.0',
    exportDate:new Date().toISOString(),
    boardTitle:document.getElementById('board-title').textContent,
    tasks:tasks,
    projects:projects,
    customCols:customCols,
    cfRules:cfRules,
    workingHours:whHours,
    workingHoursSubmitted:whSubmitted,
    sampleLots:sampleLots,
    nextLotId:nextLotId,
    logo:localStorage.getItem(LK)||null
  };
  const json=JSON.stringify(exportData,null,2);
  const blob=new Blob([json],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='team-tasks-'+new Date().toISOString().slice(0,10)+'.json';
  a.click();
  URL.revokeObjectURL(a.href);
}

// ‚îÄ‚îÄ Export All as Excel ‚îÄ‚îÄ
function exportAllExcel() {
  if (typeof XLSX === 'undefined') { alert('Export library not loaded.'); return; }

  const wb = XLSX.utils.book_new();
  const today = new Date().toISOString().slice(0, 10);
  const boardTitle = document.getElementById('board-title').textContent || 'Team Board';

  // ‚îÄ‚îÄ helper: auto-width columns ‚îÄ‚îÄ
  function autoWidth(ws, data) {
    const colWidths = [];
    data.forEach(row => {
      row.forEach((cell, i) => {
        const len = cell == null ? 8 : String(cell).length;
        colWidths[i] = Math.max(colWidths[i] || 8, Math.min(len + 2, 50));
      });
    });
    ws['!cols'] = colWidths.map(w => ({ wch: w }));
  }

  // ‚îÄ‚îÄ helper: style header row ‚îÄ‚îÄ
  function styleHeader(ws, ncols) {
    for (let c = 0; c < ncols; c++) {
      const addr = XLSX.utils.encode_cell({ r: 0, c });
      if (!ws[addr]) continue;
      ws[addr].s = {
        font: { bold: true, color: { rgb: 'FFFFFF' }, sz: 11 },
        fill: { fgColor: { rgb: '3B5BDB' } },
        alignment: { horizontal: 'center', vertical: 'center', wrapText: true },
        border: { bottom: { style: 'thin', color: { rgb: 'FFFFFF' } } }
      };
    }
    ws['!rows'] = [{ hpt: 22 }];
  }

  // ‚ïê‚ïê Sheet 1: Summary ‚ïê‚ïê
  const summaryData = [
    ['Team Task Board ‚Äî Full Export'],
    ['Generated', today],
    ['Board Title', boardTitle],
    [''],
    ['Module', 'Count'],
    ['Tasks', tasks.length],
    ['Projects', projects.length],
    ['Sample Lots', sampleLots.length],
    ['Working Hours Records', Object.keys(whHours).length],
    [''],
    ['Tasks by Status'],
    ...['To Do','In Progress','In Review','Done','Blocked'].map(s => [s, tasks.filter(t => t.status === s).length]),
    [''],
    ['Tasks by Priority'],
    ...['High','Medium','Low'].map(p => [p, tasks.filter(t => t.priority === p).length]),
    [''],
    ['Projects by Stage'],
    ...['Planning','Execution','Testing','Deployment','Maintenance'].map(s => [s, projects.filter(p => p.stage === s).length]),
  ];
  const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
  wsSummary['!cols'] = [{ wch: 28 }, { wch: 18 }];
  XLSX.utils.book_append_sheet(wb, wsSummary, 'üìã Summary');

  // ‚ïê‚ïê Sheet 2: Tasks ‚ïê‚ïê
  const taskCols = ['#','Title','Project','Assignee','Status','Priority','Due Date','Progress %','Depends On','Task on 3DEXP','Project Type','Product','Project Phase'];
  const customColHeaders = customCols.map(c => c.label);
  const allTaskHeaders = [...taskCols, ...customColHeaders, 'Created', 'Last Modified', 'Notes'];

  const taskRows = [allTaskHeaders, ...tasks.map(t => [
    t.id, t.title, t.project||'', t.assignee||'', t.status||'', t.priority||'',
    t.dueDate||'', t.progress||0, (t.dependsOn||[]).join(', '), t.task3DEXP||'',
    t.projectType||'', t.product||'', t.projectPhase||'',
    ...customCols.map(c => t[c.key]||''),
    t.createdAt ? new Date(t.createdAt).toLocaleDateString() : '',
    t.lastModified ? new Date(t.lastModified).toLocaleDateString() : '',
    t.notes||''
  ])];
  const wsTasks = XLSX.utils.aoa_to_sheet(taskRows);
  autoWidth(wsTasks, taskRows);
  styleHeader(wsTasks, allTaskHeaders.length);
  // Colour-code status cells (col E = index 4)
  tasks.forEach((t, i) => {
    const addr = XLSX.utils.encode_cell({ r: i + 1, c: 4 });
    if (!wsTasks[addr]) return;
    const colours = { 'Done':'D1FAE5','In Progress':'DBEAFE','Blocked':'FEE2E2','In Review':'FEF3C7','To Do':'F3F4F6' };
    if (colours[t.status]) wsTasks[addr].s = { fill: { fgColor: { rgb: colours[t.status] } } };
  });
  XLSX.utils.book_append_sheet(wb, wsTasks, '‚úÖ Tasks');

  // ‚ïê‚ïê Sheet 3: Projects ‚ïê‚ïê
  const projHeaders = ['#','Name','Code','Stage','Priority','Start Date','End Date','Budget','3DEXP','Owner','Description','Tasks Count','Done Tasks'];
  const projRows = [projHeaders, ...projects.map((p, i) => {
    const linked = tasks.filter(t => t.project === p.name);
    return [
      i+1, p.name||'', p.code||'', p.stage||'', p.priority||'',
      p.startDate||'', p.endDate||'', p.budget||'',
      p.project3DEXP||'', p.owner||'', p.description||'',
      linked.length, linked.filter(t => t.status==='Done').length
    ];
  })];
  const wsProjects = XLSX.utils.aoa_to_sheet(projRows);
  autoWidth(wsProjects, projRows);
  styleHeader(wsProjects, projHeaders.length);
  XLSX.utils.book_append_sheet(wb, wsProjects, 'üìÅ Projects');

  // ‚ïê‚ïê Sheet 4: Working Hours ‚ïê‚ïê
  const whHeaders = ['Employee','Week','Mon','Tue','Wed','Thu','Fri','Sat','Sun','Total Hours','Status'];
  const whRows = [whHeaders];
  const allKeys = Object.keys(whHours);
  allKeys.forEach(key => {
    const [emp, week] = key.split('||');
    const hrs = whHours[key] || {};
    const days = ['mon','tue','wed','thu','fri','sat','sun'];
    const dayVals = days.map(d => parseFloat(hrs[d]||0)||0);
    const total = dayVals.reduce((s,v)=>s+v,0);
    const submitted = whSubmitted && whSubmitted[key];
    whRows.push([emp||'', week||'', ...dayVals, total, submitted ? 'Submitted' : 'Draft']);
  });
  const wsWH = XLSX.utils.aoa_to_sheet(whRows);
  autoWidth(wsWH, whRows);
  styleHeader(wsWH, whHeaders.length);
  // Bold total column
  for (let r = 1; r < whRows.length; r++) {
    const addr = XLSX.utils.encode_cell({ r, c: 9 });
    if (wsWH[addr]) wsWH[addr].s = { font: { bold: true }, numFmt: '0.0' };
  }
  XLSX.utils.book_append_sheet(wb, wsWH, '‚è± Working Hours');

  // ‚ïê‚ïê Sheet 5: Sample Lots ‚ïê‚ïê
  const slHeaders = ['Lot #','Project','Phase','Qty','Prod. Date','Delivery Date','Price','Purpose','Status','Request Teams','Qty per Team'];
  const slRows = [slHeaders, ...sampleLots.map(s => {
    const teamStr = (s.teams||[]).map(t => t.name + (t.received?' ‚úì':'')).join(', ');
    const qtyStr = (s.teams||[]).map(t => t.name + ': ' + (t.qtyDelivered||'‚Äî')).join(', ');
    const overdue = s.dateDelivery && new Date(s.dateDelivery) < new Date() && !((s.teams||[]).every(t=>t.received));
    const status = (s.teams||[]).length===0 ? 'Pending' : (s.teams||[]).every(t=>t.received) ? 'Delivered' : overdue ? 'Overdue' : 'Partial';
    return [
      s.lotNumber||'', s.project||'', s.phase||'', s.qty||'',
      s.dateProd||'', s.dateDelivery||'', s.price||'',
      s.purpose||'', status, teamStr, qtyStr
    ];
  })];
  const wsSL = XLSX.utils.aoa_to_sheet(slRows);
  autoWidth(wsSL, slRows);
  styleHeader(wsSL, slHeaders.length);
  XLSX.utils.book_append_sheet(wb, wsSL, 'üß™ Sample Lots');

  // ‚ïê‚ïê Sheet 6: Tasks by Assignee ‚ïê‚ïê
  const assignees = [...new Set(tasks.map(t => t.assignee).filter(Boolean))].sort();
  const byAssigneeHeaders = ['Assignee','Total Tasks','To Do','In Progress','In Review','Done','Blocked','Avg Progress %','High Priority','Overdue'];
  const byAssigneeRows = [byAssigneeHeaders, ...assignees.map(a => {
    const myTasks = tasks.filter(t => t.assignee === a);
    const overdue = myTasks.filter(t => t.dueDate && new Date(t.dueDate) < new Date() && t.status !== 'Done').length;
    const avgProg = myTasks.length ? Math.round(myTasks.reduce((s,t)=>s+(t.progress||0),0)/myTasks.length) : 0;
    return [
      a, myTasks.length,
      myTasks.filter(t=>t.status==='To Do').length,
      myTasks.filter(t=>t.status==='In Progress').length,
      myTasks.filter(t=>t.status==='In Review').length,
      myTasks.filter(t=>t.status==='Done').length,
      myTasks.filter(t=>t.status==='Blocked').length,
      avgProg + '%',
      myTasks.filter(t=>t.priority==='High').length,
      overdue
    ];
  })];
  const wsBA = XLSX.utils.aoa_to_sheet(byAssigneeRows);
  autoWidth(wsBA, byAssigneeRows);
  styleHeader(wsBA, byAssigneeHeaders.length);
  XLSX.utils.book_append_sheet(wb, wsBA, 'üë• By Assignee');

  // ‚ïê‚ïê Sheet 7: Tasks by Project ‚ïê‚ïê
  const projNames = [...new Set(tasks.map(t=>t.project).filter(Boolean))].sort();
  const byProjHeaders = ['Project','Total Tasks','Done','In Progress','To Do','Blocked','Completion %'];
  const byProjRows = [byProjHeaders, ...projNames.map(pn => {
    const myT = tasks.filter(t => t.project === pn);
    const done = myT.filter(t=>t.status==='Done').length;
    return [pn, myT.length, done, myT.filter(t=>t.status==='In Progress').length,
      myT.filter(t=>t.status==='To Do').length, myT.filter(t=>t.status==='Blocked').length,
      myT.length ? Math.round(done/myT.length*100)+'%' : '0%'];
  })];
  const wsBP = XLSX.utils.aoa_to_sheet(byProjRows);
  autoWidth(wsBP, byProjRows);
  styleHeader(wsBP, byProjHeaders.length);
  XLSX.utils.book_append_sheet(wb, wsBP, 'üìä By Project');

  // ‚ïê‚ïê Write File ‚ïê‚ïê
  XLSX.writeFile(wb, `team-board-full-export-${today}.xlsx`);
}

function importJSON(){
  document.getElementById('json-input').click();
}

function handleJSONImport(e){
  const f=e.target.files[0];
  if(!f)return;
  
  const r=new FileReader();
  r.onload=ev=>{
    try{
      const importData=JSON.parse(ev.target.result);
      
      // Validate the data
      if(!importData.tasks||!Array.isArray(importData.tasks)){
        alert('Invalid JSON file format.');
        return;
      }
      
      const taskCount=importData.tasks.length;
      const projectCount=(importData.projects||[]).length;
      const hasCustomCols=importData.customCols&&importData.customCols.length>0;
      const hasCFRules=importData.cfRules&&importData.cfRules.length>0;
      
      const lotCount=(importData.sampleLots||[]).length;
      let confirmMsg=`Import ${taskCount} task${taskCount!==1?'s':''}?`;
      if(projectCount)confirmMsg+=`\n‚Ä¢ ${projectCount} project${projectCount!==1?'s':''}`;
      if(hasCustomCols)confirmMsg+=`\n‚Ä¢ ${importData.customCols.length} custom column${importData.customCols.length!==1?'s':''}`;
      if(hasCFRules)confirmMsg+=`\n‚Ä¢ ${importData.cfRules.length} formatting rule${importData.cfRules.length!==1?'s':''}`;
      if(lotCount)confirmMsg+=`\n‚Ä¢ ${lotCount} sample lot${lotCount!==1?'s':''}`;
      const hasWH=importData.workingHours&&Object.keys(importData.workingHours).length>0;
      if(hasWH)confirmMsg+=`\n‚Ä¢ Working hours data`;
      confirmMsg+='\n\nThis will replace all current data.';
      
      if(confirm(confirmMsg)){
        // Import all data
        tasks=importData.tasks||[];
        projects=importData.projects||[];
        customCols=importData.customCols||[];
        cfRules=importData.cfRules||[];
        
        if(importData.boardTitle){
          document.getElementById('board-title').textContent=importData.boardTitle;
        }
        
        if(importData.logo){
          localStorage.setItem('companyLogo',importData.logo);
          loadLogo();
        }
        
        // Update nextId
        nextId=tasks.length>0?Math.max(...tasks.map(t=>t.id))+1:1;
        nextProjectId=projects.length>0?Math.max(...projects.map(p=>p.id))+1:1;
        
        // Save everything
        saveAll();
        saveProjects();
        saveCols();
        if(importData.workingHours){whHours=importData.workingHours;whSubmitted=importData.workingHoursSubmitted||{};whSaveData();}
        if(importData.sampleLots){sampleLots=importData.sampleLots;nextLotId=importData.nextLotId||(sampleLots.length?Math.max(...sampleLots.map(l=>l.id))+1:1);slSaveData();}
        
        // Re-render
        renderTable();
        renderProjectsTable();
        updateProjectDropdown();
        
        let doneMsg=`‚úÖ Successfully imported!\n‚Ä¢ ${taskCount} tasks\n‚Ä¢ ${projectCount} projects\n‚Ä¢ ${customCols.length} custom columns\n‚Ä¢ ${cfRules.length} formatting rules`;
        if(lotCount)doneMsg+=`\n‚Ä¢ ${lotCount} sample lots`;
        if(hasWH)doneMsg+=`\n‚Ä¢ Working hours data`;
        alert(doneMsg);
      }
    }catch(err){
      console.error(err);
      alert('Error reading JSON file. Please check the file format.');
    }
  };
  r.readAsText(f);
  e.target.value='';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONDITIONAL FORMATTING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openCFModal(){
  renderCFRules();
  document.getElementById('cf-modal').classList.add('open');
}

function renderCFRules(){
  const list=document.getElementById('cf-rules-list');
  if(!cfRules.length){
    list.innerHTML='<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:12px">No custom rules yet. Use presets or add a custom rule.</div>';
    return;
  }
  list.innerHTML=cfRules.map((rule,i)=>{
    const previewBg=getPreviewBg(rule);
    return`<div class="cf-rule-item">
      <div class="cf-rule-header">
        <div class="cf-rule-toggle ${rule.enabled?'active':''}" onclick="toggleCFRule(${i})">
          <div class="cf-rule-toggle-knob"></div>
        </div>
        <div class="cf-rule-name">${e(rule.name)}</div>
        <div class="cf-rule-preview" style="background:${previewBg}"></div>
        <button class="btn btn-ghost btn-xs" onclick="deleteCFRule(${i})">üóëÔ∏è</button>
      </div>
      <div class="cf-rule-condition">
        <select onchange="updateCFRule(${i},'field',this.value)" class="inline-edit">
          <option value="status" ${rule.field==='status'?'selected':''}>Status</option>
          <option value="priority" ${rule.field==='priority'?'selected':''}>Priority</option>
          <option value="progress" ${rule.field==='progress'?'selected':''}>Progress</option>
          <option value="dueDate" ${rule.field==='dueDate'?'selected':''}>Due Date</option>
          <option value="assignee" ${rule.field==='assignee'?'selected':''}>Assignee</option>
        </select>
        <select onchange="updateCFRule(${i},'operator',this.value)" class="inline-edit">
          <option value="equals" ${rule.operator==='equals'?'selected':''}>Equals</option>
          <option value="contains" ${rule.operator==='contains'?'selected':''}>Contains</option>
          <option value="greater" ${rule.operator==='greater'?'selected':''}>Greater than</option>
          <option value="less" ${rule.operator==='less'?'selected':''}>Less than</option>
          <option value="overdue" ${rule.operator==='overdue'?'selected':''}>Is overdue</option>
        </select>
        <input type="text" class="inline-edit" value="${e(rule.value||'')}" 
          onchange="updateCFRule(${i},'value',this.value)" 
          placeholder="Value" ${rule.operator==='overdue'?'disabled':''}>
      </div>
    </div>`;
  }).join('');
}

function addCFRule(){
  cfRules.push({
    name:'Custom Rule '+(cfRules.length+1),
    enabled:true,
    field:'status',
    operator:'equals',
    value:'',
    style:'cf-custom-1'
  });
  renderCFRules();
}

function addPresetRule(type){
  const presets={
    'overdue':{name:'Overdue Tasks',field:'dueDate',operator:'overdue',value:'',style:'cf-overdue'},
    'high-priority':{name:'High Priority',field:'priority',operator:'equals',value:'High',style:'cf-high-priority'},
    'blocked':{name:'Blocked Tasks',field:'status',operator:'equals',value:'Blocked',style:'cf-blocked'},
    'almost-done':{name:'Almost Done',field:'progress',operator:'greater',value:'80',style:'cf-almost-done'}
  };
  const preset=presets[type];
  if(!preset)return;
  // Check if rule already exists
  const exists=cfRules.find(r=>r.name===preset.name);
  if(exists){
    alert('This preset rule already exists!');
    return;
  }
  cfRules.push({...preset,enabled:true});
  renderCFRules();
  saveCFRules();
}

function toggleCFRule(i){
  cfRules[i].enabled=!cfRules[i].enabled;
  renderCFRules();
  saveCFRules();
}

function updateCFRule(i,field,value){
  cfRules[i][field]=value;
  saveCFRules();
}

function deleteCFRule(i){
  if(confirm('Delete this rule?')){
    cfRules.splice(i,1);
    renderCFRules();
    saveCFRules();
  }
}

function applyCFRules(){
  saveCFRules();
  renderTable();
  closeModal('cf-modal');
}

function getPreviewBg(rule){
  const colors={
    'cf-overdue':'#fee2e2',
    'cf-high-priority':'#fef3c7',
    'cf-blocked':'linear-gradient(90deg, #dc2626 4px, #fee2e2 4px)',
    'cf-almost-done':'#dcfce7',
    'cf-stale':'#f3f4f6',
    'cf-custom-1':'linear-gradient(90deg, #f59e0b 4px, #fef3c7 4px)',
    'cf-custom-2':'linear-gradient(90deg, #3b82f6 4px, #dbeafe 4px)',
    'cf-custom-3':'linear-gradient(90deg, #c026d3 4px, #fae8ff 4px)'
  };
  return colors[rule.style]||'#f3f4f6';
}

function checkCFRule(task,rule){
  if(!rule.enabled)return false;
  const{field,operator,value}=rule;
  const taskVal=task[field];
  
  switch(operator){
    case'equals':return String(taskVal).toLowerCase()===String(value).toLowerCase();
    case'contains':return String(taskVal).toLowerCase().includes(String(value).toLowerCase());
    case'greater':return parseFloat(taskVal)>parseFloat(value);
    case'less':return parseFloat(taskVal)<parseFloat(value);
    case'overdue':
      if(!task.dueDate)return false;
      const due=new Date(task.dueDate);
      const today=new Date();
      today.setHours(0,0,0,0);
      return due<today && task.status!=='Done';
    default:return false;
  }
}

function getCFClass(task){
  // Return first matching rule class
  for(const rule of cfRules){
    if(checkCFRule(task,rule)){
      return rule.style;
    }
  }
  return'';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROJECTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchMainTab(tab){
  document.querySelectorAll('.tabs .tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById(tab+'-tab').classList.add('active');
  if(tab==='projects')renderProjectsTable();
  if(tab==='tasks'){renderTable();updateFilterDropdowns();}
  if(tab==='statistics')renderStatistics();
  if(tab==='workinghours'){whLoadData();whLoadWorkdays();whGoCurrentWeek();setTimeout(whSetExportCurrentMonth,50);}
  if(tab==='samples'){slLoadData();slRender();}
  if(tab==='verification'){vfRender();}
  if(tab==='tools'){toolsInit();}
}

function openProjectModal(id=null){
  editingProjectId=id;
  document.getElementById('project-modal-title').textContent=id?'Edit Project':'Add Project';
  const p=id?projects.find(x=>x.id===id):null;
  document.getElementById('pf-name').value=p?.name||'';
  document.getElementById('pf-startDate').value=p?.startDate||'';
  document.getElementById('pf-endDate').value=p?.endDate||'';
  document.getElementById('pf-objectives').value=p?.objectives||'';
  document.getElementById('pf-kpis').value=p?.kpis||'';
  document.getElementById('pf-pic').value=p?.pic||'';
  document.getElementById('pf-project3DEXP').value=p?.project3DEXP||'';
  setPF3DEXPType(p?.project3DEXPType||'text');
  document.getElementById('pf-stage').value=p?.stage||'Planning';
  document.getElementById('pf-type').value=p?.type||'';
  document.getElementById('pf-platform').value=p?.platform||'';
  document.getElementById('pf-priority').value=p?.priority||'Medium';
  document.getElementById('project-modal').classList.add('open');
}

function setPF3DEXPType(type){
  const btnText=document.getElementById('pf-3dexp-type-text');
  const btnLink=document.getElementById('pf-3dexp-type-link');
  const inp=document.getElementById('pf-project3DEXP');
  if(!btnText||!btnLink)return;
  if(type==='link'){
    btnLink.classList.remove('btn-secondary');btnLink.classList.add('btn-blue');
    btnText.classList.remove('btn-blue');btnText.classList.add('btn-secondary');
    inp.placeholder='https://3dexperience.com/‚Ä¶';
  } else {
    btnText.classList.remove('btn-secondary');btnText.classList.add('btn-blue');
    btnLink.classList.remove('btn-blue');btnLink.classList.add('btn-secondary');
    inp.placeholder='3DEXPERIENCE project reference';
  }
}

function saveProject(){
  const name=document.getElementById('pf-name').value.trim();
  if(!name){alert('Please enter a project name');return;}
  const project={
    id:editingProjectId||nextProjectId++,
    name,
    startDate:document.getElementById('pf-startDate').value,
    endDate:document.getElementById('pf-endDate').value,
    objectives:document.getElementById('pf-objectives').value,
    kpis:document.getElementById('pf-kpis').value,
    pic:document.getElementById('pf-pic').value,
    project3DEXP:document.getElementById('pf-project3DEXP').value,
    project3DEXPType:document.getElementById('pf-3dexp-type-link')?.classList.contains('btn-blue')?'link':'text',
    stage:document.getElementById('pf-stage').value,
    type:document.getElementById('pf-type').value,
    platform:document.getElementById('pf-platform').value,
    priority:document.getElementById('pf-priority').value
  };
  if(editingProjectId){
    const idx=projects.findIndex(p=>p.id===editingProjectId);
    if(idx!==-1)projects[idx]=project;
  }else{
    projects.push(project);
  }
  saveProjects();
  renderProjectsTable();
  updateProjectDropdown();
  updateFilterDropdowns();
  closeModal('project-modal');
}

function deleteProject(id){
  if(!confirm('Delete this project?\n\nNote: Tasks linked to this project will NOT be deleted, but their project field will still show the old project name.'))return;
  projects=projects.filter(p=>p.id!==id);
  saveProjects();
  renderProjectsTable();
  updateProjectDropdown();
}

function renderProjectsTable(){
  const search=document.getElementById('project-search').value.toLowerCase();
  const fStage=document.getElementById('filter-project-stage').value;
  const fPriority=document.getElementById('filter-project-priority').value;
  
  let filtered=projects.filter(p=>{
    if(search&&![p.name,p.type,p.platform,p.pic].join(' ').toLowerCase().includes(search))return false;
    if(fStage&&p.stage!==fStage)return false;
    if(fPriority&&p.priority!==fPriority)return false;
    return true;
  });
  
  const sorted=[...filtered].sort((a,b)=>{
    let av=a[projectSortCol]??'',bv=b[projectSortCol]??'';
    if(['startDate','endDate'].includes(projectSortCol))return(av<bv?-1:av>bv?1:0)*projectSortDir;
    return av.toString().localeCompare(bv.toString())*projectSortDir;
  });
  
  const tbody=document.getElementById('projects-tbody');
  if(!sorted.length){
    tbody.innerHTML='<tr><td colspan="18" style="text-align:center;padding:60px;color:var(--text-muted)">No projects found</td></tr>';
    return;
  }
  
  const stageTags={'Planning':'tag-todo','Execution':'tag-inprogress','Testing':'tag-review','Deployment':'tag-done','Maintenance':'tag-blocked'};
  
  tbody.innerHTML=sorted.map(p=>{
    // Calculate task statistics for this project
    const projectTasks=tasks.filter(t=>t.project===p.name);
    const total=projectTasks.length;
    const todo=projectTasks.filter(t=>t.status==='To Do').length;
    const inProgress=projectTasks.filter(t=>t.status==='In Progress').length;
    const review=projectTasks.filter(t=>t.status==='In Review').length;
    const done=projectTasks.filter(t=>t.status==='Done').length;
    const blocked=projectTasks.filter(t=>t.status==='Blocked').length;
    const completion=total>0?Math.round((done/total)*100):0;
    
    return`
    <tr>
      <td style="font-weight:500">${e(p.name)}</td>
      <td style="text-align:center;font-family:'DM Mono',monospace;font-weight:600">${total}</td>
      <td style="text-align:center"><span class="tag tag-todo" style="padding:2px 6px;font-size:10px">${todo}</span></td>
      <td style="text-align:center"><span class="tag tag-inprogress" style="padding:2px 6px;font-size:10px">${inProgress}</span></td>
      <td style="text-align:center"><span class="tag tag-review" style="padding:2px 6px;font-size:10px">${review}</span></td>
      <td style="text-align:center"><span class="tag tag-done" style="padding:2px 6px;font-size:10px">${done}</span></td>
      <td style="text-align:center"><span class="tag tag-blocked" style="padding:2px 6px;font-size:10px">${blocked}</span></td>
      <td>
        <div style="display:flex;align-items:center;gap:8px">
          <div style="flex:1;height:6px;background:var(--border);border-radius:100px;overflow:hidden">
            <div style="height:100%;background:${completion===100?'#10b981':completion>=75?'#3b82f6':completion>=50?'#f59e0b':'#ef4444'};width:${completion}%;transition:width .3s"></div>
          </div>
          <span style="font-size:11px;font-family:'DM Mono',monospace;font-weight:600;min-width:35px">${completion}%</span>
        </div>
      </td>
      <td>${fmtDate(p.startDate)}</td>
      <td>${fmtDate(p.endDate)}</td>
      <td style="max-width:150px;font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="${e(p.objectives)}">${e(p.objectives)||'‚Äî'}</td>
      <td style="max-width:150px;font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="${e(p.kpis)}">${e(p.kpis)||'‚Äî'}</td>
      <td>${e(p.pic)||'‚Äî'}</td>
      <td>${p.project3DEXPType==='link'&&p.project3DEXP ? `<a href="${e(p.project3DEXP)}" target="_blank" rel="noopener noreferrer" class="dexp-link" title="${e(p.project3DEXP)}">${e(p.project3DEXP)}</a>` : e(p.project3DEXP)||'‚Äî'}</td>
      <td><span class="tag ${stageTags[p.stage]||'tag-todo'}">${e(p.stage)}</span></td>
      <td>${e(p.type)||'‚Äî'}</td>
      <td>${e(p.platform)||'‚Äî'}</td>
      <td><span class="tag ${PC[p.priority]}">${e(p.priority)}</span></td>
      <td><div class="actions"><button class="btn btn-secondary btn-sm" onclick="openProjectModal(${p.id})">‚úè</button><button class="btn btn-danger btn-sm" onclick="deleteProject(${p.id})">üóë</button></div></td>
    </tr>`;
  }).join('');
  
  updateProjectSortIcons();
}

function sortProjectsBy(col){
  if(projectSortCol===col)projectSortDir*=-1;
  else{projectSortCol=col;projectSortDir=1;}
  renderProjectsTable();
}

function updateProjectSortIcons(){
  ['name','startDate','endDate','pic','project3DEXP','stage','type','platform','priority'].forEach(col=>{
    const el=document.getElementById('psort-'+col);
    if(!el)return;
    const th=el.parentElement;
    if(col===projectSortCol){el.textContent=projectSortDir===1?'‚Üë':'‚Üì';th.classList.add('sorted');}
    else{el.textContent='‚Üï';th.classList.remove('sorted');}
  });
}

function clearProjectFilters(){
  document.getElementById('project-search').value='';
  document.getElementById('filter-project-stage').value='';
  document.getElementById('filter-project-priority').value='';
  renderProjectsTable();
}

function updateProjectDropdown(){
  const select=document.getElementById('f-project');
  if(!select)return;
  const currentVal=select.value;
  select.innerHTML='<option value="">-- Select Project --</option>'+
    projects.map(p=>`<option value="${e(p.name)}">${e(p.name)}</option>`).join('');
  if(currentVal)select.value=currentVal;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATISTICS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderStatistics(){
  // Overall stats
  document.getElementById('stat-total-projects').textContent=projects.length;
  document.getElementById('stat-total-tasks').textContent=tasks.length;
  const doneTasks=tasks.filter(t=>t.status==='Done').length;
  const overallCompletion=tasks.length>0?Math.round((doneTasks/tasks.length)*100):0;
  document.getElementById('stat-overall-completion').textContent=overallCompletion+'%';
  const activeTasks=tasks.filter(t=>t.status==='In Progress'||t.status==='In Review').length;
  document.getElementById('stat-active-tasks').textContent=activeTasks;
  
  // Project Performance
  const perfList=document.getElementById('project-performance-list');
  if(projects.length===0){
    perfList.innerHTML='<div style="color:var(--text-muted);font-size:13px">No projects to display</div>';
  }else{
    const projectStats=projects.map(p=>{
      const projectTasks=tasks.filter(t=>t.project===p.name);
      const total=projectTasks.length;
      const done=projectTasks.filter(t=>t.status==='Done').length;
      const completion=total>0?Math.round((done/total)*100):0;
      return{project:p,total,done,completion};
    }).sort((a,b)=>b.completion-a.completion);
    
    perfList.innerHTML=projectStats.map(ps=>`
      <div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg);border-radius:8px;margin-bottom:8px">
        <div style="flex:1">
          <div style="font-weight:600;font-size:14px;margin-bottom:4px">${e(ps.project.name)}</div>
          <div style="font-size:12px;color:var(--text-muted)">${ps.total} task${ps.total!==1?'s':''} ‚Ä¢ ${ps.done} done</div>
        </div>
        <div style="width:150px">
          <div style="display:flex;align-items:center;gap:8px">
            <div style="flex:1;height:6px;background:var(--border);border-radius:100px;overflow:hidden">
              <div style="height:100%;background:${ps.completion===100?'#10b981':ps.completion>=75?'#3b82f6':ps.completion>=50?'#f59e0b':'#ef4444'};width:${ps.completion}%;transition:width .3s"></div>
            </div>
            <span style="font-size:12px;font-family:'DM Mono',monospace;font-weight:600;min-width:35px">${ps.completion}%</span>
          </div>
        </div>
        <span class="tag ${ps.completion===100?'tag-done':ps.completion>=75?'tag-review':ps.completion>=50?'tag-inprogress':'tag-todo'}" style="font-size:11px">
          ${ps.completion===100?'‚úì Complete':ps.completion>=75?'Almost There':ps.completion>=50?'In Progress':'Getting Started'}
        </span>
      </div>
    `).join('');
  }
  
  // Status Breakdown
  const statusBreakdown=document.getElementById('status-breakdown');
  const statusCounts={
    'To Do':tasks.filter(t=>t.status==='To Do').length,
    'In Progress':tasks.filter(t=>t.status==='In Progress').length,
    'In Review':tasks.filter(t=>t.status==='In Review').length,
    'Done':tasks.filter(t=>t.status==='Done').length,
    'Blocked':tasks.filter(t=>t.status==='Blocked').length
  };
  const statusColors={'To Do':'#a8a09a','In Progress':'#f59e0b','In Review':'#6366f1','Done':'#10b981','Blocked':'#ef4444'};
  
  statusBreakdown.innerHTML=Object.entries(statusCounts).map(([status,count])=>`
    <div style="text-align:center">
      <div style="width:80px;height:80px;border-radius:50%;background:${statusColors[status]}20;border:3px solid ${statusColors[status]};display:flex;align-items:center;justify-content:center;margin:0 auto 8px">
        <div style="font-size:24px;font-weight:700;color:${statusColors[status]}">${count}</div>
      </div>
      <div style="font-size:12px;font-weight:600">${status}</div>
    </div>
  `).join('');
  
  // Recommendations
  const recommendations=[];
  const blockedTasks=tasks.filter(t=>t.status==='Blocked');
  if(blockedTasks.length>0){
    recommendations.push({
      icon:'üö®',
      text:`<strong>${blockedTasks.length} blocked task${blockedTasks.length!==1?'s':''}</strong> need${blockedTasks.length===1?'s':''} attention`,
      action:'Review and unblock these tasks to improve team velocity'
    });
  }
  
  const overdueTasks=tasks.filter(t=>{
    if(!t.dueDate||t.status==='Done')return false;
    const due=new Date(t.dueDate);
    const today=new Date();
    today.setHours(0,0,0,0);
    return due<today;
  });
  if(overdueTasks.length>0){
    recommendations.push({
      icon:'‚è∞',
      text:`<strong>${overdueTasks.length} overdue task${overdueTasks.length!==1?'s':''}</strong> past deadline`,
      action:'Prioritize these tasks or update their due dates'
    });
  }
  
  const lowProgressProjects=projects.filter(p=>{
    const projectTasks=tasks.filter(t=>t.project===p.name);
    const total=projectTasks.length;
    const done=projectTasks.filter(t=>t.status==='Done').length;
    return total>0&&(done/total)<0.25;
  });
  if(lowProgressProjects.length>0){
    recommendations.push({
      icon:'üìâ',
      text:`<strong>${lowProgressProjects.length} project${lowProgressProjects.length!==1?'s':''}</strong> with low completion (<25%)`,
      action:'Consider redistributing resources or revisiting project scope'
    });
  }
  
  const highLoadAssignees=Object.entries(
    tasks.filter(t=>t.status!=='Done'&&t.assignee).reduce((acc,t)=>{
      acc[t.assignee]=(acc[t.assignee]||0)+1;
      return acc;
    },{})
  ).filter(([,count])=>count>=5);
  
  if(highLoadAssignees.length>0){
    recommendations.push({
      icon:'üë§',
      text:`<strong>${highLoadAssignees.length} team member${highLoadAssignees.length!==1?'s':''}</strong> with 5+ active tasks`,
      action:'Consider load balancing to prevent burnout'
    });
  }
  
  if(recommendations.length===0){
    recommendations.push({
      icon:'‚úÖ',
      text:'<strong>Everything looks good!</strong>',
      action:'Keep up the great work. Team is on track.'
    });
  }
  
  document.getElementById('recommendations-list').innerHTML=recommendations.map(r=>`
    <div style="display:flex;gap:12px;padding:12px 0;border-bottom:1px solid #bfdbfe">
      <div style="font-size:24px;flex-shrink:0">${r.icon}</div>
      <div>
        <div style="font-size:14px;color:#1e40af;margin-bottom:4px">${r.text}</div>
        <div style="font-size:12px;color:#3b82f6">${r.action}</div>
      </div>
    </div>
  `).join('');
  
  // Team Workload
  const teamWorkload=Object.entries(
    tasks.filter(t=>t.assignee).reduce((acc,t)=>{
      if(!acc[t.assignee])acc[t.assignee]={total:0,done:0,inProgress:0,blocked:0};
      acc[t.assignee].total++;
      if(t.status==='Done')acc[t.assignee].done++;
      if(t.status==='In Progress')acc[t.assignee].inProgress++;
      if(t.status==='Blocked')acc[t.assignee].blocked++;
      return acc;
    },{})
  ).sort((a,b)=>b[1].total-a[1].total);
  
  const workloadList=document.getElementById('team-workload-list');
  if(teamWorkload.length===0){
    workloadList.innerHTML='<div style="color:var(--text-muted);font-size:13px">No assigned tasks</div>';
  }else{
    workloadList.innerHTML=teamWorkload.map(([name,stats])=>`
      <div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg);border-radius:8px;margin-bottom:8px">
        <div style="width:36px;height:36px;border-radius:50%;background:${strColor(name)};color:#fff;font-size:14px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0">
          ${name.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2)}
        </div>
        <div style="flex:1">
          <div style="font-weight:600;font-size:14px">${e(name)}</div>
          <div style="font-size:12px;color:var(--text-muted)">
            ${stats.total} total ‚Ä¢ ${stats.inProgress} in progress ‚Ä¢ ${stats.done} done
            ${stats.blocked>0?` ‚Ä¢ <span style="color:#ef4444;font-weight:600">${stats.blocked} blocked</span>`:''}
          </div>
        </div>
      </div>
    `).join('');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WORKING HOURS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const WHK = 'team_tasks_working_hours'; // localStorage key
const WH_WD_KEY = 'team_tasks_wh_workdays';
let whHours = {}; // { 'YYYY-Www': { taskId: { 'YYYY-MM-DD': hours } } }
let whSubmitted = {}; // { 'YYYY-Www': true/false }
let whCurrentWeekOffset = 0; // 0 = current week, -1 = last week, etc.
let whWorkdays = [0,1,2,3,4]; // default Sun‚ÄìThu (Egyptian work week)
let whSelectedWeek = null; // for submit panel

function whLoadData() {
  try { whHours = JSON.parse(localStorage.getItem(WHK + '_hours')) || {}; } catch { whHours = {}; }
  try { whSubmitted = JSON.parse(localStorage.getItem(WHK + '_submitted')) || {}; } catch { whSubmitted = {}; }
}
function whSaveData() {
  localStorage.setItem(WHK + '_hours', JSON.stringify(whHours));
  localStorage.setItem(WHK + '_submitted', JSON.stringify(whSubmitted));
}

function whLoadWorkdays() {
  try {
    const saved = JSON.parse(localStorage.getItem(WH_WD_KEY));
    if (Array.isArray(saved) && saved.length) whWorkdays = saved;
  } catch {}
  // Apply checkboxes
  for (let i = 0; i < 7; i++) {
    const cb = document.querySelector(`#wh-day-${i} input`);
    if (cb) cb.checked = whWorkdays.includes(i);
  }
  whUpdateWorkdaysSummary();
}
function whSaveWorkdays() {
  whWorkdays = [];
  for (let i = 0; i < 7; i++) {
    const cb = document.querySelector(`#wh-day-${i} input`);
    if (cb && cb.checked) whWorkdays.push(i);
  }
  localStorage.setItem(WH_WD_KEY, JSON.stringify(whWorkdays));
  whUpdateWorkdaysSummary();
  renderWHEntryPanel();
}
function whUpdateWorkdaysSummary() {
  const names = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const el = document.getElementById('wh-workdays-summary');
  if (!el) return;
  el.textContent = whWorkdays.length
    ? `‚úÖ ${whWorkdays.length} day(s): ${whWorkdays.map(d => names[d]).join(', ')}`
    : '‚ö†Ô∏è No days selected';
}

// Get Monday of week offset from today
function whGetWeekDates(offset) {
  const now = new Date();
  const day = now.getDay(); // 0=Sun
  const diffToMon = day === 0 ? -6 : 1 - day;
  const mon = new Date(now);
  mon.setDate(now.getDate() + diffToMon + offset * 7);
  mon.setHours(0,0,0,0);
  const days = [];
  for (let i = 0; i < 7; i++) {
    const d = new Date(mon);
    d.setDate(mon.getDate() + i);
    days.push(d);
  }
  return days;
}

function whGetWeekKey(days) {
  // ISO week key: YYYY-Www
  const mon = days[0];
  const soy = new Date(mon.getFullYear(), 0, 1);
  const wk = Math.ceil(((mon - soy) / 86400000 + soy.getDay() + 1) / 7);
  return `${mon.getFullYear()}-W${String(wk).padStart(2,'0')}`;
}

function whFmtDay(d) {
  const mn = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return `${d.getDate()} ${mn[d.getMonth()]}`;
}
function whFmtISO(d) {
  return d.toISOString().slice(0,10);
}

function whNavWeek(delta) {
  whCurrentWeekOffset += delta;
  renderWHEntryPanel();
}
function whGoCurrentWeek() {
  whCurrentWeekOffset = 0;
  renderWHEntryPanel();
}

function switchWHTab(tab) {
  document.querySelectorAll('.wh-inner-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.wh-inner-panel').forEach(p => p.classList.remove('active'));
  document.getElementById('wh-panel-' + tab).classList.add('active');
  const tabs = document.querySelectorAll('.wh-inner-tab');
  if (tab === 'entry') tabs[0].classList.add('active');
  else { tabs[1].classList.add('active'); whSetExportCurrentMonth(); renderWHSubmitPanel(); }
}

function renderWHEntryPanel() {
  const allDays = whGetWeekDates(whCurrentWeekOffset);
  // Show ALL 7 days but visually mark non-working ones
  const weekKey = whGetWeekKey(allDays);
  const today = whFmtISO(new Date());
  const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

  // Label - use first/last WORKING day for range display if possible
  const workDays = allDays.filter(d => whWorkdays.includes(d.getDay()));
  const labelFirst = workDays.length ? workDays[0] : allDays[0];
  const labelLast = workDays.length ? workDays[workDays.length-1] : allDays[6];
  document.getElementById('wh-week-label').textContent =
    `Week ${weekKey.split('-W')[1]} ¬∑ ${whFmtDay(labelFirst)} ‚Äì ${whFmtDay(labelLast)} ${labelLast.getFullYear()}`;
  document.getElementById('wh-week-sub').textContent =
    whCurrentWeekOffset === 0 ? 'Current Week' : whCurrentWeekOffset === -1 ? 'Last Week' : whCurrentWeekOffset < 0 ? `${Math.abs(whCurrentWeekOffset)} weeks ago` : `${whCurrentWeekOffset} week(s) ahead`;

  // Build day headers ‚Äî show all 7, dim non-working
  const headRow = document.getElementById('wh-head-row');
  headRow.querySelectorAll('.wh-dh').forEach(th => th.remove());
  const totalTh = headRow.querySelector('.total-col');
  allDays.forEach(d => {
    const iso = whFmtISO(d);
    const isWorkDay = whWorkdays.includes(d.getDay());
    const isTdy = iso === today;
    const th = document.createElement('th');
    th.className = 'day-col wh-dh' + (!isWorkDay ? ' wh-weekend' : '');
    if (!isWorkDay) th.style.cssText = 'opacity:0.35;background:#f5f5f0;';
    th.innerHTML = `<div class="wh-day-header ${isTdy ? 'wh-day-today' : ''}">
      <span class="wh-day-name">${dayNames[d.getDay()]}</span>
      <span class="wh-day-date">${d.getDate()}</span>
      ${!isWorkDay ? '<span style="font-size:9px;display:block;color:#999;margin-top:1px">off</span>' : ''}
    </div>`;
    headRow.insertBefore(th, totalTh);
  });

  // Filter In Progress tasks
  const inProgressTasks = tasks.filter(t => t.status === 'In Progress');
  const tbody = document.getElementById('wh-tbody');

  if (!inProgressTasks.length) {
    tbody.innerHTML = `<tr><td colspan="${3 + 7 + 1}"><div class="wh-no-data">No tasks with status <strong>In Progress</strong>. Add tasks and set them to In Progress first.</div></td></tr>`;
    document.getElementById('wh-week-total').textContent = '0h';
    return;
  }

  const weekData = whHours[weekKey] || {};
  let weekTotal = 0;

  tbody.innerHTML = inProgressTasks.map(t => {
    const taskData = weekData[t.id] || {};
    let rowTotal = 0;
    const project = projects.find(p => p.name === t.project);
    const exp3 = t.task3DEXP || (project ? project.project3DEXP : '') || '‚Äî';

    const dayCells = allDays.map(d => {
      const iso = whFmtISO(d);
      const isWorkDay = whWorkdays.includes(d.getDay());
      const val = taskData[iso] || '';
      if (val) rowTotal += parseFloat(val) || 0;
      if (!isWorkDay) {
        // Off day ‚Äî read-only dim cell, still stores if user typed before
        return `<td class="day-td wh-weekend" style="opacity:0.3;background:#f5f5f0;pointer-events:none;text-align:center;font-size:11px;color:#aaa">‚Äî</td>`;
      }
      return `<td class="day-td">
        <input class="wh-hours-input" type="number" min="0" max="24" step="0.5"
          value="${val}" placeholder="‚Äî"
          data-task="${t.id}" data-date="${iso}"
          oninput="whUpdateCell(this)" />
      </td>`;
    }).join('');

    weekTotal += rowTotal;

    return `<tr>
      <td>
        <div class="wh-project-name" title="${e(t.title)}">${e(t.title)}</div>
        <div style="margin-top:3px"><span class="tag tag-inprogress" style="font-size:10px;padding:2px 6px">In Progress</span></div>
      </td>
      <td><span style="font-size:12px;color:var(--text-muted)">${e(t.project || '‚Äî')}</span></td>
      <td><span class="wh-exp-badge" title="${e(exp3)}">${e(exp3)}</span></td>
      ${dayCells}
      <td class="total-td" id="wh-row-total-${t.id}">${rowTotal ? rowTotal + 'h' : '‚Äî'}</td>
    </tr>`;
  }).join('');

  // Total row
  const totalDayCells = allDays.map(d => {
    const iso = whFmtISO(d);
    const isWorkDay = whWorkdays.includes(d.getDay());
    if (!isWorkDay) {
      return `<td class="day-td wh-weekend" style="opacity:0.3;background:#f5f5f0"></td>`;
    }
    let daySum = 0;
    inProgressTasks.forEach(t => {
      const v = (weekData[t.id] || {})[iso];
      if (v) daySum += parseFloat(v) || 0;
    });
    return `<td class="day-td" style="font-family:'DM Mono',monospace;font-weight:700;color:var(--text);font-size:13px">${daySum ? daySum + 'h' : '‚Äî'}</td>`;
  }).join('');

  tbody.innerHTML += `<tr class="wh-total-row">
    <td colspan="3" style="font-size:12px;color:var(--text-muted)">üìä DAILY TOTALS</td>
    ${totalDayCells}
    <td class="total-td">${weekTotal}h</td>
  </tr>`;

  document.getElementById('wh-week-total').textContent = weekTotal + 'h';
}

function whUpdateCell(input) {
  const taskId = parseInt(input.dataset.task);
  const date = input.dataset.date;
  const val = parseFloat(input.value) || 0;
  const days = whGetWeekDates(whCurrentWeekOffset);
  const weekKey = whGetWeekKey(days);

  if (!whHours[weekKey]) whHours[weekKey] = {};
  if (!whHours[weekKey][taskId]) whHours[weekKey][taskId] = {};
  if (val > 0) {
    whHours[weekKey][taskId][date] = val;
  } else {
    delete whHours[weekKey][taskId][date];
    if (!Object.keys(whHours[weekKey][taskId]).length) delete whHours[weekKey][taskId];
  }

  // Update row total
  const inProgressTasks = tasks.filter(t => t.status === 'In Progress');
  const taskData = whHours[weekKey]?.[taskId] || {};
  const rowTotal = days.reduce((s, d) => s + (parseFloat(taskData[whFmtISO(d)]) || 0), 0);
  const rowTotalEl = document.getElementById('wh-row-total-' + taskId);
  if (rowTotalEl) rowTotalEl.textContent = rowTotal ? rowTotal + 'h' : '‚Äî';

  // Update week total
  let weekTotal = 0;
  inProgressTasks.forEach(t => {
    const td = whHours[weekKey]?.[t.id] || {};
    days.forEach(d => { weekTotal += parseFloat(td[whFmtISO(d)]) || 0; });
  });
  document.getElementById('wh-week-total').textContent = weekTotal + 'h';
}

function whSaveEntry() {
  whSaveData();
  const status = document.getElementById('wh-save-status');
  status.textContent = '‚úÖ Saved at ' + new Date().toLocaleTimeString();
  setTimeout(() => { status.textContent = ''; }, 3000);
}

// ‚îÄ‚îÄ Submit Panel ‚îÄ‚îÄ
function renderWHSubmitPanel() {
  const list = document.getElementById('wh-weeks-list');
  // Get all weeks that have data, sorted most recent first
  const weekKeys = Object.keys(whHours).sort((a, b) => b.localeCompare(a));

  // Also ensure current week appears even if empty
  const nowDays = whGetWeekDates(0);
  const nowKey = whGetWeekKey(nowDays);
  if (!weekKeys.includes(nowKey)) weekKeys.unshift(nowKey);

  if (!weekKeys.length) {
    list.innerHTML = '<div style="color:var(--text-muted);font-size:13px;padding:20px">No working hours logged yet.</div>';
    return;
  }

  list.innerHTML = weekKeys.map(wk => {
    // Reconstruct days from key
    const [yr, wNum] = wk.split('-W');
    const jan1 = new Date(parseInt(yr), 0, 1);
    const dayOfWeek = jan1.getDay() || 7;
    const mondayOfWeek1 = new Date(jan1);
    mondayOfWeek1.setDate(jan1.getDate() + (dayOfWeek <= 4 ? 1 - dayOfWeek : 8 - dayOfWeek));
    const mon = new Date(mondayOfWeek1);
    mon.setDate(mondayOfWeek1.getDate() + (parseInt(wNum) - 1) * 7);
    const sun = new Date(mon); sun.setDate(mon.getDate() + 6);

    const totalHours = Object.values(whHours[wk] || {}).reduce((s, taskDates) =>
      s + Object.values(taskDates).reduce((ts, h) => ts + (parseFloat(h) || 0), 0), 0);
    const submitted = whSubmitted[wk];
    const isSelected = whSelectedWeek === wk;

    return `<div class="wh-week-card${isSelected ? ' selected' : ''}" onclick="whSelectWeek('${wk}')">
      <div style="font-size:22px">${submitted ? '‚úÖ' : 'üïê'}</div>
      <div class="wh-week-card-info">
        <div class="wh-week-card-label">Week ${wNum} ¬∑ ${yr}</div>
        <div class="wh-week-card-range">${whFmtDay(mon)} ‚Äì ${whFmtDay(sun)}</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
        <div class="wh-week-card-total">${totalHours}h</div>
        <span class="wh-submitted-badge ${submitted ? 'done' : 'pending'}">${submitted ? '‚úì Submitted' : '‚è≥ Pending'}</span>
      </div>
    </div>`;
  }).join('');
}

function whSelectWeek(weekKey) {
  whSelectedWeek = weekKey;
  renderWHSubmitPanel();
  renderWHWeekReport(weekKey);
}

function renderWHWeekReport(weekKey) {
  const area = document.getElementById('wh-report-area');
  const [yr, wNum] = weekKey.split('-W');
  const jan1 = new Date(parseInt(yr), 0, 1);
  const dayOfWeek = jan1.getDay() || 7;
  const mondayOfWeek1 = new Date(jan1);
  mondayOfWeek1.setDate(jan1.getDate() + (dayOfWeek <= 4 ? 1 - dayOfWeek : 8 - dayOfWeek));
  const mon = new Date(mondayOfWeek1);
  mon.setDate(mondayOfWeek1.getDate() + (parseInt(wNum) - 1) * 7);
  const sun = new Date(mon); sun.setDate(mon.getDate() + 6);

  const isSubmitted = whSubmitted[weekKey];
  const weekData = whHours[weekKey] || {};
  const totalWeekHours = Object.values(weekData).reduce((s, td) =>
    s + Object.values(td).reduce((ts, h) => ts + (parseFloat(h)||0), 0), 0);

  // Default: current month
  const now = new Date();
  const defaultFrom = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-01`;
  const lastDay = new Date(now.getFullYear(), now.getMonth()+1, 0);
  const defaultTo = whFmtISO(lastDay);

  area.innerHTML = `<div class="wh-report-wrap">
    <div class="wh-report-header">
      <div>
        <div class="wh-report-title">Week ${wNum} ¬∑ ${yr}</div>
        <div style="font-size:12px;color:var(--text-muted)">${whFmtDay(mon)} ‚Äì ${whFmtDay(sun)} ¬∑ <strong style="color:var(--accent2);font-family:'DM Mono',monospace">${totalWeekHours}h</strong> total</div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <span class="wh-submitted-badge ${isSubmitted ? 'done' : 'pending'}" style="font-size:12px;padding:6px 14px">
          ${isSubmitted ? '‚úì Submitted' : '‚è≥ Pending Submission'}
        </span>
        <button class="btn ${isSubmitted ? 'btn-secondary' : 'btn-primary'} btn-sm" onclick="whToggleSubmit('${weekKey}')">
          ${isSubmitted ? '‚Ü© Mark as Not Submitted' : 'üì§ Mark as Submitted'}
        </button>
      </div>
    </div>

    <div class="wh-duration-bar" style="margin-bottom:20px;padding:12px;background:var(--bg);border-radius:8px">
      <label>Duration filter:</label>
      <input type="date" id="wh-from-date" value="${defaultFrom}" onchange="whRefreshReport('${weekKey}')" style="font-family:inherit;font-size:12px;border:1px solid var(--border-strong);border-radius:6px;padding:5px 10px;background:var(--surface);color:var(--text)" />
      <span style="color:var(--text-muted)">to</span>
      <input type="date" id="wh-to-date" value="${defaultTo}" onchange="whRefreshReport('${weekKey}')" style="font-family:inherit;font-size:12px;border:1px solid var(--border-strong);border-radius:6px;padding:5px 10px;background:var(--surface);color:var(--text)" />
      <button class="btn btn-ghost btn-sm" onclick="whResetDuration('${weekKey}')">Reset to Current Month</button>
    </div>

    <div id="wh-report-content"><!-- filled by JS --></div>
  </div>`;

  whRefreshReport(weekKey);
}

function whRefreshReport(weekKey) {
  const fromDate = document.getElementById('wh-from-date')?.value || '';
  const toDate = document.getElementById('wh-to-date')?.value || '';
  const content = document.getElementById('wh-report-content');
  if (!content) return;

  // Gather all hours within the date range across all weeks
  const projectHours = {}; // { projectName: { exp3: str, tasks: { taskId: { title, hours } }, total: 0 } }

  Object.entries(whHours).forEach(([wk, weekData]) => {
    Object.entries(weekData).forEach(([taskId, dateMap]) => {
      const task = tasks.find(t => t.id === parseInt(taskId));
      if (!task) return;
      const proj = task.project || '(No Project)';
      const project = projects.find(p => p.name === proj);
      const exp3 = task.task3DEXP || (project ? project.project3DEXP : '') || '‚Äî';

      Object.entries(dateMap).forEach(([date, hrs]) => {
        if (fromDate && date < fromDate) return;
        if (toDate && date > toDate) return;
        const h = parseFloat(hrs) || 0;
        if (!h) return;
        if (!projectHours[proj]) projectHours[proj] = { exp3, tasks: {}, total: 0 };
        if (!projectHours[proj].tasks[taskId]) projectHours[proj].tasks[taskId] = { title: task.title, hours: 0 };
        projectHours[proj].tasks[taskId].hours += h;
        projectHours[proj].total += h;
      });
    });
  });

  const grandTotal = Object.values(projectHours).reduce((s, p) => s + p.total, 0);

  if (!grandTotal) {
    content.innerHTML = '<div class="wh-no-data">No hours logged in this date range.</div>';
    return;
  }

  const sorted = Object.entries(projectHours).sort((a, b) => b[1].total - a[1].total);

  content.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <div style="font-size:13px;font-weight:600;color:var(--text-muted)">Projects & Hours</div>
      <div style="font-family:'DM Mono',monospace;font-size:16px;font-weight:700;color:var(--accent2)">${grandTotal}h total</div>
    </div>
    ${sorted.map(([projName, projData]) => {
      const pct = grandTotal > 0 ? Math.round((projData.total / grandTotal) * 100) : 0;
      const taskRows = Object.values(projData.tasks).map(t =>
        `<div style="display:flex;align-items:center;gap:8px;padding:4px 0;font-size:12px;color:var(--text-muted)">
          <span style="width:10px;height:10px;border-radius:50%;background:var(--border);flex-shrink:0"></span>
          <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${e(t.title)}</span>
          <span style="font-family:'DM Mono',monospace;font-weight:600;color:var(--text)">${t.hours}h</span>
        </div>`
      ).join('');
      return `<div class="wh-report-project-row" style="flex-direction:column;align-items:stretch">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
          <div style="flex:1">
            <div style="font-weight:600;font-size:14px">${e(projName)}</div>
            <div style="font-size:11px;color:var(--text-muted)"><span class="wh-exp-badge">${e(projData.exp3)}</span></div>
          </div>
          <div style="text-align:right">
            <div style="font-family:'DM Mono',monospace;font-weight:700;font-size:16px;color:var(--accent2)">${projData.total}h</div>
            <div style="font-size:11px;color:var(--text-muted)">${pct}% of total</div>
          </div>
        </div>
        <div class="wh-report-bar-track" style="margin-bottom:8px">
          <div class="wh-report-bar-fill" style="width:${pct}%"></div>
        </div>
        ${taskRows}
      </div>`;
    }).join('')}`;
}

function whResetDuration(weekKey) {
  const now = new Date();
  const defaultFrom = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-01`;
  const lastDay = new Date(now.getFullYear(), now.getMonth()+1, 0);
  document.getElementById('wh-from-date').value = defaultFrom;
  document.getElementById('wh-to-date').value = whFmtISO(lastDay);
  whRefreshReport(weekKey);
}

function whToggleSubmit(weekKey) {
  whSubmitted[weekKey] = !whSubmitted[weekKey];
  whSaveData();
  renderWHSubmitPanel();
  renderWHWeekReport(weekKey);
}

// ‚îÄ‚îÄ Set current month defaults for export date pickers ‚îÄ‚îÄ
function whSetExportCurrentMonth() {
  const now = new Date();
  const y = now.getFullYear(), m = now.getMonth();
  const firstDay = `${y}-${String(m+1).padStart(2,'0')}-01`;
  const lastDay = whFmtISO(new Date(y, m+1, 0));
  const fromEl = document.getElementById('export-from-date');
  const toEl = document.getElementById('export-to-date');
  if (fromEl) fromEl.value = firstDay;
  if (toEl) toEl.value = lastDay;
}

// ‚îÄ‚îÄ Excel Export ‚îÄ‚îÄ
function whExportToExcel() {
  const fromDate = document.getElementById('export-from-date')?.value || '';
  const toDate = document.getElementById('export-to-date')?.value || '';

  if (!fromDate || !toDate) {
    alert('Please select a date range before exporting.');
    return;
  }
  if (fromDate > toDate) {
    alert('Start date must be before end date.');
    return;
  }

  // ‚îÄ‚îÄ Step 1: collect all week keys in range, sorted ascending ‚îÄ‚îÄ
  const allWeekKeys = Object.keys(whHours).sort();

  // Helper: get all Mon‚ÄìSun dates for a weekKey
  function getWeekDaysFromKey(wk) {
    const [yr, wNum] = wk.split('-W');
    const jan1 = new Date(parseInt(yr), 0, 1);
    const dow = jan1.getDay() || 7;
    const mon1 = new Date(jan1);
    mon1.setDate(jan1.getDate() + (dow <= 4 ? 1 - dow : 8 - dow));
    const mon = new Date(mon1);
    mon.setDate(mon1.getDate() + (parseInt(wNum)-1)*7);
    const days = [];
    for (let i = 0; i < 7; i++) {
      const d = new Date(mon); d.setDate(mon.getDate()+i);
      days.push(d);
    }
    return days;
  }

  // Filter week keys that overlap with range
  const weeksInRange = allWeekKeys.filter(wk => {
    const days = getWeekDaysFromKey(wk);
    const wkStart = whFmtISO(days[0]);
    const wkEnd   = whFmtISO(days[6]);
    return wkStart <= toDate && wkEnd >= fromDate;
  });

  // Collect unique dates in range
  const allDatesInRange = [];
  const dateSet = new Set();
  weeksInRange.forEach(wk => {
    getWeekDaysFromKey(wk).forEach(d => {
      const iso = whFmtISO(d);
      if (iso >= fromDate && iso <= toDate && !dateSet.has(iso)) {
        dateSet.add(iso);
        allDatesInRange.push({iso, d});
      }
    });
  });
  allDatesInRange.sort((a,b) => a.iso.localeCompare(b.iso));

  if (!allDatesInRange.length) {
    alert('No dates found in the selected range.');
    return;
  }

  // ‚îÄ‚îÄ Step 2: Collect per-project, per-task, per-date hours ‚îÄ‚îÄ
  // Structure: { projectName: { exp3, tasks: { taskId: { title, exp3task, dates: {iso: h} } } } }
  const projectMap = {};

  Object.entries(whHours).forEach(([wk, weekData]) => {
    Object.entries(weekData).forEach(([taskIdStr, dateMap]) => {
      const taskId = parseInt(taskIdStr);
      const task = tasks.find(t => t.id === taskId);
      if (!task) return;
      const projName = task.project || '(No Project)';
      const project = projects.find(p => p.name === projName);
      const projExp3 = project?.project3DEXP || '‚Äî';
      const taskExp3 = task.task3DEXP || '‚Äî';

      Object.entries(dateMap).forEach(([date, hrs]) => {
        if (date < fromDate || date > toDate) return;
        const h = parseFloat(hrs) || 0;
        if (!h) return;

        if (!projectMap[projName]) projectMap[projName] = { exp3: projExp3, tasks: {} };
        if (!projectMap[projName].tasks[taskIdStr])
          projectMap[projName].tasks[taskIdStr] = { title: task.title, exp3: taskExp3, dates: {} };
        projectMap[projName].tasks[taskIdStr].dates[date] =
          (projectMap[projName].tasks[taskIdStr].dates[date] || 0) + h;
      });
    });
  });

  if (!Object.keys(projectMap).length) {
    alert('No working hours data found in the selected date range.');
    return;
  }

  // ‚îÄ‚îÄ Step 3: Build week columns (group dates by week) ‚îÄ‚îÄ
  // Each week = Mon label (e.g. "Week 12\n10 Mar")
  const weekColMap = {}; // weekKey ‚Üí [isoDate, ...]
  allDatesInRange.forEach(({iso, d}) => {
    // find week key for this date
    const day = d.getDay();
    const diff = day === 0 ? -6 : 1 - day;
    const mon = new Date(d); mon.setDate(d.getDate() + diff);
    const soy = new Date(mon.getFullYear(), 0, 1);
    const wk = Math.ceil(((mon - soy) / 86400000 + soy.getDay() + 1) / 7);
    const wkKey = `${mon.getFullYear()}-W${String(wk).padStart(2,'0')}`;
    if (!weekColMap[wkKey]) weekColMap[wkKey] = [];
    weekColMap[wkKey].push(iso);
  });
  const weekColKeys = Object.keys(weekColMap).sort();

  const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

  // ‚îÄ‚îÄ Step 4: Build XLSX with openpyxl-style using SheetJS ‚îÄ‚îÄ
  const wb = XLSX.utils.book_new();

  // ‚îÄ SHEET 1: Weekly Summary (Project | 3DEXP | Week1 | Week2 | ... | Total) ‚îÄ
  function buildSummarySheet() {
    const aoa = []; // array of arrays

    // Title row
    aoa.push([`Working Hours Report ‚Äî ${fromDate} to ${toDate}`]);
    aoa.push([`Generated: ${new Date().toLocaleString()}`]);
    aoa.push([]);

    // Header row
    const header = ['Project', '3DEXP (Project)', 'Task', '3DEXP (Task)'];
    weekColKeys.forEach(wk => {
      const [yr, wNum] = wk.split('-W');
      const dates = weekColMap[wk];
      const monDate = dates[0]; // first date in this week within range
      const d = new Date(monDate);
      header.push(`Wk ${wNum}\n(${d.getDate()} ${monthNames[d.getMonth()]})`);
    });
    header.push('TOTAL HOURS');
    aoa.push(header);

    // Data rows
    const sortedProjects = Object.entries(projectMap).sort((a,b) => a[0].localeCompare(b[0]));
    sortedProjects.forEach(([projName, projData]) => {
      const sortedTasks = Object.entries(projData.tasks).sort((a,b) => a[1].title.localeCompare(b[1].title));
      sortedTasks.forEach(([taskId, taskData], ti) => {
        const row = [
          ti === 0 ? projName : '',          // Project (only on first task row)
          ti === 0 ? projData.exp3 : '',     // Project 3DEXP
          taskData.title,
          taskData.exp3
        ];
        let rowTotal = 0;
        weekColKeys.forEach(wk => {
          const datesInWk = weekColMap[wk];
          const wkHrs = datesInWk.reduce((s, iso) => s + (taskData.dates[iso] || 0), 0);
          row.push(wkHrs || '');
          rowTotal += wkHrs;
        });
        row.push(rowTotal || '');
        aoa.push(row);
      });

      // Project subtotal row
      const subtotalRow = ['', '', 'SUBTOTAL', ''];
      let projGrandTotal = 0;
      weekColKeys.forEach(wk => {
        const datesInWk = weekColMap[wk];
        const wkSub = Object.values(projData.tasks).reduce((s, t) =>
          s + datesInWk.reduce((ds, iso) => ds + (t.dates[iso] || 0), 0), 0);
        subtotalRow.push(wkSub || '');
        projGrandTotal += wkSub;
      });
      subtotalRow.push(projGrandTotal || '');
      aoa.push(subtotalRow);
      aoa.push([]);
    });

    // Grand total row
    const grandRow = ['GRAND TOTAL', '', '', ''];
    let grandTotal = 0;
    weekColKeys.forEach(wk => {
      const datesInWk = weekColMap[wk];
      const wkGrand = Object.values(projectMap).reduce((s, proj) =>
        s + Object.values(proj.tasks).reduce((ts, t) =>
          ts + datesInWk.reduce((ds, iso) => ds + (t.dates[iso] || 0), 0), 0), 0);
      grandRow.push(wkGrand || '');
      grandTotal += wkGrand;
    });
    grandRow.push(grandTotal || '');
    aoa.push(grandRow);

    const ws = XLSX.utils.aoa_to_sheet(aoa);

    // Column widths
    const wscols = [
      {wch: 30}, {wch: 18}, {wch: 35}, {wch: 18},
      ...weekColKeys.map(() => ({wch: 12})),
      {wch: 14}
    ];
    ws['!cols'] = wscols;

    // Merge title row across all columns
    const totalCols = 4 + weekColKeys.length + 1;
    ws['!merges'] = [
      {s:{r:0,c:0}, e:{r:0,c:totalCols-1}},
      {s:{r:1,c:0}, e:{r:1,c:totalCols-1}}
    ];

    return ws;
  }

  // ‚îÄ SHEET 2: Daily Detail (Project | 3DEXP | Task | Task3DEXP | Date1 | Date2 | ... | Total) ‚îÄ
  function buildDailySheet() {
    const aoa = [];
    aoa.push([`Daily Working Hours ‚Äî ${fromDate} to ${toDate}`]);
    aoa.push([]);

    const header = ['Project', '3DEXP (Project)', 'Task', '3DEXP (Task)'];
    allDatesInRange.forEach(({iso, d}) => {
      header.push(`${dayNames[d.getDay()]}\n${d.getDate()} ${monthNames[d.getMonth()]}`);
    });
    header.push('TOTAL');
    aoa.push(header);

    const sortedProjects = Object.entries(projectMap).sort((a,b) => a[0].localeCompare(b[0]));
    sortedProjects.forEach(([projName, projData]) => {
      const sortedTasks = Object.entries(projData.tasks).sort((a,b) => a[1].title.localeCompare(b[1].title));
      sortedTasks.forEach(([taskId, taskData], ti) => {
        const row = [
          ti === 0 ? projName : '',
          ti === 0 ? projData.exp3 : '',
          taskData.title, taskData.exp3
        ];
        let total = 0;
        allDatesInRange.forEach(({iso}) => {
          const h = taskData.dates[iso] || '';
          row.push(h);
          total += parseFloat(h) || 0;
        });
        row.push(total || '');
        aoa.push(row);
      });

      // Project subtotal
      const sub = ['', '', 'SUBTOTAL', ''];
      let projTotal = 0;
      allDatesInRange.forEach(({iso}) => {
        const s = Object.values(projData.tasks).reduce((a,t) => a + (t.dates[iso]||0), 0);
        sub.push(s || '');
        projTotal += s;
      });
      sub.push(projTotal || '');
      aoa.push(sub);
      aoa.push([]);
    });

    // Grand total
    const grand = ['GRAND TOTAL','','',''];
    let gt = 0;
    allDatesInRange.forEach(({iso}) => {
      const s = Object.values(projectMap).reduce((a,proj) =>
        a + Object.values(proj.tasks).reduce((b,t) => b + (t.dates[iso]||0), 0), 0);
      grand.push(s || '');
      gt += s;
    });
    grand.push(gt || '');
    aoa.push(grand);

    const ws = XLSX.utils.aoa_to_sheet(aoa);

    const wscols = [
      {wch:30},{wch:18},{wch:35},{wch:18},
      ...allDatesInRange.map(() => ({wch:10})),
      {wch:10}
    ];
    ws['!cols'] = wscols;

    const totalCols2 = 4 + allDatesInRange.length + 1;
    ws['!merges'] = [{s:{r:0,c:0},e:{r:0,c:totalCols2-1}}];

    return ws;
  }

  // ‚îÄ SHEET 3: Project Summary (Project | 3DEXP | Total Hours | Submitted weeks) ‚îÄ
  function buildProjectSummarySheet() {
    const aoa = [];
    aoa.push([`Project Summary ‚Äî ${fromDate} to ${toDate}`]);
    aoa.push([]);
    aoa.push(['Project', '3DEXP (Project)', 'Tasks Count', 'Total Hours', '% of Grand Total']);

    const sortedProjects = Object.entries(projectMap).sort((a,b) => {
      const ta = Object.values(a[1].tasks).reduce((s,t) => s + Object.values(t.dates).reduce((x,h)=>x+h,0), 0);
      const tb = Object.values(b[1].tasks).reduce((s,t) => s + Object.values(t.dates).reduce((x,h)=>x+h,0), 0);
      return tb - ta;
    });

    const grandTotal = sortedProjects.reduce((s,[,p]) =>
      s + Object.values(p.tasks).reduce((ts,t) => ts + Object.values(t.dates).reduce((ds,h)=>ds+h,0),0), 0);

    sortedProjects.forEach(([projName, projData]) => {
      const taskCount = Object.keys(projData.tasks).length;
      const total = Object.values(projData.tasks).reduce((s,t) =>
        s + Object.values(t.dates).reduce((ds,h)=>ds+(parseFloat(h)||0),0), 0);
      const pct = grandTotal > 0 ? (total / grandTotal) : 0;
      aoa.push([projName, projData.exp3, taskCount, total, pct]);
    });

    aoa.push([]);
    aoa.push(['GRAND TOTAL', '', Object.values(projectMap).reduce((s,p)=>s+Object.keys(p.tasks).length,0), grandTotal, 1]);

    const ws = XLSX.utils.aoa_to_sheet(aoa);
    ws['!cols'] = [{wch:35},{wch:20},{wch:14},{wch:14},{wch:16}];

    // Format percentage column (E) ‚Äî rows 4 onward
    const pctRows = sortedProjects.length + 1; // +1 for grand total
    for (let r = 3; r < 3 + pctRows + 1; r++) {
      const cell = ws[XLSX.utils.encode_cell({r, c:4})];
      if (cell && typeof cell.v === 'number') {
        cell.z = '0.0%';
        cell.t = 'n';
      }
    }

    ws['!merges'] = [{s:{r:0,c:0},e:{r:0,c:4}}];
    return ws;
  }

  // Build all sheets
  const wsSummary = buildSummarySheet();
  const wsDaily = buildDailySheet();
  const wsProjectSummary = buildProjectSummarySheet();

  XLSX.utils.book_append_sheet(wb, wsProjectSummary, 'Project Summary');
  XLSX.utils.book_append_sheet(wb, wsSummary, 'Weekly by Task');
  XLSX.utils.book_append_sheet(wb, wsDaily, 'Daily Detail');

  // Download
  const rangeLabel = `${fromDate}_to_${toDate}`;
  XLSX.writeFile(wb, `working-hours-${rangeLabel}.xlsx`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SAMPLES FOLLOWUP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SLK = 'team_tasks_samples_v1';
let sampleLots = [], nextLotId = 1, editingLotId = null;
let slView = 'card', slSortCol = 'dateProd', slSortDir = -1;

const PHASE_COLORS = {CP:'#f59e0b',T0:'#3b82f6',T1:'#8b5cf6',T2:'#ec4899',PR:'#14b8a6',PP:'#f97316',MP:'#10b981'};
const PHASE_BG = {CP:'#fef3c7',T0:'#dbeafe',T1:'#ede9fe',T2:'#fce7f3',PR:'#ccfbf1',PP:'#ffedd5',MP:'#dcfce7'};
const PHASE_TEXT = {CP:'#92400e',T0:'#1d4ed8',T1:'#5b21b6',T2:'#9d174d',PR:'#0f766e',PP:'#c2410c',MP:'#166534'};

function slLoadData() {
  try {
    const raw = localStorage.getItem(SLK);
    if (raw) { const d = JSON.parse(raw); sampleLots = d.lots||[]; nextLotId = d.nextId||(sampleLots.length?Math.max(...sampleLots.map(l=>l.id))+1:1); }
    else { sampleLots = []; nextLotId = 1; }
  } catch { sampleLots = []; nextLotId = 1; }
}
function slSaveData() {
  localStorage.setItem(SLK, JSON.stringify({lots:sampleLots, nextId:nextLotId}));
}

function slGetStatus(lot) {
  if (!lot.teams || !lot.teams.length) return 'pending';
  const today = new Date().toISOString().slice(0,10);
  const allReceived = lot.teams.every(t => t.received && t.receiveDate);
  if (allReceived) return 'delivered';
  const someReceived = lot.teams.some(t => t.received);
  if (someReceived) return 'partial';
  if (lot.dateDelivery && lot.dateDelivery < today) return 'overdue';
  return 'pending';
}

function slStatusBadge(lot) {
  const s = slGetStatus(lot);
  const map = {
    pending: {cls:'sl-status-pending', icon:'üïê', label:'Pending'},
    partial: {cls:'sl-status-partial', icon:'üì¨', label:'Partial'},
    delivered: {cls:'sl-status-delivered', icon:'‚úÖ', label:'Delivered'},
    overdue: {cls:'sl-status-overdue', icon:'‚ö†', label:'Overdue'}
  };
  const m = map[s]||map.pending;
  return `<span class="sl-status ${m.cls}">${m.icon} ${m.label}</span>`;
}

function slGetFiltered() {
  const q = document.getElementById('sl-search').value.toLowerCase();
  const fP = document.getElementById('sl-filter-project').value;
  const fPh = document.getElementById('sl-filter-phase').value;
  const fS = document.getElementById('sl-filter-status').value;
  return sampleLots.filter(lot => {
    if (q && ![lot.lotNumber,lot.project,lot.phase,lot.purpose,lot.notes,(lot.teams||[]).map(t=>t.name).join(' ')].join(' ').toLowerCase().includes(q)) return false;
    if (fP && lot.project !== fP) return false;
    if (fPh && lot.phase !== fPh) return false;
    if (fS && slGetStatus(lot) !== fS) return false;
    return true;
  });
}
function slGetSorted(arr) {
  return [...arr].sort((a,b) => {
    let av = a[slSortCol]??'', bv = b[slSortCol]??'';
    if (slSortCol === 'id' || slSortCol === 'qty' || slSortCol === 'price') return (parseFloat(av||0) - parseFloat(bv||0)) * slSortDir;
    return String(av).localeCompare(String(bv)) * slSortDir;
  });
}
function slSortBy(col) {
  if (slSortCol === col) slSortDir *= -1; else { slSortCol = col; slSortDir = 1; }
  slRender();
}

function slRender() {
  slUpdateStats();
  slUpdateProjectFilter();
  slUpdateSortIcons();
  const filtered = slGetSorted(slGetFiltered());
  if (slView === 'card') slRenderCards(filtered);
  else slRenderTable(filtered);
}

function slUpdateStats() {
  const total = sampleLots.length;
  const delivered = sampleLots.filter(l=>slGetStatus(l)==='delivered').length;
  const overdue = sampleLots.filter(l=>slGetStatus(l)==='overdue').length;
  const pending = sampleLots.filter(l=>['pending','partial'].includes(slGetStatus(l))).length;
  const motorCost = sampleLots.filter(l=>l.costBearer==='Motor'||!l.costBearer).reduce((s,l)=>s+(parseFloat(l.price)||0),0);
  const othersCost = sampleLots.filter(l=>l.costBearer==='Others').reduce((s,l)=>s+(parseFloat(l.price)||0),0);
  const fmt = n => n>=1000 ? (n/1000).toFixed(1)+'K' : n.toFixed(0);
  document.getElementById('sl-stats').innerHTML = `
    <div class="sl-stat"><span class="sl-stat-icon">üß™</span><div><div class="sl-stat-val">${total}</div><div class="sl-stat-label">Total Lots</div></div></div>
    <div class="sl-stat"><span class="sl-stat-icon">‚úÖ</span><div><div class="sl-stat-val" style="color:#10b981">${delivered}</div><div class="sl-stat-label">Delivered</div></div></div>
    <div class="sl-stat"><span class="sl-stat-icon">üïê</span><div><div class="sl-stat-val" style="color:#f59e0b">${pending}</div><div class="sl-stat-label">In Progress</div></div></div>
    <div class="sl-stat"><span class="sl-stat-icon">‚ö†</span><div><div class="sl-stat-val" style="color:#ef4444">${overdue}</div><div class="sl-stat-label">Overdue</div></div></div>
    <div class="sl-stat"><span class="sl-stat-icon">‚öôÔ∏è</span><div><div class="sl-stat-val" style="color:#f97316">${fmt(motorCost)} EGP</div><div class="sl-stat-label">Motor Cost</div></div></div>
    <div class="sl-stat"><span class="sl-stat-icon">üì¶</span><div><div class="sl-stat-val" style="color:#8b5cf6">${fmt(othersCost)} EGP</div><div class="sl-stat-label">Others Cost</div></div></div>
  `;
}

function slUpdateProjectFilter() {
  const sel = document.getElementById('sl-filter-project');
  const cur = sel.value;
  const projs = [...new Set(sampleLots.map(l=>l.project).filter(Boolean))].sort();
  sel.innerHTML = `<option value="">All Projects</option>` + projs.map(p=>`<option value="${e(p)}">${e(p)}</option>`).join('');
  sel.value = cur;
}

function slUpdateSortIcons() {
  ['lotNumber','project','phase','qty','dateProd','dateDelivery','price'].forEach(col=>{
    const el = document.getElementById('slsort-'+col);
    if (!el) return;
    el.textContent = col===slSortCol ? (slSortDir===1?'‚Üë':'‚Üì') : '‚Üï';
    el.parentElement?.classList.toggle('sorted', col===slSortCol);
  });
}

function slRenderCards(lots) {
  const grid = document.getElementById('sl-grid');
  if (!lots.length) {
    grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:60px;color:var(--text-muted)">
      <div style="font-size:40px;margin-bottom:12px">üß™</div>
      <div style="font-size:14px">No sample lots found. Click <strong>Ôºã New Lot</strong> to create one.</div>
    </div>`;
    return;
  }
  grid.innerHTML = lots.map(lot => {
    const phase = lot.phase||'‚Äî';
    const phColor = PHASE_COLORS[phase]||'#94a3b8';
    const phBg = PHASE_BG[phase]||'#f1f5f9';
    const phText = PHASE_TEXT[phase]||'#475569';
    const teams = lot.teams||[];
    const receivedCount = teams.filter(t=>t.received).length;
    const teamChips = teams.map(t=>`<span class="sl-team-chip ${t.received?'received':''}" title="${t.received?'Received '+t.receiveDate:t.name}">${t.received?'‚úì ':''} ${e(t.name)}${t.qtyDelivered?` <strong style="font-family:'DM Mono',monospace;font-size:9px">(${t.qtyDelivered})</strong>`:''}</span>`).join('');

    return `<div class="sl-card" onclick="slOpenModal(${lot.id})">
      <div class="sl-card-header">
        <div class="sl-lot-icon" style="background:${phBg}">
          <span style="font-size:16px">üß™</span>
        </div>
        <div class="sl-card-meta">
          <div class="sl-lot-num">${e(lot.lotNumber||'‚Äî')}</div>
          <div class="sl-lot-title">${e(lot.project||'No Project')}</div>
          <div class="sl-lot-phase">
            <span style="display:inline-block;font-size:10px;font-weight:700;padding:2px 7px;border-radius:5px;background:${phBg};color:${phText};margin-top:2px">${e(phase)}</span>
          </div>
        </div>
        <div style="flex-shrink:0">${slStatusBadge(lot)}</div>
      </div>
      <div class="sl-card-body">
        <div class="sl-row"><span class="sl-label">üìÖ Prod. Date</span><span class="sl-val">${fmtDate(lot.dateProd)||'‚Äî'}</span></div>
        <div class="sl-row"><span class="sl-label">üöö Delivery</span><span class="sl-val ${(!lot.dateDelivery||slGetStatus(lot)==='overdue')?'due-overdue':''}">${fmtDate(lot.dateDelivery)||'‚Äî'}</span></div>
        <div class="sl-row"><span class="sl-label">üì¶ Qty</span><span class="sl-val">${lot.qty||'‚Äî'} pcs</span></div>
        <div class="sl-row"><span class="sl-label">üí∞ Price</span><span class="sl-val">${lot.price?Number(lot.price).toLocaleString()+' EGP':'‚Äî'}</span></div>
        <div class="sl-row"><span class="sl-label">üéØ Purpose</span><span class="sl-val">${e(lot.purpose||'‚Äî')}</span></div>
        ${lot.notes?`<div class="sl-row" style="align-items:flex-start"><span class="sl-label">üìù Notes</span><span class="sl-val" style="white-space:normal;font-size:11px;color:var(--text-muted)">${e(lot.notes)}</span></div>`:''}
      </div>
      <div class="sl-card-footer">
        <div>
          ${teams.length?`<div style="font-size:10px;color:var(--text-muted);margin-bottom:4px">Teams (${receivedCount}/${teams.length} received)</div>`:''}
          <div class="sl-teams-wrap">${teamChips||'<span style="font-size:11px;color:var(--text-light)">No teams assigned</span>'}</div>
        </div>
        <div class="sl-card-actions" onclick="event.stopPropagation()">
          <button class="btn btn-secondary btn-sm" onclick="slOpenModal(${lot.id})">‚úè</button>
          <button class="btn btn-danger btn-sm" onclick="slDeleteLot(${lot.id})">üóë</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function slRenderTable(lots) {
  const tbody = document.getElementById('sl-tbody');
  if (!lots.length) {
    tbody.innerHTML = `<tr><td colspan="11" style="text-align:center;padding:40px;color:var(--text-muted)">No lots found</td></tr>`;
    return;
  }
  tbody.innerHTML = lots.map(lot=>{
    const teams = lot.teams||[];
    const recv = teams.filter(t=>t.received).length;
    const phase = lot.phase||'';
    const phBg = PHASE_BG[phase]||'#f1f5f9';
    const phText = PHASE_TEXT[phase]||'#475569';
    return `<tr>
      <td><span style="font-family:'DM Mono',monospace;font-weight:700;font-size:12px">${e(lot.lotNumber||'‚Äî')}</span></td>
      <td>${e(lot.project||'‚Äî')}</td>
      <td><span style="background:${phBg};color:${phText};font-size:10px;font-weight:700;padding:2px 7px;border-radius:5px">${e(phase||'‚Äî')}</span></td>
      <td style="text-align:center;font-family:'DM Mono',monospace">${lot.qty||'‚Äî'}</td>
      <td>${fmtDate(lot.dateProd)||'‚Äî'}</td>
      <td class="${slGetStatus(lot)==='overdue'?'due-overdue':''}">${fmtDate(lot.dateDelivery)||'‚Äî'}</td>
      <td style="font-family:'DM Mono',monospace">${lot.price?Number(lot.price).toLocaleString()+' EGP':'‚Äî'}</td>
      <td>${e(lot.purpose||'‚Äî')}</td>
      <td style="max-width:160px">
        <div style="display:flex;flex-wrap:wrap;gap:3px">${teams.map(t=>`<span class="sl-team-chip ${t.received?'received':''}" style="font-size:9px">${t.received?'‚úì ':''} ${e(t.name)}${t.qtyDelivered?` (${t.qtyDelivered})`:''}</span>`).join('')||'‚Äî'}</div>
      </td>
      <td>${slStatusBadge(lot)}</td>
      <td>
        <div class="actions">
          <button class="btn btn-secondary btn-sm" onclick="slOpenModal(${lot.id})">‚úè</button>
          <button class="btn btn-danger btn-sm" onclick="slDeleteLot(${lot.id})">üóë</button>
        </div>
      </td>
    </tr>`;
  }).join('');
}

function slSetView(v) {
  slView = v;
  document.getElementById('sl-card-view').style.display = v==='card'?'':'none';
  document.getElementById('sl-table-view').style.display = v==='table'?'':'none';
  document.getElementById('sl-view-card').classList.toggle('active', v==='card');
  document.getElementById('sl-view-table').classList.toggle('active', v==='table');
  slRender();
}

function slClearFilters() {
  document.getElementById('sl-search').value = '';
  document.getElementById('sl-filter-project').value = '';
  document.getElementById('sl-filter-phase').value = '';
  document.getElementById('sl-filter-status').value = '';
  slRender();
}

// ‚îÄ‚îÄ Modal ‚îÄ‚îÄ
let slTempTeams = []; // temp teams while modal is open

function slOpenModal(id=null) {
  editingLotId = id;
  const lot = id ? sampleLots.find(l=>l.id===id) : null;
  document.getElementById('sl-modal-title').textContent = id ? 'Edit Sample Lot' : 'New Sample Lot';

  // Populate project dropdown
  const projSel = document.getElementById('sl-f-project');
  projSel.innerHTML = `<option value="">‚Äî Select Project ‚Äî</option>` + projects.map(p=>`<option value="${e(p.name)}">${e(p.name)}</option>`).join('');

  // Fill form
  document.getElementById('sl-f-project').value = lot?.project||'';
  document.getElementById('sl-f-phase').value = lot?.phase||'';
  document.getElementById('sl-f-lotNumber').value = lot?.lotNumber||'';
  document.getElementById('sl-f-labelPrefix').value = lot?.labelPrefix||'';
  document.getElementById('sl-f-requesting-team').value = lot?.requestingTeam||'';
  document.getElementById('sl-f-pic').value = lot?.pic||'';
  document.getElementById('sl-f-qty').value = lot?.qty||'';
  document.getElementById('sl-f-dateProd').value = lot?.dateProd||'';
  document.getElementById('sl-f-dateDelivery').value = lot?.dateDelivery||'';
  document.getElementById('sl-f-price').value = lot?.price||'';
  document.getElementById('sl-f-purpose').value = lot?.purpose||'';
  document.getElementById('sl-f-notes').value = lot?.notes||'';
  document.getElementById('sl-new-team-input').value = '';
  slSetBearer(lot?.costBearer||'Motor');

  // Clone teams to temp
  slTempTeams = (lot?.teams||[]).map(t=>({...t}));
  slRenderReceiptList();

  document.getElementById('sl-modal').classList.add('open');
  setTimeout(()=>document.getElementById('sl-f-project').focus(), 100);
}

let slTempBearer = 'Motor';
function slSetBearer(val) {
  slTempBearer = val;
  document.getElementById('sl-bearer-motor').className = 'cost-bearer-btn' + (val==='Motor'?' active-motor':'');
  document.getElementById('sl-bearer-others').className = 'cost-bearer-btn' + (val==='Others'?' active-others':'');
}

function slRenderReceiptList() {
  const list = document.getElementById('sl-receipt-list');
  if (!slTempTeams.length) {
    list.innerHTML = `<div style="padding:10px;font-size:12px;color:var(--text-light)">No teams added yet.</div>`;
    return;
  }
  list.innerHTML = slTempTeams.map((t,i)=>`
    <div class="sl-receipt-row">
      <div style="width:22px;height:22px;border-radius:50%;background:${strColor(t.name)};color:#fff;font-size:9px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0">${t.name.slice(0,2).toUpperCase()}</div>
      <div class="sl-receipt-team">${e(t.name)}</div>
      <div class="sl-receipt-date-wrap" style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
        <label style="font-size:11px;font-weight:600;color:var(--text-muted);white-space:nowrap">Qty:</label>
        <input type="number" min="0" step="1" value="${t.qtyDelivered||''}" placeholder="‚Äî"
          onchange="slSetTeamQty(${i},this.value)"
          style="font-family:inherit;font-size:12px;border:1px solid var(--border-strong);border-radius:6px;padding:4px 8px;background:var(--bg);color:var(--text);outline:none;width:70px" />
        <label style="font-size:11px;font-weight:600;color:var(--text-muted);white-space:nowrap">Received:</label>
        <input type="date" value="${t.receiveDate||''}" onchange="slSetReceiveDate(${i},this.value)"
          style="font-family:inherit;font-size:12px;border:1px solid var(--border-strong);border-radius:6px;padding:4px 8px;background:var(--bg);color:var(--text);outline:none;width:145px" />
      </div>
      <input type="checkbox" class="sl-receipt-check" ${t.received?'checked':''} title="Mark as received" onchange="slToggleReceived(${i},this.checked)" />
      <button class="btn btn-ghost btn-xs" onclick="slRemoveTeam(${i})" title="Remove team" style="padding:3px 7px;color:var(--accent)">‚úï</button>
    </div>
  `).join('');
}

function slAddTeam() {
  const inp = document.getElementById('sl-new-team-input');
  const name = inp.value.trim();
  if (!name) return;
  if (slTempTeams.find(t=>t.name.toLowerCase()===name.toLowerCase())) {
    inp.style.borderColor='var(--accent)'; setTimeout(()=>inp.style.borderColor='',1000); return;
  }
  slTempTeams.push({name, received:false, receiveDate:'', qtyDelivered:''});
  inp.value = '';
  slRenderReceiptList();
}
function slRemoveTeam(i) { slTempTeams.splice(i,1); slRenderReceiptList(); }
function slToggleReceived(i, checked) {
  slTempTeams[i].received = checked;
  if (checked && !slTempTeams[i].receiveDate) slTempTeams[i].receiveDate = new Date().toISOString().slice(0,10);
  slRenderReceiptList();
}
function slSetTeamQty(i, val) {
  slTempTeams[i].qtyDelivered = val ? parseInt(val) : '';
}
function slSetReceiveDate(i, val) {
  slTempTeams[i].receiveDate = val;
  if (val) slTempTeams[i].received = true;
  slRenderReceiptList();
}

function slSaveLot() {
  const project = document.getElementById('sl-f-project').value.trim();
  const lotNumber = document.getElementById('sl-f-lotNumber').value.trim();
  const phase = document.getElementById('sl-f-phase').value;
  if (!project) { alert('Please select a project.'); return; }
  if (!lotNumber) { alert('Please enter a lot number.'); return; }

  const isNew = !editingLotId;
  const lot = {
    id: editingLotId || nextLotId++,
    project, phase, lotNumber,
    labelPrefix: document.getElementById('sl-f-labelPrefix').value.trim(),
    requestingTeam: document.getElementById('sl-f-requesting-team').value,
    pic: document.getElementById('sl-f-pic').value.trim(),
    qty: document.getElementById('sl-f-qty').value,
    dateProd: document.getElementById('sl-f-dateProd').value,
    dateDelivery: document.getElementById('sl-f-dateDelivery').value,
    price: document.getElementById('sl-f-price').value,
    costBearer: slTempBearer || 'Motor',
    purpose: document.getElementById('sl-f-purpose').value,
    notes: document.getElementById('sl-f-notes').value.trim(),
    teams: [...slTempTeams],
    createdAt: editingLotId ? (sampleLots.find(l=>l.id===editingLotId)?.createdAt||Date.now()) : Date.now(),
    updatedAt: Date.now()
  };

  if (editingLotId) {
    const idx = sampleLots.findIndex(l=>l.id===editingLotId);
    if (idx!==-1) sampleLots[idx] = lot;
  } else {
    sampleLots.push(lot);
    // Auto-create verification items ONLY if Verification Team is selected
    if (lot.requestingTeam === 'Verification Team') {
      vfAutoCreate(lot);
    }
  }
  slSaveData();
  vfSaveData();
  closeModal('sl-modal');
  slRender();
  // Update verification tab badge
  vfUpdateTabBadge();
}

function slDeleteLot(id) {
  const lot = sampleLots.find(l=>l.id===id);
  if (!lot) return;
  if (!confirm(`Delete lot "${lot.lotNumber}"?\nThis cannot be undone.`)) return;
  sampleLots = sampleLots.filter(l=>l.id!==id);
  slSaveData();
  slRender();
}

function slCloseOverlay(ev) {
  if (ev.target === document.getElementById('sl-modal')) closeModal('sl-modal');
}

// ‚îÄ‚îÄ Export Samples to Excel ‚îÄ‚îÄ
function slExport() {
  if (!sampleLots.length) { alert('No sample lots to export.'); return; }
  if (typeof XLSX === 'undefined') { alert('Export library not loaded. Please check your connection.'); return; }

  const wb = XLSX.utils.book_new();
  const mn = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const fmt = s => { if(!s)return''; const[y,m,d]=s.split('-'); return`${parseInt(d)} ${mn[parseInt(m)-1]} ${y}`; };

  // ‚ïê‚ïê‚ïê SAMPLE LABELS SHEET (Individual samples with barcodes) ‚ïê‚ïê‚ïê
  const labelRows = [['Sample Label', 'Barcode Text', 'Production Date', 'Lot Number', 'Project', 'Phase']];
  
  sampleLots.forEach(lot => {
    const qty = parseInt(lot.qty) || 1;
    const prefix = lot.labelPrefix || `${lot.project || 'SAMPLE'}-${lot.phase || 'XX'}`;
    const prodDate = fmt(lot.dateProd) || '';
    
    // Create individual label for each sample (1 to qty)
    for (let i = 1; i <= qty; i++) {
      const sampleNum = String(i).padStart(3, '0');
      const label = `${prefix}-${sampleNum}`;
      const barcodeText = `${prefix}${sampleNum}${lot.dateProd ? lot.dateProd.replace(/-/g, '') : ''}`;
      
      labelRows.push([
        label,
        barcodeText,
        prodDate,
        lot.lotNumber || '',
        lot.project || '',
        lot.phase || ''
      ]);
    }
  });
  
  const wsLabels = XLSX.utils.aoa_to_sheet(labelRows);
  wsLabels['!cols'] = [{wch:30},{wch:25},{wch:15},{wch:14},{wch:20},{wch:8}];
  
  // Style header
  for(let c=0; c<6; c++){
    const addr=XLSX.utils.encode_cell({r:0,c});
    if(wsLabels[addr]) wsLabels[addr].s={
      font:{bold:true,color:{rgb:'FFFFFF'},sz:12},
      fill:{fgColor:{rgb:'2563EB'}},
      alignment:{horizontal:'center',vertical:'center'}
    };
  }
  wsLabels['!rows']=[{hpt:22}];
  XLSX.utils.book_append_sheet(wb, wsLabels, 'Sample Labels');

  // ‚ïê‚ïê‚ïê LOT SUMMARY SHEET ‚ïê‚ïê‚ïê
  const summaryRows = [['Lot Number','Project','Phase','Label Prefix','Requesting Team','PIC','Qty','Production Date','Delivery Date','Price (EGP)','Purpose','Notes','Status','Teams (Requested)','Teams (Received)']];
  sampleLots.forEach((lot) => {
    const teams = lot.teams||[];
    const recvTeams = teams.filter(t=>t.received).map(t=>t.name).join(', ');
    
    summaryRows.push([
      lot.lotNumber||'',
      lot.project||'',
      lot.phase||'',
      lot.labelPrefix||'',
      lot.requestingTeam||'',
      lot.pic||'',
      lot.qty?parseInt(lot.qty):'',
      fmt(lot.dateProd)||'',
      fmt(lot.dateDelivery)||'',
      lot.price?parseFloat(lot.price):'',
      lot.purpose||'',
      lot.notes||'',
      slGetStatus(lot).charAt(0).toUpperCase()+slGetStatus(lot).slice(1),
      teams.map(t=>t.name).join(', '),
      recvTeams
    ]);
  });

  const wsSummary = XLSX.utils.aoa_to_sheet(summaryRows);
  wsSummary['!cols'] = [{wch:14},{wch:20},{wch:8},{wch:20},{wch:18},{wch:16},{wch:7},{wch:15},{wch:15},{wch:14},{wch:16},{wch:30},{wch:12},{wch:25},{wch:25}];
  
  // Style header
  for(let c=0; c<summaryRows[0].length; c++){
    const addr=XLSX.utils.encode_cell({r:0,c});
    if(wsSummary[addr]) wsSummary[addr].s={
      font:{bold:true,color:{rgb:'FFFFFF'},sz:12},
      fill:{fgColor:{rgb:'059669'}},
      alignment:{horizontal:'center',vertical:'center'}
    };
  }
  wsSummary['!rows']=[{hpt:22}];
  XLSX.utils.book_append_sheet(wb, wsSummary, 'Lot Summary');

  XLSX.writeFile(wb, `sample-labels-${new Date().toISOString().slice(0,10)}.xlsx`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê UTILS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function e(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function fmtDate(s){if(!s)return'';const[y,m,d]=s.split('-');const mn=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];return`${parseInt(d)} ${mn[parseInt(m)-1]} ${y}`;}
function strColor(s){let h=0;for(let i=0;i<s.length;i++)h=s.charCodeAt(i)+((h<<5)-h);const c=['#3b82f6','#8b5cf6','#ec4899','#14b8a6','#f97316','#06b6d4','#84cc16','#ef4444'];return c[Math.abs(h)%c.length];}

function closeModal(id){
  document.getElementById(id).classList.remove('open');
  if(id==='modal-overlay')editingId=null;
  if(id==='project-modal')editingProjectId=null;
  if(id==='sl-modal')editingLotId=null;
}
function closeOverlay(e,id){if(e.target===document.getElementById(id))closeModal(id);}

document.addEventListener('keydown',ev=>{
  if(ev.key==='n'&&!ev.ctrlKey&&!ev.metaKey&&document.activeElement.tagName!=='INPUT'&&document.activeElement.tagName!=='TEXTAREA'&&document.activeElement.contentEditable!=='true')openModal();
  if(ev.key==='Escape'){['modal-overlay','addcol-modal','chart-modal','cf-modal','info-modal','project-modal','sl-modal','vf-modal'].forEach(id=>document.getElementById(id).classList.remove('open'));}
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOOLS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DC_WD_KEY = 'team_tasks_workdays';
let toolsReady = false;
function toolsInit() {
  if (!toolsReady) {
    toolsReady = true;
    dcLoadWorkdays();
    ucInitCategory();
    matRenderAll();
    rcalcBuildMaterials();
    // set today in date calc
    const today = new Date().toISOString().slice(0, 10);
    ['dc-from','dc-to','dc-start','dc-birth'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = today;
    });
    document.getElementById('dc-days').value = '10';
    dcCalcAge();
    dcUpdateSummary();
  }
}

// ‚îÄ‚îÄ Scientific Calculator ‚îÄ‚îÄ
let calcExpr = '';
let calcHistory = [];
function calcFn(v) {
  const mapIn = { '√∑': '/', '√ó': '*', '‚àí': '-', 'œÄ': 'Math.PI', 'e': 'Math.E' };
  calcExpr += mapIn[v] !== undefined ? mapIn[v] : v;
  document.getElementById('calc-expr').textContent = calcExpr;
  try {
    const prev = calcEval(calcExpr);
    if (prev !== null && isFinite(prev)) document.getElementById('calc-result').textContent = +prev.toFixed(10).toString();
  } catch {}
}
function calcClear() {
  calcExpr = '';
  document.getElementById('calc-expr').textContent = '';
  document.getElementById('calc-result').textContent = '0';
}
function calcDel() {
  calcExpr = calcExpr.slice(0, -1);
  document.getElementById('calc-expr').textContent = calcExpr;
}
function calcEval(expr) {
  let ev = expr
    .replace(/Math\.PI/g, Math.PI).replace(/Math\.E/g, Math.E)
    .replace(/sin\(/g,'Math.sin(').replace(/cos\(/g,'Math.cos(').replace(/tan\(/g,'Math.tan(')
    .replace(/asin\(/g,'Math.asin(').replace(/acos\(/g,'Math.acos(').replace(/atan\(/g,'Math.atan(')
    .replace(/log\(/g,'Math.log10(').replace(/ln\(/g,'Math.log(')
    .replace(/sqrt\(/g,'Math.sqrt(').replace(/cbrt\(/g,'Math.cbrt(')
    .replace(/abs\(/g,'Math.abs(').replace(/floor\(/g,'Math.floor(').replace(/ceil\(/g,'Math.ceil(')
    .replace(/\^/g,'**').replace(/!(\d+)?/g,(m,n)=>m);
  ev = ev.replace(/(\d+(?:\.\d+)?)\s*!/g,(_,n)=>{
    const num=parseFloat(n);
    if(!Number.isInteger(num)||num<0||num>170)return NaN;
    let f=1;for(let i=2;i<=num;i++)f*=i;return f;
  });
  return Function('"use strict"; return ('+ev+')')();
}
function calcEquals() {
  if (!calcExpr) return;
  try {
    const result = calcEval(calcExpr);
    const display = isFinite(result) ? +result.toFixed(10).toString() : 'Error';
    const histEntry = calcExpr.replace(/Math\.PI/g,'œÄ').replace(/Math\.E/g,'e')+' = '+display;
    document.getElementById('calc-expr').textContent = histEntry;
    document.getElementById('calc-result').textContent = display;
    calcHistory.unshift(histEntry);
    if (calcHistory.length > 15) calcHistory.pop();
    calcRenderHistory();
    calcExpr = display === 'Error' ? '' : display;
  } catch {
    document.getElementById('calc-result').textContent = 'Error';
    calcExpr = '';
  }
}
function calcRenderHistory() {
  const el = document.getElementById('calc-history');
  if (!calcHistory.length) { el.innerHTML='<div style="font-size:11px;color:var(--text-light);padding:4px">No history yet</div>'; return; }
  el.innerHTML = calcHistory.map((h,i)=>`<div class="calc-hist-item" onclick="calcUseHistory(${i})">${e(h)}</div>`).join('');
}
function calcUseHistory(i) {
  const parts = calcHistory[i].split(' = ');
  const val = parts[parts.length-1];
  calcExpr = val;
  document.getElementById('calc-expr').textContent = calcHistory[i];
  document.getElementById('calc-result').textContent = val;
}
function calcClearHistory() { calcHistory = []; calcRenderHistory(); }
document.addEventListener('keydown', ev => {
  const toolsActive = document.getElementById('tools-tab')?.classList.contains('active');
  if (!toolsActive) return;
  const key = ev.key;
  if (key>='0'&&key<='9') calcFn(key);
  else if (key==='.') calcFn('.');
  else if (key==='+') calcFn('+');
  else if (key==='-') calcFn('‚àí');
  else if (key==='*') calcFn('√ó');
  else if (key==='/'){ev.preventDefault();calcFn('√∑');}
  else if (key==='Enter'||key==='=') calcEquals();
  else if (key==='Backspace') calcDel();
  else if (key==='Escape'&&document.activeElement.tagName!=='INPUT') calcClear();
  else if (key==='(') calcFn('(');
  else if (key===')') calcFn(')');
  else if (key==='^') calcFn('^');
});

// ‚îÄ‚îÄ Unit Converter ‚îÄ‚îÄ
const UC_CATEGORIES = {
  length:   { units:['mm','cm','m','km','inch','foot','yard','mile','nautical mile'], toBase:{mm:0.001,cm:0.01,m:1,km:1000,inch:0.0254,foot:0.3048,yard:0.9144,mile:1609.344,'nautical mile':1852} },
  weight:   { units:['mg','g','kg','tonne','oz','lb','stone'], toBase:{mg:1e-6,g:0.001,kg:1,tonne:1000,oz:0.0283495,lb:0.453592,stone:6.35029} },
  temp:     { units:['¬∞C','¬∞F','K'], toBase:null },
  area:     { units:['mm¬≤','cm¬≤','m¬≤','km¬≤','in¬≤','ft¬≤','acre','hectare'], toBase:{'mm¬≤':1e-6,'cm¬≤':1e-4,'m¬≤':1,'km¬≤':1e6,'in¬≤':6.4516e-4,'ft¬≤':0.092903,'acre':4046.86,'hectare':10000} },
  volume:   { units:['ml','cl','dl','L','m¬≥','tsp','tbsp','fl oz','cup','pint','gallon'], toBase:{ml:1e-3,cl:1e-2,dl:1e-1,L:1,'m¬≥':1000,tsp:0.00492892,tbsp:0.0147868,'fl oz':0.0295735,cup:0.236588,pint:0.473176,gallon:3.78541} },
  speed:    { units:['m/s','km/h','mph','knot','ft/s'], toBase:{'m/s':1,'km/h':1/3.6,mph:0.44704,knot:0.514444,'ft/s':0.3048} },
  force:    { units:['N','kN','MN','lbf','kgf','dyn','ton-force'], toBase:{N:1,kN:1e3,MN:1e6,lbf:4.44822,kgf:9.80665,dyn:1e-5,'ton-force':9806.65} },
  pressure: { units:['Pa','kPa','MPa','bar','mbar','atm','psi','mmHg','inHg'], toBase:{Pa:1,kPa:1e3,MPa:1e6,bar:1e5,mbar:100,atm:101325,psi:6894.76,mmHg:133.322,inHg:3386.39} },
  energy:   { units:['J','kJ','MJ','kWh','cal','kcal','BTU','ft¬∑lbf','eV'], toBase:{J:1,kJ:1e3,MJ:1e6,kWh:3.6e6,cal:4.184,kcal:4184,BTU:1055.06,'ft¬∑lbf':1.35582,eV:1.60218e-19} }
};
let ucCurrentCat = 'length';
function ucInitCategory() { ucSetCategoryByName('length'); }
function ucSetCategory(ev, cat) {
  ucCurrentCat = cat;
  document.querySelectorAll('#uc-tabs .uc-tab').forEach(t => t.classList.remove('active'));
  if (ev && ev.target) ev.target.classList.add('active');
  const units = UC_CATEGORIES[cat].units;
  const fromSel = document.getElementById('uc-from-unit');
  const toSel = document.getElementById('uc-to-unit');
  fromSel.innerHTML = units.map((u,i)=>`<option value="${u}"${i===0?' selected':''}>${u}</option>`).join('');
  toSel.innerHTML = units.map((u,i)=>`<option value="${u}"${i===1?' selected':''}>${u}</option>`).join('');
  ucConvert();
}
function ucSetCategoryByName(cat) {
  ucCurrentCat = cat;
  const tabs = document.querySelectorAll('#uc-tabs .uc-tab');
  const catOrder = ['length','weight','temp','area','volume','speed','force','pressure','energy'];
  tabs.forEach((t,i) => t.classList.toggle('active', catOrder[i]===cat));
  const units = UC_CATEGORIES[cat].units;
  document.getElementById('uc-from-unit').innerHTML = units.map((u,i)=>`<option value="${u}"${i===0?' selected':''}>${u}</option>`).join('');
  document.getElementById('uc-to-unit').innerHTML = units.map((u,i)=>`<option value="${u}"${i===1?' selected':''}>${u}</option>`).join('');
  ucConvert();
}
function ucConvert() {
  const val = parseFloat(document.getElementById('uc-from-val').value);
  const from = document.getElementById('uc-from-unit').value;
  const to = document.getElementById('uc-to-unit').value;
  const resEl = document.getElementById('uc-result-val');
  if (isNaN(val)) { resEl.value=''; return; }
  let result;
  if (ucCurrentCat==='temp') result = ucConvertTemp(val,from,to);
  else { const fac=UC_CATEGORIES[ucCurrentCat].toBase; result=(val*fac[from])/fac[to]; }
  resEl.value = +result.toFixed(8);
}
function ucConvertTemp(val,from,to) {
  let c;
  if(from==='¬∞C')c=val; else if(from==='¬∞F')c=(val-32)*5/9; else c=val-273.15;
  if(to==='¬∞C')return c; if(to==='¬∞F')return c*9/5+32; return c+273.15;
}
function ucSwap() {
  const fromSel=document.getElementById('uc-from-unit'),toSel=document.getElementById('uc-to-unit');
  const fromVal=document.getElementById('uc-from-val'),resEl=document.getElementById('uc-result-val');
  const tmpU=fromSel.value; fromSel.value=toSel.value; toSel.value=tmpU;
  fromVal.value=resEl.value||fromVal.value; ucConvert();
}

// ‚îÄ‚îÄ Working Days ‚îÄ‚îÄ
let dcWorkdays = [1,2,3,4]; // 0=Sun...6=Sat
function dcLoadWorkdays() {
  try { const s=JSON.parse(localStorage.getItem(DC_WD_KEY)); if(Array.isArray(s))dcWorkdays=s; } catch {}
  dcWorkdays.forEach(d => {
    const cb = document.querySelector(`#dc-day-${d} input`);
    if (cb) cb.checked = true;
  });
  // uncheck non-workdays
  for(let i=0;i<7;i++){
    const cb=document.querySelector(`#dc-day-${i} input`);
    if(cb)cb.checked=dcWorkdays.includes(i);
  }
  dcUpdateSummary();
}
function dcSaveWorkdays() {
  dcWorkdays=[];
  for(let i=0;i<7;i++){
    const cb=document.querySelector(`#dc-day-${i} input`);
    if(cb&&cb.checked)dcWorkdays.push(i);
  }
  localStorage.setItem(DC_WD_KEY,JSON.stringify(dcWorkdays));
  dcUpdateSummary();
  dcCalcDiff(); dcCalcAdd();
}
function dcUpdateSummary() {
  const names=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const el=document.getElementById('dc-workdays-summary');
  if(!el)return;
  el.textContent = dcWorkdays.length
    ? `‚úÖ ${dcWorkdays.length} working day(s): ${dcWorkdays.map(d=>names[d]).join(', ')}`
    : '‚ö†Ô∏è No working days selected';
}
function dcCountWorkdays(a, b) {
  if(!dcWorkdays.length) return 0;
  let count=0, d=new Date(a<b?a:b), end=new Date(a<b?b:a);
  d.setDate(d.getDate()+1); // exclusive start
  while(d<=end){if(dcWorkdays.includes(d.getDay()))count++;d.setDate(d.getDate()+1);}
  return (a<=b?1:-1)*count;
}
function dcCalcDiff() {
  const a=document.getElementById('dc-from').value, b=document.getElementById('dc-to').value;
  const el=document.getElementById('dc-diff-result');
  if(!a||!b){el.style.display='none';return;}
  const da=new Date(a),db=new Date(b);
  const totalDiff=Math.round((db-da)/86400000);
  const wdDiff=dcCountWorkdays(da,db);
  const abs=Math.abs(totalDiff),sign=totalDiff<0?'‚àí':'+';
  const wks=Math.floor(abs/7),days=abs%7;
  el.style.display='';
  el.innerHTML=`<div>${sign}${abs} calendar days (${wks}w ${days}d)</div><div style="margin-top:4px;font-size:13px;color:var(--accent2);font-weight:700">üìÖ ${Math.abs(wdDiff)} working day${Math.abs(wdDiff)!==1?'s':''} (${dcWorkdays.length} work days/wk)</div><div style="font-size:11px;color:var(--text-muted);margin-top:2px">${totalDiff<0?'B is earlier':totalDiff===0?'Same date':'B is later'}</div>`;
}
function dcCalcAdd() {
  const start=document.getElementById('dc-start').value;
  const wdCount=parseInt(document.getElementById('dc-days').value);
  const el=document.getElementById('dc-add-result');
  if(!start||isNaN(wdCount)){el.style.display='none';return;}
  if(!dcWorkdays.length){el.style.display='';el.textContent='‚ö†Ô∏è No working days selected';return;}
  const d=new Date(start); let remaining=Math.abs(wdCount); const dir=wdCount>=0?1:-1;
  while(remaining>0){d.setDate(d.getDate()+dir);if(dcWorkdays.includes(d.getDay()))remaining--;}
  const mn=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  el.style.display='';
  el.innerHTML=`<div>Result: <strong>${d.getDate()} ${mn[d.getMonth()]} ${d.getFullYear()}</strong> (${d.toISOString().slice(0,10)})</div><div style="font-size:11px;color:var(--text-muted);margin-top:3px">${Math.abs(wdCount)} working day${Math.abs(wdCount)!==1?'s':''} ${wdCount>=0?'after':'before'} ${start}</div>`;
}
function dcCalcAge() {
  const birth=document.getElementById('dc-birth').value;
  const el=document.getElementById('dc-age-result');
  if(!birth){el.style.display='none';return;}
  const db=new Date(birth),now=new Date();
  if(db>now){el.style.display='';el.textContent='Date is in the future';return;}
  let years=now.getFullYear()-db.getFullYear(),months=now.getMonth()-db.getMonth(),days=now.getDate()-db.getDate();
  if(days<0){months--;days+=new Date(now.getFullYear(),now.getMonth(),0).getDate();}
  if(months<0){years--;months+=12;}
  const totalDays=Math.round((now-db)/86400000);
  el.style.display='';
  el.textContent=`${years}y ${months}m ${days}d  ¬∑  ${totalDays.toLocaleString()} total days`;
}

// ‚îÄ‚îÄ Percentage Calculator ‚îÄ‚îÄ
function pctCalc1(){const x=parseFloat(document.getElementById('pct1-x').value),y=parseFloat(document.getElementById('pct1-y').value),el=document.getElementById('pct1-r');if(isNaN(x)||isNaN(y)){el.style.display='none';return;}el.style.display='';el.textContent=`${x}% of ${y} = ${+(x*y/100).toFixed(8)}`;}
function pctCalc2(){const x=parseFloat(document.getElementById('pct2-x').value),y=parseFloat(document.getElementById('pct2-y').value),el=document.getElementById('pct2-r');if(isNaN(x)||isNaN(y)||y===0){el.style.display='none';return;}el.style.display='';el.textContent=`${x} is ${+(x/y*100).toFixed(4)}% of ${y}`;}
function pctCalc3(){const from=parseFloat(document.getElementById('pct3-from').value),to=parseFloat(document.getElementById('pct3-to').value),el=document.getElementById('pct3-r');if(isNaN(from)||isNaN(to)||from===0){el.style.display='none';return;}const chg=(to-from)/Math.abs(from)*100;el.style.display='';el.style.background=chg>=0?'#d1fae5':'#fee2e2';el.style.color=chg>=0?'#065f46':'#991b1b';el.textContent=`${chg>=0?'‚ñ≤ +':'‚ñº '}${+chg.toFixed(4)}% (${chg>=0?'increase':'decrease'})`;}
function pctCalc4(){const val=parseFloat(document.getElementById('pct4-val').value),pct=parseFloat(document.getElementById('pct4-pct').value),el=document.getElementById('pct4-r');if(isNaN(val)||isNaN(pct)){el.style.display='none';return;}el.style.display='';el.textContent=`+${pct}% ‚Üí ${+(val+val*pct/100).toFixed(8)}   |   ‚àí${pct}% ‚Üí ${+(val-val*pct/100).toFixed(8)}`;}

// ‚îÄ‚îÄ Engineering Materials Reference ‚îÄ‚îÄ
const MAT_ELEC = [
  {name:'Copper',sub:'Pure, annealed',rho:1.68e-8,alpha:0.00393,note:'Best conductor ‚Äî wire, coil'},
  {name:'Silver',sub:'Pure',rho:1.59e-8,alpha:0.0038,note:'Highest conductivity'},
  {name:'Gold',sub:'Pure',rho:2.44e-8,alpha:0.0034,note:'Corrosion-resistant contacts'},
  {name:'Aluminium',sub:'Pure (1100)',rho:2.82e-8,alpha:0.00429,note:'Overhead lines, heat sinks'},
  {name:'Brass (Cu70Zn30)',sub:'',rho:6.4e-8,alpha:0.0015,note:'Connectors, terminals'},
  {name:'Iron (pure)',sub:'',rho:1.0e-7,alpha:0.005,note:'Reference metal'},
  {name:'Steel (carbon)',sub:'',rho:1.43e-7,alpha:0.003,note:'Structural, magnetic core'},
  {name:'Stainless Steel 316',sub:'',rho:7.4e-7,alpha:0.00094,note:'Corrosion-resistant'},
  {name:'Tungsten',sub:'Pure',rho:5.6e-8,alpha:0.0045,note:'Filaments, high-temp'},
  {name:'Nickel',sub:'Pure',rho:6.99e-8,alpha:0.006,note:'Alloys, batteries'},
  {name:'Nichrome (Ni80Cr20)',sub:'Resistance alloy',rho:1.1e-6,alpha:0.0004,note:'Heating elements'},
  {name:'Titanium',sub:'Grade 2',rho:4.2e-7,alpha:0.0038,note:'Aerospace, implants'},
  {name:'Zinc',sub:'Pure',rho:5.9e-8,alpha:0.0037,note:'Galvanizing, alloys'},
  {name:'Carbon (graphite)',sub:'',rho:3.5e-5,alpha:-0.0005,note:'Electrodes, lubricant'},
  {name:'Silicon (intrinsic)',sub:'',rho:640,alpha:null,note:'Semiconductor'},
];
const MAT_MECH = [
  {name:'Copper (pure)',density:8940,E:117,yield:70,tensile:220,poisson:0.34},
  {name:'Aluminium 6061-T6',density:2700,E:69,yield:276,tensile:310,poisson:0.33},
  {name:'Mild Steel (1020)',density:7870,E:200,yield:210,tensile:380,poisson:0.29},
  {name:'Stainless 304',density:8000,E:193,yield:215,tensile:505,poisson:0.29},
  {name:'Stainless 316',density:7990,E:193,yield:205,tensile:515,poisson:0.29},
  {name:'Cast Iron (grey)',density:7150,E:100,yield:null,tensile:200,poisson:0.26},
  {name:'Brass (Cu70Zn30)',density:8500,E:100,yield:95,tensile:340,poisson:0.34},
  {name:'Titanium Grade 5',density:4430,E:114,yield:880,tensile:950,poisson:0.34},
  {name:'Nickel (pure)',density:8908,E:200,yield:148,tensile:462,poisson:0.31},
  {name:'Tungsten',density:19300,E:411,yield:550,tensile:980,poisson:0.28},
  {name:'Polypropylene (PP)',density:910,E:1.5,yield:30,tensile:35,poisson:0.42},
  {name:'ABS',density:1050,E:2.3,yield:40,tensile:43,poisson:0.40},
  {name:'Nylon 66',density:1140,E:2.7,yield:55,tensile:80,poisson:0.39},
];
const MAT_THERM = [
  {name:'Copper (pure)',k:401,cp:385,alpha:17.0,melt:1085},
  {name:'Silver (pure)',k:429,cp:235,alpha:18.9,melt:962},
  {name:'Gold (pure)',k:317,cp:129,alpha:14.2,melt:1064},
  {name:'Aluminium (pure)',k:237,cp:900,alpha:23.1,melt:660},
  {name:'Aluminium 6061',k:167,cp:896,alpha:23.6,melt:652},
  {name:'Mild Steel',k:50,cp:490,alpha:11.7,melt:1425},
  {name:'Stainless 304',k:16.2,cp:500,alpha:17.2,melt:1400},
  {name:'Stainless 316',k:13.4,cp:500,alpha:15.9,melt:1380},
  {name:'Cast Iron',k:52,cp:490,alpha:10.8,melt:1200},
  {name:'Brass',k:120,cp:380,alpha:18.7,melt:900},
  {name:'Titanium (pure)',k:21.9,cp:520,alpha:8.6,melt:1668},
  {name:'Nickel (pure)',k:90.7,cp:444,alpha:13.4,melt:1455},
  {name:'Tungsten',k:173,cp:132,alpha:4.5,melt:3422},
  {name:'Polypropylene',k:0.12,cp:1900,alpha:100,melt:165},
  {name:'ABS',k:0.17,cp:1400,alpha:70,melt:105},
];
function matRenderAll() {
  // Electrical
  const eTbody = document.getElementById('mat-elec-tbody');
  if (eTbody) eTbody.innerHTML = MAT_ELEC.map((m,i)=>{
    const sig = m.rho ? (1/m.rho).toExponential(3) : '‚Äî';
    return `<tr class="mat-row" style="${i%2===0?'background:var(--surface)':'background:#fafaf8'}">
      <td class="mat-td"><div class="mat-mat-name">${e(m.name)}</div>${m.sub?`<div class="mat-sub">${e(m.sub)}</div>`:''}</td>
      <td class="mat-td mat-td-num"><span style="font-family:'DM Mono',monospace;font-size:11px">${m.rho ? m.rho.toExponential(2) : '‚Äî'}</span></td>
      <td class="mat-td mat-td-num"><span style="font-family:'DM Mono',monospace;font-size:11px">${sig}</span></td>
      <td class="mat-td mat-td-num"><span style="font-family:'DM Mono',monospace;font-size:11px">${m.alpha!==null ? m.alpha : 'semi'}</span></td>
      <td class="mat-td" style="font-size:11px;color:var(--text-muted)">${e(m.note||'')}</td>
    </tr>`;
  }).join('');
  // Mechanical
  const mTbody = document.getElementById('mat-mech-tbody');
  if (mTbody) mTbody.innerHTML = MAT_MECH.map((m,i)=>`<tr class="mat-row" style="${i%2===0?'background:var(--surface)':'background:#fafaf8'}">
    <td class="mat-td"><div class="mat-mat-name">${e(m.name)}</div></td>
    <td class="mat-td mat-td-num">${m.density.toLocaleString()}</td>
    <td class="mat-td mat-td-num">${m.E}</td>
    <td class="mat-td mat-td-num">${m.yield!==null?m.yield:'‚Äî'}</td>
    <td class="mat-td mat-td-num">${m.tensile}</td>
    <td class="mat-td mat-td-num">${m.poisson}</td>
  </tr>`).join('');
  // Thermal
  const tTbody = document.getElementById('mat-therm-tbody');
  if (tTbody) tTbody.innerHTML = MAT_THERM.map((m,i)=>`<tr class="mat-row" style="${i%2===0?'background:var(--surface)':'background:#fafaf8'}">
    <td class="mat-td"><div class="mat-mat-name">${e(m.name)}</div></td>
    <td class="mat-td mat-td-num">${m.k}</td>
    <td class="mat-td mat-td-num">${m.cp}</td>
    <td class="mat-td mat-td-num">${m.alpha}</td>
    <td class="mat-td mat-td-num">${m.melt}</td>
  </tr>`).join('');
}
function matSetTab(ev, tab) {
  ['elec','mech','therm'].forEach(t => {
    document.getElementById('mat-panel-'+t).style.display = t===tab?'':'none';
  });
  document.querySelectorAll('.tool-card:last-child .uc-tab').forEach(t=>t.classList.remove('active'));
  if(ev&&ev.target)ev.target.classList.add('active');
}
function rcalcBuildMaterials() {
  const sel = document.getElementById('rcalc-mat');
  if (!sel) return;
  sel.innerHTML = MAT_ELEC.filter(m=>m.rho&&m.alpha!==null&&m.alpha!=='semi').map(m=>`<option value="${m.rho}|${m.alpha}">${m.name}</option>`).join('');
  rcalcCompute();
}
function rcalcCompute() {
  const sel = document.getElementById('rcalc-mat');
  const L = parseFloat(document.getElementById('rcalc-L').value);
  const A = parseFloat(document.getElementById('rcalc-A').value); // mm¬≤
  const T = parseFloat(document.getElementById('rcalc-T').value);
  const el = document.getElementById('rcalc-result');
  if (!sel||isNaN(L)||isNaN(A)||A<=0||isNaN(T)){el.style.display='none';return;}
  const [rho0,alpha]=sel.value.split('|').map(Number);
  const rhoT = rho0*(1+alpha*(T-20));
  const Amm2 = A*1e-6; // convert mm¬≤ to m¬≤
  const R = rhoT*L/Amm2;
  const matName = sel.options[sel.selectedIndex].text;
  el.style.display='';
  el.innerHTML=`<strong>${matName}</strong> ¬∑ L=${L}m ¬∑ A=${A}mm¬≤ ¬∑ T=${T}¬∞C<br/>
    œÅ(T) = ${rhoT.toExponential(4)} Œ©¬∑m<br/>
    <span style="font-size:16px;color:var(--accent2)">R = ${R < 1 ? R.toExponential(4) : +R.toFixed(6)} Œ©</span>
    <span style="font-size:11px;color:var(--text-muted);margin-left:8px">(${(R*1000).toFixed(4)} mŒ©)</span>`;
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê VERIFICATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const VFK = 'team_tasks_verification';
let vfItems = []; // Array of verification items
let vfNextId = 1;
let vfEditingId = null;
let vfTempBearer = 'Motor';
let vfTypeTabFilter = 'all';

const VF_TYPES = ['Safety','Performance','Motor Aging','In-Product'];
const VF_TYPE_ICONS = {Safety:'üõ°',Performance:'‚ö°','Motor Aging':'‚öôÔ∏è','In-Product':'üì¶'};
const VF_TYPE_CLASS = {Safety:'vf-type-safety',Performance:'vf-type-performance','Motor Aging':'vf-type-motoraging','In-Product':'vf-type-inproduct'};
const VF_STATUS_CLASS = {Planned:'vf-s-planned',Ongoing:'vf-s-ongoing',Done:'vf-s-done',Blocked:'vf-s-blocked',Cancelled:'vf-s-cancelled'};
const VF_STATUS_ICON = {Planned:'üïê',Ongoing:'üîÑ',Done:'‚úÖ',Blocked:'üö´',Cancelled:'‚ùå'};

function vfLoadData() {
  try {
    const raw = localStorage.getItem(VFK);
    if (raw) { const d=JSON.parse(raw); vfItems=d.items||[]; vfNextId=d.nextId||(vfItems.length?Math.max(...vfItems.map(i=>i.id))+1:1); }
    else { vfItems=[]; vfNextId=1; }
  } catch { vfItems=[]; vfNextId=1; }
}
function vfSaveData() {
  localStorage.setItem(VFK, JSON.stringify({items:vfItems,nextId:vfNextId}));
}

// Auto-create 3 verification items per type for a new lot
function vfAutoCreate(lot) {
  vfLoadData();
  VF_TYPES.forEach(type => {
    // Check if this type already exists for this lot
    const existingItem = vfItems.find(i => i.lotId === lot.id && i.type === type);
    
    // Only create if it doesn't already exist
    if (!existingItem) {
      vfItems.push({
        id: vfNextId++,
        lotId: lot.id,
        lotNumber: lot.lotNumber,
        project: lot.project,
        phase: lot.phase,
        type,
        itemNum: 1, // Only create item #1 for each type
        status: 'Planned',
        pic: lot.pic || '', // Use the PIC from the sample lot
        startDate: '',
        endDate: '',
        cost: '',
        qty: lot.qty || '', // Use the qty from the sample lot
        costBearer: lot.costBearer || 'Motor',
        reminderDate: '',
        sampleReceived: false,
        notes: '',
        createdAt: Date.now()
      });
    }
  });
  vfSaveData();
}

function vfUpdateTabBadge() {
  vfLoadData();
  const today = new Date().toISOString().slice(0,10);
  const overdue = vfItems.filter(i=>i.status!=='Done'&&i.status!=='Cancelled'&&i.endDate&&i.endDate<today).length;
  const reminders = vfItems.filter(i=>i.reminderDate&&i.reminderDate<=today&&i.status!=='Done'&&i.status!=='Cancelled').length;
  const badge = overdue+reminders;
  const tab = document.getElementById('tab-verification');
  if (!tab) return;
  tab.textContent = 'üî¨ Verification' + (badge>0 ? ` üî¥${badge}` : '');
}

function vfGetFiltered() {
  vfLoadData();
  const q = (document.getElementById('vf-search')?.value||'').toLowerCase();
  const fType = document.getElementById('vf-filter-type')?.value||'';
  const fStatus = document.getElementById('vf-filter-status')?.value||'';
  const fBearer = document.getElementById('vf-filter-bearer')?.value||'';
  const fLot = document.getElementById('vf-filter-lot')?.value||'';
  const fOverdue = document.getElementById('vf-filter-overdue')?.checked;
  const fReminder = document.getElementById('vf-filter-reminder')?.checked;
  const today = new Date().toISOString().slice(0,10);
  let items = vfItems;
  if (vfTypeTabFilter!=='all') items = items.filter(i=>i.type===vfTypeTabFilter);
  return items.filter(i=>{
    if (fType && i.type!==fType) return false;
    if (fStatus && i.status!==fStatus) return false;
    if (fBearer && i.costBearer!==fBearer) return false;
    if (fLot && String(i.lotId)!==String(fLot)) return false;
    if (fOverdue && !(i.endDate&&i.endDate<today&&i.status!=='Done'&&i.status!=='Cancelled')) return false;
    if (fReminder && !(i.reminderDate&&i.reminderDate<=today&&i.status!=='Done'&&i.status!=='Cancelled')) return false;
    if (q && ![i.lotNumber,i.project,i.type,i.pic,i.notes,i.status].join(' ').toLowerCase().includes(q)) return false;
    return true;
  });
}

function vfRender() {
  vfLoadData();
  vfUpdateStats();
  vfUpdateLotFilter();
  const items = vfGetFiltered();
  vfRenderGrid(items);
  vfUpdateTabBadge();
}

function vfUpdateStats() {
  const today = new Date().toISOString().slice(0,10);
  const all = vfItems;
  const done = all.filter(i=>i.status==='Done').length;
  const ongoing = all.filter(i=>i.status==='Ongoing').length;
  const overdue = all.filter(i=>i.endDate&&i.endDate<today&&i.status!=='Done'&&i.status!=='Cancelled').length;
  const reminders = all.filter(i=>i.reminderDate&&i.reminderDate<=today&&i.status!=='Done'&&i.status!=='Cancelled').length;
  const motorCost = all.reduce((s,i)=>(i.costBearer==='Motor'||!i.costBearer)?s+(parseFloat(i.cost)||0):s, 0);
  const othersCost = all.reduce((s,i)=>i.costBearer==='Others'?s+(parseFloat(i.cost)||0):s, 0);
  const fmt = n => n>=1000?(n/1000).toFixed(1)+'K':n.toFixed(0);
  const el = document.getElementById('vf-stats');
  if (!el) return;
  el.innerHTML = `
    <div class="vf-stat"><span style="font-size:20px">üî¨</span><div><div class="vf-stat-val">${all.length}</div><div class="vf-stat-label">Total Items</div></div></div>
    <div class="vf-stat"><span style="font-size:20px">‚úÖ</span><div><div class="vf-stat-val" style="color:#10b981">${done}</div><div class="vf-stat-label">Done</div></div></div>
    <div class="vf-stat"><span style="font-size:20px">üîÑ</span><div><div class="vf-stat-val" style="color:#3b82f6">${ongoing}</div><div class="vf-stat-label">Ongoing</div></div></div>
    <div class="vf-stat"><span style="font-size:20px">‚ö†Ô∏è</span><div><div class="vf-stat-val" style="color:#ef4444">${overdue}</div><div class="vf-stat-label">Overdue</div></div></div>
    <div class="vf-stat"><span style="font-size:20px">üîî</span><div><div class="vf-stat-val" style="color:#f59e0b">${reminders}</div><div class="vf-stat-label">Reminders Due</div></div></div>
    <div class="vf-stat"><span style="font-size:20px">‚öôÔ∏è</span><div><div class="vf-stat-val vf-bearer-motor">${fmt(motorCost)} EGP</div><div class="vf-stat-label">Motor Cost</div></div></div>
    <div class="vf-stat"><span style="font-size:20px">üì¶</span><div><div class="vf-stat-val vf-bearer-others">${fmt(othersCost)} EGP</div><div class="vf-stat-label">Others Cost</div></div></div>
  `;
}

function vfUpdateLotFilter() {
  const sel = document.getElementById('vf-filter-lot');
  if (!sel) return;
  const cur = sel.value;
  const lots = [...new Map(vfItems.map(i=>[i.lotId,{id:i.lotId,num:i.lotNumber}])).values()];
  sel.innerHTML = `<option value="">All Lots</option>`+lots.map(l=>`<option value="${l.id}">${e(l.num)}</option>`).join('');
  sel.value = cur;
}

function vfSetTypeTab(ev, type) {
  vfTypeTabFilter = type;
  document.querySelectorAll('.vf-inner-tab').forEach(t=>t.classList.remove('active'));
  if(ev&&ev.target)ev.target.classList.add('active');
  vfRender();
}
function vfClearFilters() {
  ['vf-search','vf-filter-type','vf-filter-status','vf-filter-bearer','vf-filter-lot'].forEach(id=>{
    const el=document.getElementById(id); if(el)el.value='';
  });
  ['vf-filter-overdue','vf-filter-reminder'].forEach(id=>{
    const el=document.getElementById(id); if(el)el.checked=false;
  });
  vfTypeTabFilter='all';
  document.querySelectorAll('.vf-inner-tab').forEach((t,i)=>t.classList.toggle('active',i===0));
  vfRender();
}

function vfRenderGrid(items) {
  const grid = document.getElementById('vf-grid');
  if (!grid) return;
  const today = new Date().toISOString().slice(0,10);
  if (!items.length) {
    grid.innerHTML=`<div style="grid-column:1/-1;text-align:center;padding:60px;color:var(--text-muted)"><div style="font-size:40px;margin-bottom:12px">üî¨</div><div style="font-size:14px">No verification items found. Create a sample lot to auto-generate items.</div></div>`;
    return;
  }
  grid.innerHTML = items.map(i=>{
    const isOverdue = i.endDate&&i.endDate<today&&i.status!=='Done'&&i.status!=='Cancelled';
    const isReminderDue = i.reminderDate&&i.reminderDate<=today&&i.status!=='Done'&&i.status!=='Cancelled';
    const bearerColor = i.costBearer==='Motor'?'#f97316':'#8b5cf6';
    const bearerIcon = i.costBearer==='Motor'?'‚öôÔ∏è':'üì¶';
    
    // Get dependency info
    let dependsOnHtml = '';
    if (i.dependsOn) {
      const depItem = vfItems.find(d => d.id === parseInt(i.dependsOn));
      if (depItem) {
        const depStatusIcon = VF_STATUS_ICON[depItem.status] || '';
        const depStatusClass = depItem.status === 'Done' ? 'color:#10b981' : 'color:#f59e0b';
        dependsOnHtml = `<div class="vf-row"><span class="vf-label">üîó Depends On</span><span class="vf-val"><span style="font-weight:600;${depStatusClass}">${depStatusIcon} ${depItem.type} #${depItem.itemNum}</span></span></div>`;
      }
    }
    
    return `<div class="vf-card${isOverdue?' vf-overdue':''}" onclick="vfOpenModal(${i.id})">
      <div class="vf-card-header">
        <div>
          <span class="vf-type-badge ${VF_TYPE_CLASS[i.type]||'vf-s-planned'}">${VF_TYPE_ICONS[i.type]||'üî¨'} ${i.type} #${i.itemNum}</span>
        </div>
        <div style="flex:1;margin-left:8px">
          <div style="font-weight:700;font-size:13px">${e(i.lotNumber||'‚Äî')}</div>
          <div style="font-size:11px;color:var(--text-muted)">${e(i.project||'‚Äî')} ¬∑ ${e(i.phase||'‚Äî')}</div>
        </div>
        <div style="display:flex;gap:4px;align-items:center">
          ${i.dependsOn?'<span class="vf-reminder-badge" style="background:#e0e7ff;color:#3730a3" title="Has dependency">üîó</span>':''}
          ${isReminderDue?'<span class="vf-reminder-badge" title="Reminder due">üîî</span>':''}
          ${isOverdue?'<span class="vf-reminder-badge" title="Overdue">‚ö†Ô∏è</span>':''}
          <span class="vf-status-badge ${VF_STATUS_CLASS[i.status]||'vf-s-planned'}">${VF_STATUS_ICON[i.status]||''} ${i.status}</span>
        </div>
      </div>
      <div class="vf-card-body">
        ${dependsOnHtml}
        ${i.pic?`<div class="vf-row"><span class="vf-label">üë§ PIC</span><span class="vf-val">${e(i.pic)}</span></div>`:''}
        <div class="vf-row"><span class="vf-label">üìÖ Start</span><span class="vf-val">${fmtDate(i.startDate)||'‚Äî'}</span></div>
        <div class="vf-row"><span class="vf-label">üèÅ End</span><span class="vf-val ${isOverdue?'due-overdue':''}">${fmtDate(i.endDate)||'‚Äî'}</span></div>
        ${i.cost?`<div class="vf-row"><span class="vf-label">üí∞ Cost</span><span class="vf-val">${Number(i.cost).toLocaleString()} EGP <span style="font-size:10px;color:${bearerColor};font-weight:700">${bearerIcon} ${i.costBearer}</span></span></div>`:''}
        ${i.sampleReceived?'<div class="vf-row"><span style="background:#dcfce7;color:#166534;font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px">üì• Sample Received</span></div>':''}
        ${i.reminderDate?`<div class="vf-reminder">üîî Reminder: ${fmtDate(i.reminderDate)}</div>`:''}
        ${i.notes?`<div class="vf-row" style="align-items:flex-start"><span class="vf-label">üìù Notes</span><span class="vf-val" style="white-space:normal;font-size:11px;color:var(--text-muted)">${e(i.notes)}</span></div>`:''}
      </div>
      <div class="vf-card-footer">
        <span style="font-size:10px;color:var(--text-muted)">Created ${fmtDate(new Date(i.createdAt).toISOString().slice(0,10))}</span>
        <div style="display:flex;gap:6px" onclick="event.stopPropagation()">
          <button class="btn btn-secondary btn-sm" onclick="vfOpenModal(${i.id})">‚úè Edit</button>
          <button class="btn btn-danger btn-sm" onclick="vfConfirmDelete(${i.id})">üóë</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function vfOpenModal(id) {
  vfEditingId = id;
  const item = vfItems.find(i=>i.id===id);
  if (!item) return;
  document.getElementById('vf-modal-title').textContent = `${VF_TYPE_ICONS[item.type]||'üî¨'} ${item.type} ‚Äî Item #${item.itemNum}`;
  document.getElementById('vf-f-lot-display').textContent = item.lotNumber + ' ‚Äî ' + item.project;
  document.getElementById('vf-f-type-display').textContent = item.type;
  document.getElementById('vf-f-item-display').textContent = item.itemNum;
  document.getElementById('vf-f-status').value = item.status||'Planned';
  document.getElementById('vf-f-pic').value = item.pic||'';
  document.getElementById('vf-f-start').value = item.startDate||'';
  document.getElementById('vf-f-end').value = item.endDate||'';
  document.getElementById('vf-f-cost').value = item.cost||'';
  document.getElementById('vf-f-qty').value = item.qty||'';
  document.getElementById('vf-f-reminder').value = item.reminderDate||'';
  document.getElementById('vf-f-sampleReceived').checked = !!item.sampleReceived;
  document.getElementById('vf-f-notes').value = item.notes||'';
  
  // Populate dependency dropdown with other verification items from same lot
  const dependsOnSelect = document.getElementById('vf-f-depends-on');
  const otherItems = vfItems.filter(i => i.lotId === item.lotId && i.id !== item.id);
  dependsOnSelect.innerHTML = `<option value="">‚Äî No Dependency ‚Äî</option>` + 
    otherItems.map(i => {
      const endDateInfo = i.endDate ? ` ‚Üí Ends: ${fmtDate(i.endDate)}` : ' (No end date set)';
      const statusIcon = VF_STATUS_ICON[i.status] || '';
      return `<option value="${i.id}">${VF_TYPE_ICONS[i.type]||'üî¨'} ${i.type} #${i.itemNum} ${statusIcon}${endDateInfo}</option>`;
    }).join('');
  dependsOnSelect.value = item.dependsOn || '';
  
  // Add event listener for auto-adjusting start date based on dependency
  dependsOnSelect.onchange = function() {
    vfAutoAdjustStartDate();
  };
  
  vfSetBearer(item.costBearer||'Motor');
  document.getElementById('vf-modal').classList.add('open');
}

function vfAutoAdjustStartDate() {
  const dependsOnId = document.getElementById('vf-f-depends-on').value;
  if (!dependsOnId) return; // No dependency selected
  
  const depItem = vfItems.find(i => i.id === parseInt(dependsOnId));
  if (depItem && depItem.endDate) {
    // Auto-set start date to the end date of the dependent task
    document.getElementById('vf-f-start').value = depItem.endDate;
    
    // Show a subtle notification
    const startInput = document.getElementById('vf-f-start');
    const originalBg = startInput.style.background;
    startInput.style.background = '#dcfce7';
    setTimeout(() => {
      startInput.style.background = originalBg;
    }, 1000);
  }
}
function vfSetBearer(val) {
  vfTempBearer = val;
  document.getElementById('vf-bearer-motor').className = 'cost-bearer-btn'+(val==='Motor'?' active-motor':'');
  document.getElementById('vf-bearer-others').className = 'cost-bearer-btn'+(val==='Others'?' active-others':'');
}
function vfSaveItem() {
  const item = vfItems.find(i=>i.id===vfEditingId);
  if (!item) return;
  item.status = document.getElementById('vf-f-status').value;
  item.pic = document.getElementById('vf-f-pic').value.trim();
  item.startDate = document.getElementById('vf-f-start').value;
  item.endDate = document.getElementById('vf-f-end').value;
  item.cost = document.getElementById('vf-f-cost').value;
  item.qty = document.getElementById('vf-f-qty').value;
  item.costBearer = vfTempBearer;
  item.reminderDate = document.getElementById('vf-f-reminder').value;
  item.sampleReceived = document.getElementById('vf-f-sampleReceived').checked;
  item.notes = document.getElementById('vf-f-notes').value.trim();
  item.dependsOn = document.getElementById('vf-f-depends-on').value || null;
  item.updatedAt = Date.now();
  vfSaveData();
  closeModal('vf-modal');
  vfRender();
}
function vfDeleteItem() {
  if (!confirm('Delete this verification item?')) return;
  vfConfirmDelete(vfEditingId);
  closeModal('vf-modal');
}
function vfConfirmDelete(id) {
  const item = vfItems.find(i=>i.id===id);
  if (!item) return;
  if (!confirm(`Delete "${item.type} #${item.itemNum}" for lot ${item.lotNumber}?`)) return;
  vfItems = vfItems.filter(i=>i.id!==id);
  vfSaveData();
  vfRender();
}
function vfCloseOverlay(ev) {
  if (ev.target===document.getElementById('vf-modal')) closeModal('vf-modal');
}

// Export Verification to Excel
function vfExport() {
  if (typeof XLSX==='undefined'){alert('Export library not loaded.');return;}
  const items = vfGetFiltered();
  if (!items.length){alert('No verification items to export.');return;}
  const wb = XLSX.utils.book_new();
  const headers = ['Lot Number','Project','Phase','Type','Item #','Status','PIC','Depends On','Qty','Start Date','End Date','Cost (EGP)','Cost Bearer','Reminder Date','Sample Received','Notes'];
  const rows = [headers, ...items.map(i=>{
    let dependsOnText = '';
    if (i.dependsOn) {
      const depItem = vfItems.find(d => d.id === parseInt(i.dependsOn));
      if (depItem) {
        dependsOnText = `${depItem.type} #${depItem.itemNum} (${depItem.status})`;
      }
    }
    return [
      i.lotNumber||'',i.project||'',i.phase||'',i.type||'',i.itemNum||'',
      i.status||'',i.pic||'',dependsOnText,i.qty?parseInt(i.qty):'',i.startDate||'',i.endDate||'',
      i.cost?parseFloat(i.cost):'',i.costBearer||'',i.reminderDate||'',
      i.sampleReceived?'Yes':'No',i.notes||''
    ];
  })];
  const ws = XLSX.utils.aoa_to_sheet(rows);
  const colW=[12,18,8,14,8,10,16,20,7,12,12,12,10,12,14,30];
  ws['!cols']=colW.map(w=>({wch:w}));
  // Style header
  for(let c=0;c<headers.length;c++){
    const addr=XLSX.utils.encode_cell({r:0,c});
    if(ws[addr])ws[addr].s={font:{bold:true,color:{rgb:'FFFFFF'}},fill:{fgColor:{rgb:'3B5BDB'}},alignment:{horizontal:'center'}};
  }
  ws['!rows']=[{hpt:20}];
  XLSX.utils.book_append_sheet(wb,ws,'Verification');
  // Summary by type
  const summaryRows=[['Type','Total','Done','Ongoing','Planned','Blocked','Motor Cost','Others Cost']];
  VF_TYPES.forEach(type=>{
    const t=vfItems.filter(i=>i.type===type);
    summaryRows.push([type,t.length,t.filter(i=>i.status==='Done').length,t.filter(i=>i.status==='Ongoing').length,t.filter(i=>i.status==='Planned').length,t.filter(i=>i.status==='Blocked').length,t.filter(i=>i.costBearer==='Motor').reduce((s,i)=>s+(parseFloat(i.cost)||0),0),t.filter(i=>i.costBearer==='Others').reduce((s,i)=>s+(parseFloat(i.cost)||0),0)]);
  });
  const wss=XLSX.utils.aoa_to_sheet(summaryRows);
  wss['!cols']=[{wch:16},{wch:8},{wch:8},{wch:8},{wch:8},{wch:8},{wch:14},{wch:14}];
  XLSX.utils.book_append_sheet(wb,wss,'Summary by Type');
  XLSX.writeFile(wb,`verification-${new Date().toISOString().slice(0,10)}.xlsx`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GITHUB API INTEGRATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let githubConfig = {
  username: '',
  repo: '',
  token: '',
  filepath: 'task-manager-backup.json'
};

function loadGitHubConfig() {
  const saved = localStorage.getItem('github-config');
  if (saved) {
    githubConfig = JSON.parse(saved);
  }
}

function saveGitHubSettings() {
  githubConfig.username = document.getElementById('gh-username').value.trim();
  githubConfig.repo = document.getElementById('gh-repo').value.trim();
  githubConfig.token = document.getElementById('gh-token').value.trim();
  githubConfig.filepath = document.getElementById('gh-filepath').value.trim() || 'task-manager-backup.json';
  
  if (!githubConfig.username || !githubConfig.repo || !githubConfig.token) {
    alert('‚ö†Ô∏è Please fill in all required fields (Username, Repository, and Token)');
    return;
  }
  
  localStorage.setItem('github-config', JSON.stringify(githubConfig));
  closeModal('github-settings-modal');
  alert('‚úÖ GitHub settings saved successfully!');
}

function openGitHubSettings() {
  loadGitHubConfig();
  document.getElementById('gh-username').value = githubConfig.username || '';
  document.getElementById('gh-repo').value = githubConfig.repo || '';
  document.getElementById('gh-token').value = githubConfig.token || '';
  document.getElementById('gh-filepath').value = githubConfig.filepath || 'task-manager-backup.json';
  document.getElementById('github-settings-modal').classList.add('open');
}

function clearGitHubSettings() {
  if (!confirm('Clear all GitHub settings?')) return;
  localStorage.removeItem('github-config');
  githubConfig = { username: '', repo: '', token: '', filepath: 'task-manager-backup.json' };
  document.getElementById('gh-username').value = '';
  document.getElementById('gh-repo').value = '';
  document.getElementById('gh-token').value = '';
  document.getElementById('gh-filepath').value = 'task-manager-backup.json';
  alert('‚úÖ GitHub settings cleared');
}

async function testGitHubConnection() {
  loadGitHubConfig();
  
  const username = document.getElementById('gh-username').value.trim();
  const repo = document.getElementById('gh-repo').value.trim();
  const token = document.getElementById('gh-token').value.trim();
  
  if (!username || !repo || !token) {
    alert('‚ö†Ô∏è Please fill in Username, Repository, and Token first');
    return;
  }
  
  try {
    const response = await fetch(`https://api.github.com/repos/${username}/${repo}`, {
      headers: {
        'Authorization': `token ${token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });
    
    if (response.ok) {
      const repoData = await response.json();
      alert(`‚úÖ Connection successful!\n\nRepository: ${repoData.full_name}\nVisibility: ${repoData.private ? 'Private' : 'Public'}`);
    } else if (response.status === 404) {
      alert('‚ùå Repository not found. Please check:\n- Username is correct\n- Repository name is correct\n- Repository exists');
    } else if (response.status === 401) {
      alert('‚ùå Authentication failed. Please check:\n- Token is valid\n- Token has "repo" scope permissions');
    } else {
      alert(`‚ùå Connection failed: ${response.status} ${response.statusText}`);
    }
  } catch (error) {
    alert('‚ùå Connection error: ' + error.message);
  }
}

async function syncToGitHub() {
  loadGitHubConfig();
  
  if (!githubConfig.username || !githubConfig.repo || !githubConfig.token) {
    if (confirm('GitHub not configured. Would you like to set it up now?')) {
      openGitHubSettings();
    }
    return;
  }
  
  try {
    // Collect all data
    const exportData = {
      version: '1.0',
      exportDate: new Date().toISOString(),
      tasks: tasks,
      projects: projects,
      sampleLots: sampleLots,
      vfItems: vfItems,
      whWorkdays: whWorkdays || [],
      customCols: customCols || []
    };
    
    const jsonContent = JSON.stringify(exportData, null, 2);
    const encodedContent = btoa(unescape(encodeURIComponent(jsonContent)));
    
    // Check if file exists to get SHA
    let sha = null;
    const checkResponse = await fetch(
      `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/${githubConfig.filepath}`,
      {
        headers: {
          'Authorization': `token ${githubConfig.token}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      }
    );
    
    if (checkResponse.ok) {
      const fileData = await checkResponse.json();
      sha = fileData.sha;
    }
    
    // Create or update file
    const commitMessage = `Update task manager data - ${new Date().toLocaleString()}`;
    const response = await fetch(
      `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/${githubConfig.filepath}`,
      {
        method: 'PUT',
        headers: {
          'Authorization': `token ${githubConfig.token}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: commitMessage,
          content: encodedContent,
          sha: sha
        })
      }
    );
    
    if (response.ok) {
      const result = await response.json();
      alert(`‚úÖ Data synced to GitHub successfully!\n\nCommit: ${result.commit.sha.substring(0, 7)}\nFile: ${githubConfig.filepath}`);
    } else {
      const error = await response.json();
      alert(`‚ùå Sync failed: ${error.message || response.statusText}`);
    }
  } catch (error) {
    alert('‚ùå Sync error: ' + error.message);
    console.error('GitHub sync error:', error);
  }
}

async function loadFromGitHub() {
  loadGitHubConfig();
  
  if (!githubConfig.username || !githubConfig.repo || !githubConfig.token) {
    if (confirm('GitHub not configured. Would you like to set it up now?')) {
      openGitHubSettings();
    }
    return;
  }
  
  try {
    const response = await fetch(
      `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/${githubConfig.filepath}`,
      {
        headers: {
          'Authorization': `token ${githubConfig.token}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      }
    );
    
    if (!response.ok) {
      if (response.status === 404) {
        alert('‚ùå Data file not found in GitHub.\n\nPlease sync your data first using "‚òÅÔ∏è Sync to GitHub"');
      } else {
        alert(`‚ùå Load failed: ${response.statusText}`);
      }
      return;
    }
    
    const fileData = await response.json();
    const content = decodeURIComponent(escape(atob(fileData.content)));
    const importData = JSON.parse(content);
    
    // Confirm with user
    const confirmMsg = `Load data from GitHub?\n\n` +
      `Last updated: ${importData.exportDate ? new Date(importData.exportDate).toLocaleString() : 'unknown'}\n\n` +
      `This will REPLACE all current data:\n` +
      `- ${importData.tasks?.length || 0} tasks\n` +
      `- ${importData.projects?.length || 0} projects\n` +
      `- ${importData.sampleLots?.length || 0} sample lots\n` +
      `- ${importData.vfItems?.length || 0} verification items\n\n` +
      `‚ö†Ô∏è Current data will be backed up but REPLACED.`;
    
    if (!confirm(confirmMsg)) return;
    
    // Backup current data
    const backup = {
      tasks: tasks,
      projects: projects,
      sampleLots: sampleLots,
      vfItems: vfItems,
      whWorkdays: whWorkdays || [],
      customCols: customCols || [],
      backupDate: new Date().toISOString()
    };
    localStorage.setItem('task-manager-pre-import-backup', JSON.stringify(backup));
    
    // Import data with compatibility for different formats
    if (importData.tasks) tasks = importData.tasks;
    if (importData.projects) projects = importData.projects;
    if (importData.sampleLots) sampleLots = importData.sampleLots;
    if (importData.vfItems) vfItems = importData.vfItems || [];
    if (importData.whWorkdays) whWorkdays = importData.whWorkdays;
    if (importData.workingHours) whWorkdays = importData.workingHours; // Old format compatibility
    
    // Handle custom columns - support both customColumns and customCols
    if (importData.customCols) customCols = importData.customCols;
    else if (importData.customColumns) customCols = importData.customColumns;
    else customCols = [];
    
    // Update next IDs safely
    nextId = tasks.length > 0 ? Math.max(...tasks.map(t=>t.id)) + 1 : 1;
    nextProjectId = projects.length > 0 ? Math.max(...projects.map(p=>p.id)) + 1 : 1;
    nextLotId = sampleLots.length > 0 ? Math.max(...sampleLots.map(l=>l.id)) + 1 : 1;
    vfNextId = vfItems.length > 0 ? Math.max(...vfItems.map(i=>i.id)) + 1 : 1;
    
    // Handle nextLotId from imported data
    if (importData.nextLotId && importData.nextLotId > nextLotId) {
      nextLotId = importData.nextLotId;
    }
    
    // Save to localStorage
    saveAll();
    slSaveData();
    vfSaveData();
    whSaveData();
    
    alert('‚úÖ Data loaded from GitHub successfully!\n\nYour previous data was backed up.');
    location.reload(); // Reload to ensure everything is fresh
    
  } catch (error) {
    alert('‚ùå Load error: ' + error.message);
    console.error('GitHub load error:', error);
  }
}

// Auto-sync to GitHub every 5 minutes (optional - can be disabled)
let autoSyncEnabled = false;
function enableAutoSync() {
  autoSyncEnabled = true;
  setInterval(() => {
    if (autoSyncEnabled && githubConfig.username && githubConfig.repo && githubConfig.token) {
      syncToGitHub().catch(err => console.log('Auto-sync skipped:', err));
    }
  }, 5 * 60 * 1000); // 5 minutes
}

// Manual import from JSON file (for uploaded files)
function importFromFile() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const importData = JSON.parse(event.target.result);
        
        // Confirm with user
        const confirmMsg = `Import data from ${importData.exportDate ? new Date(importData.exportDate).toLocaleString() : 'file'}?\n\n` +
          `This will REPLACE all current data:\n` +
          `- ${importData.tasks?.length || 0} tasks\n` +
          `- ${importData.projects?.length || 0} projects\n` +
          `- ${importData.sampleLots?.length || 0} sample lots\n` +
          `- ${importData.vfItems?.length || 0} verification items\n\n` +
          `‚ö†Ô∏è Current data will be backed up but REPLACED.`;
        
        if (!confirm(confirmMsg)) return;
        
        // Backup current data
        const backup = {
          tasks: tasks || [],
          projects: projects || [],
          sampleLots: sampleLots || [],
          vfItems: vfItems || [],
          whWorkdays: whWorkdays || [],
          customCols: customCols || [],
          backupDate: new Date().toISOString()
        };
        localStorage.setItem('task-manager-pre-import-backup', JSON.stringify(backup));
        
        // Import data with compatibility for different formats
        if (importData.tasks) tasks = importData.tasks;
        if (importData.projects) projects = importData.projects;
        if (importData.sampleLots) sampleLots = importData.sampleLots;
        if (importData.vfItems) vfItems = importData.vfItems || [];
        if (importData.whWorkdays) whWorkdays = importData.whWorkdays;
        if (importData.workingHours) whWorkdays = importData.workingHours; // Old format
        
        // Handle custom columns - support both formats
        if (importData.customCols) customCols = importData.customCols;
        else if (importData.customColumns) customCols = importData.customColumns;
        else customCols = [];
        
        // Update next IDs safely
        nextId = tasks.length > 0 ? Math.max(...tasks.map(t=>t.id)) + 1 : 1;
        nextProjectId = projects.length > 0 ? Math.max(...projects.map(p=>p.id)) + 1 : 1;
        nextLotId = sampleLots.length > 0 ? Math.max(...sampleLots.map(l=>l.id)) + 1 : 1;
        vfNextId = (vfItems && vfItems.length > 0) ? Math.max(...vfItems.map(i=>i.id)) + 1 : 1;
        
        // Handle nextLotId from imported data
        if (importData.nextLotId && importData.nextLotId > nextLotId) {
          nextLotId = importData.nextLotId;
        }
        
        // Save to localStorage
        saveAll();
        slSaveData();
        vfSaveData();
        if (typeof whSaveData === 'function') whSaveData();
        
        alert('‚úÖ Import successful!\n\nAll data has been imported. Your previous data was backed up.');
        location.reload();
        
      } catch (error) {
        alert('‚ùå Import failed: ' + error.message + '\n\nPlease check that the JSON file is valid.');
        console.error('Import error:', error);
      }
    };
    reader.readAsText(file);
  };
  
  input.click();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
loadGitHubConfig(); // Load GitHub config on startup
loadAll();renderWeekBadge();renderTable();updateProjectDropdown();whLoadData();slLoadData();
setTimeout(()=>{ whLoadWorkdays(); vfLoadData(); vfUpdateTabBadge(); }, 0);
</script>
